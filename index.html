@media screen and (max-width: 480px) {
            /* Enhanced mobile optimizations */
            .map-wrapper #map-container {
                height: 85vh; /* Larger height on mobile */
                min-height: 450px;
            }
            
            .find-fires-near-me {
                font-size: 14px;
                padding: 10px 15px;
            }
            
            .find-fires-near-me i {
                font-size: 16px;
            }
            
            /* Better touch targets */
            .map-wrapper .map-control-btn {
                width: 56px;
                height: 56px;
                font-size: 22px;
            }
            
            /* Fixed sidebar position to prevent overlap */
            .map-wrapper #sidebar {
                width: 85%;
                max-width: 300px;
            }
            
            /* Better mobile control placement */
            .map-wrapper .map-controls {
                bottom: 10px;
                padding: 10px 8px;
            }
            
            /* Make zoom buttons more accessible on small screens */
            .map-wrapper .map-control-btn[title="Zoom In"],
            .map-wrapper .map-control-btn[title="Zoom Out"] {
                display: flex !important;
            }
            
            /* Improve tooltip on mobile */
            #custom-tooltip {
                max-width: 200px;
                font-size: 12px;
            }
            
            /* Disable mobile pinch zoom behavior */
            .map {
                touch-action: pan-x pan-y;
            }
        }<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eye on the Fire - Live US Wildfire Map | Fires Near Me Tracker</title>
    <meta name="description" content="Track wildfires near you with Eye on the Fire's live US interactive map. Get real-time updates, safety guides, and emergency resources.">
    <meta name="keywords" content="wildfire map, fires near me, US wildfire tracker, real-time fire updates, wildfire safety">
    <meta property="og:title" content="Eye on the Fire - Live US Wildfire Map">
    <meta property="og:description" content="Track wildfires in real-time with our interactive US map. Stay informed and safe with updates and resources.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://eyeonthefire.com/">
    <meta property="og:image" content="https://eyeonthefire.com/images/hero-bg.jpg">
    <link rel="canonical" href="https://eyeonthefire.com/">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="styles.css">
    <!-- Favicon Links -->
    <link rel="shortcut icon" href="/favicon/favicon.ico" type="image/x-icon">
    <link rel="icon" type="image/png" href="/favicon/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/favicon/favicon-16x16.png" sizes="16x16">
    <link rel="apple-touch-icon" href="/favicon/apple-touch-icon.png" sizes="180x180">
    <link rel="manifest" href="/favicon/site.webmanifest">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-T8RE6KDBEW"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-T8RE6KDBEW');
    </script>
    <style>
        /* Mobile-first styles */
        :root {
            --sidebar-width-mobile: 260px;
            --sidebar-width-desktop: 300px;
            --primary-color: #ff4500;
            --secondary-color: #555;
            --light-bg: #f8f9fa;
            --fire-red: #ff3700;
            --fire-orange: #ff7e00;
            --fire-yellow: #ffbf00;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            padding: 0;
            font-family: 'Open Sans', sans-serif;
            overflow-x: hidden;
        }
        
        /* Custom tooltip for hover */
        #custom-tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.75);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 10000;
            pointer-events: none;
            display: none;
            max-width: 250px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        #custom-tooltip .tooltip-location {
            font-weight: bold;
            font-size: 13px;
            margin-bottom: 4px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            padding-bottom: 3px;
        }
        
        #custom-tooltip .tooltip-data {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 4px;
        }
        
        /* Map Styles */
        .map-wrapper {
            position: relative;
            width: 100%;
        }
        
        .map-wrapper #map-container {
            position: relative;
            width: 100%;
            overflow: hidden;
            margin-bottom: 60px; /* Space for the mobile controls */
        }
        
        .map-wrapper #map {
            height: 100%;
            width: 100%;
            touch-action: manipulation; /* Improves touch interaction */
        }
        
        /* Sidebar styles */
        .map-wrapper #sidebar {
            position: absolute;
            top: 0;
            left: 0;
            width: var(--sidebar-width-mobile);
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.2);
            overflow-y: auto;
            z-index: 1000;
            transition: transform 0.3s ease;
        }
        
        .map-wrapper #sidebar.collapsed {
            transform: translateX(calc(-1 * var(--sidebar-width-mobile)));
        }
        
        .map-wrapper #toggle-sidebar {
            position: absolute;
            left: var(--sidebar-width-mobile);
            top: 10px;
            background: white;
            padding: 10px 12px;
            border-radius: 0 4px 4px 0;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            z-index: 1000;
            transition: left 0.3s ease;
        }
        
        .map-wrapper #toggle-sidebar.collapsed {
            left: 0;
        }
        
        .map-wrapper .sidebar-content {
            padding: 15px;
            font-size: 0.9rem;
        }
        
        .map-wrapper .sidebar-header {
            padding: 15px;
            border-bottom: 1px solid #ddd;
            background-color: var(--light-bg);
        }
        
        .map-wrapper .sidebar-section {
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }
        
        .map-wrapper .sidebar-section h5 {
            margin-bottom: 10px;
            color: #333;
            font-size: 1rem;
        }
        
        /* Form elements - more touch-friendly */
        .map-wrapper .form-group {
            margin-bottom: 12px;
        }
        
        .map-wrapper label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }
        
        .map-wrapper select.form-select {
            height: 38px; /* Larger for touch */
        }
        
        .map-wrapper input[type="range"] {
            height: 30px; /* Larger for touch */
        }
        
        .map-wrapper .form-check-input {
            width: 20px;
            height: 20px;
            margin-top: 2px;
        }
        
        .map-wrapper .form-check-label {
            padding-left: 5px;
        }
        
        /* Map controls - Enhanced fire-themed for mobile */
        .map-wrapper .map-controls {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1200; /* Increased to ensure visibility */
            display: flex;
            flex-direction: row;
            justify-content: center;
            background: linear-gradient(to right, rgba(20, 20, 20, 0.9), rgba(40, 30, 20, 0.9));
            padding: 12px 5px;
            box-shadow: 0 -3px 20px rgba(255, 55, 0, 0.3);
            transform: translateY(100%);
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            opacity: 0;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
        
        .map-wrapper .map-controls.visible {
            transform: translateY(0);
            opacity: 1;
        }
        
        .map-wrapper .map-control-btn {
            border: none;
            width: 58px; /* Even larger touch target */
            height: 58px;
            border-radius: 50%; /* Circular buttons */
            margin: 0 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            color: white;
            transition: all 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            background: linear-gradient(145deg, var(--fire-red), var(--fire-orange));
            box-shadow: 0 3px 12px rgba(255, 55, 0, 0.5), 
                        0 0 20px rgba(255, 70, 0, 0.3),
                        inset 0 1px 2px rgba(255, 255, 255, 0.3);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .map-wrapper .map-control-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at center, rgba(255, 255, 255, 0.3) 0%, transparent 70%);
            border-radius: 50%;
            opacity: 0.8;
        }
        
        .map-wrapper .map-control-btn:hover,
        .map-wrapper .map-control-btn:active {
            transform: translateY(-3px) scale(1.08);
            box-shadow: 0 6px 16px rgba(255, 55, 0, 0.6), 
                        0 0 25px rgba(255, 70, 0, 0.5),
                        inset 0 1px 3px rgba(255, 255, 255, 0.4);
            background: linear-gradient(145deg, var(--fire-orange), var(--fire-red));
        }
        
        .map-wrapper .map-control-btn:active {
            transform: translateY(-1px) scale(1.05);
            transition: all 0.1s;
        }
        
        .map-wrapper .map-control-btn.active {
            background: linear-gradient(145deg, var(--fire-yellow), var(--fire-orange));
            box-shadow: 0 3px 12px rgba(255, 191, 0, 0.5), 
                        0 0 20px rgba(255, 126, 0, 0.3),
                        inset 0 -1px 3px rgba(0, 0, 0, 0.2);
        }
        
        /* Map controls tooltip labels - improved for mobile */
        .map-control-tooltip {
            position: absolute;
            bottom: 70px; /* Position above the button */
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            white-space: nowrap;
            opacity: 0;
            transition: all 0.3s ease;
            pointer-events: none;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
            border-left: 2px solid var(--fire-orange);
        }
        
        .map-wrapper .map-control-btn:hover .map-control-tooltip {
            opacity: 1;
            bottom: 75px;
        }
        
        /* Map interaction hint - improved for mobile */
        .map-interaction-hint {
            position: absolute;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(to right, rgba(0, 0, 0, 0.85), rgba(40, 30, 20, 0.85));
            color: white;
            padding: 10px 18px;
            border-radius: 30px;
            font-size: 15px;
            text-align: center;
            z-index: 950;
            opacity: 0;
            transition: all 0.3s ease;
            pointer-events: none;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.3);
            border-left: 3px solid var(--fire-orange);
            max-width: 90%;
        }
        
        .map-interaction-hint.visible {
            opacity: 1;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: translateX(-50%) scale(1); box-shadow: 0 3px 15px rgba(0, 0, 0, 0.3); }
            50% { transform: translateX(-50%) scale(1.05); box-shadow: 0 5px 25px rgba(255, 70, 0, 0.4); }
            100% { transform: translateX(-50%) scale(1); box-shadow: 0 3px 15px rgba(0, 0, 0, 0.3); }
        }
        
        /* Adjust legend position for mobile */
        .map-wrapper #legend {
            bottom: 90px; /* Move up to avoid overlap with controls */
            background: rgba(0, 0, 0, 0.75);
            color: white;
            border-radius: 10px;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border-left: 3px solid var(--fire-orange);
        }
        
        .map-wrapper .legend-item .legend-color {
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        /* Adjust for desktop */
        @media (min-width: 768px) {
            .map-wrapper .map-controls {
                position: absolute;
                left: auto;
                right: 15px;
                bottom: 20px;
                flex-direction: column;
                width: auto;
                border-radius: 15px;
                padding: 12px 8px;
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
            }
            
            .map-wrapper .map-control-btn {
                margin: 7px 0;
                width: 54px;
                height: 54px;
                font-size: 20px;
            }
            
            .map-control-tooltip {
                top: 50%;
                bottom: auto;
                left: auto;
                right: 65px;
                transform: translateY(-50%);
                border-left: none;
                border-right: 2px solid var(--fire-orange);
            }
            
            .map-wrapper .map-control-btn:hover .map-control-tooltip {
                bottom: auto;
                right: 70px;
            }
            
            .map-wrapper #legend {
                bottom: 20px; /* Reset to original position */
                right: 80px; /* Move to the right of controls */
            }
        }
        
        /* Legend - Responsive positioning */
        .map-wrapper #legend {
            position: absolute;
            bottom: 20px;
            right: 10px;
            background: white;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            z-index: 900;
            max-width: 180px;
            font-size: 11px;
        }
        
        .map-wrapper .legend-item {
            display: flex;
            align-items: center;
            margin: 4px 0;
        }
        
        .map-wrapper .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 8px;
            border: 1px solid #ddd;
        }
        
        /* Status panel - Responsive positioning */
        .map-wrapper #status-panel {
            position: absolute;
            bottom: 20px;
            left: calc(var(--sidebar-width-mobile) + 10px);
            background: white;
            padding: 10px 15px;
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            z-index: 900;
            max-width: calc(100% - var(--sidebar-width-mobile) - 30px);
            font-size: 14px;
            display: none;
            transition: left 0.3s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .map-wrapper #status-panel.sidebar-collapsed {
            left: 10px;
            max-width: calc(100% - 20px);
        }
        
        /* Loading indicators - Enhanced visibility */
        .map-wrapper .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .map-wrapper .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Quick view region buttons - Enhanced for mobile */
        .region-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .region-button {
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 14px;
            cursor: pointer;
            text-align: center;
            flex: 1 0 calc(33% - 8px);
            min-width: 60px;
            transition: all 0.2s ease;
        }
        
        .region-button.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        /* Filter tags */
        .filter-tag {
            display: inline-block;
            background-color: #f0f0f0;
            padding: 4px 8px;
            margin: 4px 4px 8px 0;
            border-radius: 16px;
            font-size: 12px;
        }
        
        .remove-filter {
            cursor: pointer;
            margin-left: 4px;
            font-weight: bold;
        }
        
        /* Loading indicators */
        .region-loading, .loading-data-message {
            position: absolute;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 4px;
            font-size: 14px;
            display: none;
            z-index: 990;
            text-align: center;
        }
        
        .region-loading-spinner, .loading-data-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
            margin-right: 8px;
            vertical-align: text-bottom;
        }
        
        /* Stats panel */
        #stats-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            width: 90%;
            max-width: 400px;
            max-height: 90%;
            overflow-y: auto;
            padding: 0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1010;
            display: none;
        }
        
        #stats-panel .stats-title {
            padding: 15px;
            border-bottom: 1px solid #eee;
            font-weight: bold;
            background-color: var(--light-bg);
        }
        
        #stats-panel #stats-content {
            padding: 15px;
        }
        
        /* Color scale */
        .color-scale {
            height: 8px;
            margin-top: 4px;
            display: flex;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .color-scale div {
            flex: 1;
            height: 100%;
        }
        
        /* View mode toggle */
        #view-mode-toggle {
            position: absolute;
            bottom: 20px;
            left: calc(var(--sidebar-width-mobile) + 10px);
            z-index: 900;
            transition: left 0.3s ease;
        }
        
        #view-mode-toggle.sidebar-collapsed {
            left: 10px;
        }
        
        /* Pagination */
        .pagination-container {
            margin-top: 15px;
            display: flex;
            justify-content: center;
        }
        
        .pagination button {
            height: 36px;
        }
        
        /* Image optimization and gallery */
        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .gallery-item {
            position: relative;
            overflow: hidden;
            border-radius: 8px;
            aspect-ratio: 16/9;
        }
        
        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        
        /* Larger screens */
        @media (min-width: 768px) {
            .map-wrapper #map-container {
                height: 75vh;
            }
            
            .map-wrapper #sidebar {
                width: var(--sidebar-width-desktop);
            }
            
            .map-wrapper #toggle-sidebar {
                left: var(--sidebar-width-desktop);
            }
            
            .map-wrapper #sidebar.collapsed {
                transform: translateX(calc(-1 * var(--sidebar-width-desktop)));
            }
            
            .map-wrapper #legend {
                max-width: 240px;
                bottom: 30px;
                font-size: 12px;
            }
            
            .map-wrapper #status-panel {
                left: calc(var(--sidebar-width-desktop) + 10px);
                max-width: calc(100% - var(--sidebar-width-desktop) - 30px);
                bottom: 30px;
            }
            
            #view-mode-toggle {
                left: calc(var(--sidebar-width-desktop) + 10px);
            }
            
            .region-button {
                flex: 1 0 calc(16.66% - 8px);
            }
            
            .gallery {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Custom tooltip container for marker hover -->
    <div id="custom-tooltip">
        <div class="tooltip-location"></div>
        <div class="tooltip-data"></div>
    </div>
    
    <header class="navbar">
        <div class="navbar-container">
            <a href="index.html" class="logo-link">
                <div class="logo-container">
                    <img src="/images/eyeonthefire-logo.png" alt="Eye on the Fire Logo" id="navbar-logo" width="40" height="40" loading="eager">
                    <span>Eye on the Fire</span>
                </div>
            </a>
            <button class="hamburger" aria-label="Toggle navigation" aria-expanded="false">
                <span class="line line1"></span>
                <span class="line line2"></span>
                <span class="line line3"></span>
            </button>
            <nav class="nav-menu" id="main-nav">
                <ul class="main-menu">
                    <li><a href="index.html" class="active">Home</a></li>
                    <li><a href="about.html">About</a></li>
                    <li><a href="prepare.html">Prepare</a></li>
                    <li><a href="prevent.html">Prevent</a></li>
                    <li><a href="safety-info.html">Safety Info</a></li>
                    <li><a href="news-resources.html">News & Resources</a></li>
                    <li><a href="contact.html">Contact</a></li>
                </ul>
            </nav>
        </div>
    </header>
    <section class="hero" id="home">
        <div class="hero-content">
            <h1>Monitor US Wildfires in Real-Time</h1>
            <p>Track active fires across the United States with our live interactive map. Get critical updates, safety alerts, and preparedness resources.</p>
            <a href="#map-section" class="cta-button">View Live US Fire Map</a>
        </div>
    </section>
    <section id="intro" class="content-section">
        <div class="container">
            <p class="section-intro">Welcome to Eye on the Fire, your central hub for tracking active <strong>wildfires near me</strong> across the United States. Our advanced <strong>interactive fire map</strong> provides <strong>real-time fire monitoring</strong>, helping you stay aware of developing situations and make informed decisions for your safety during the challenging <strong>US fire season</strong>. Explore the map below and utilize our resources for effective <strong>wildfire safety</strong> and <strong>emergency preparedness</strong>.</p>
        </div>
    </section>
    <hr class="section-divider">
    <section id="map-section" class="content-section">
        <div class="container">
            <h2 class="section-title">Interactive Live US Wildfire Tracker</h2>
            <p class="section-intro">Monitor the latest wildfire activity nationwide. Use the map controls to find <strong>fires near you</strong> anywhere in the US, zoom into specific regions, and explore data layers for a comprehensive view of <strong>current wildfires</strong> and activity.</p>
        </div>
        <main>
            <div class="map-wrapper">
                <div id="map-container">
                    <div id="map"></div>
                    
                    <!-- Prominent "Find Fires Near Me" button -->
                    <button class="find-fires-near-me" id="find-fires-near-me">
                        <i class="fas fa-location-arrow"></i> Find Fires Near Me
                    </button>
                    
                    <!-- Fullscreen Map Toggle -->
                    <button class="fullscreen-toggle" id="fullscreen-toggle">
                        <i class="fas fa-expand"></i>
                    </button>
                    <!-- Sidebar -->
                    <div id="sidebar">
                        <div class="sidebar-header">
                            <h4><i class="fas fa-fire-flame-curved"></i> USA Fire Map</h4>
                            <p class="text-muted mb-0" style="font-size: 12px;">NASA FIRMS Real-Time Fire Data</p>
                        </div>
                        <div class="sidebar-content">
                            <div id="active-filters"></div>
                            <div class="sidebar-section">
                                <h5>Quick View</h5>
                                <div class="region-buttons">
                                    <div id="usa-button" class="region-button active" data-bounds="-125,24,-66,49">USA</div>
                                    <div id="west-button" class="region-button" data-bounds="-125,31,-107,49">West</div>
                                    <div id="central-button" class="region-button" data-bounds="-107,31,-90,49">Central</div>
                                    <div id="east-button" class="region-button" data-bounds="-90,24,-66,49">East</div>
                                    <div id="alaska-button" class="region-button" data-bounds="-170,51,-130,71">Alaska</div>
                                    <div id="hawaii-button" class="region-button" data-bounds="-160,18,-154,23">Hawaii</div>
                                </div>
                            </div>
                            <div class="sidebar-section">
                                <h5>Data Source</h5>
                                <div class="form-group">
                                    <select id="data-source" class="form-select">
                                        <option value="MODIS_NRT">MODIS (Near Real-Time)</option>
                                        <option value="VIIRS_NOAA20_NRT">VIIRS NOAA-20 (Near Real-Time)</option>
                                        <option value="VIIRS_SNPP_NRT">VIIRS Suomi NPP (Near Real-Time)</option>
                                        <option value="VIIRS_NOAA21_NRT">VIIRS NOAA-21 (Near Real-Time)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="sidebar-section">
                                <h5>Time Range</h5>
                                <div class="form-group">
                                    <select id="days-range" class="form-select">
                                        <option value="1">Last 24 hours</option>
                                        <option value="2">Last 2 days</option>
                                        <option value="3">Last 3 days</option>
                                        <option value="7">Last 7 days</option>
                                        <option value="10">Last 10 days</option>
                                    </select>
                                </div>
                            </div>
                            <div class="sidebar-section">
                                <h5>Fire Filters</h5>
                                <div class="form-group">
                                    <label for="confidence-range">Confidence Level: <span id="confidence-min">0%</span></label>
                                    <input type="range" class="form-range" id="confidence-range" min="0" max="100" value="0">
                                </div>
                                <div class="form-group">
                                    <label for="frp-range">Fire Power (MW): <span id="frp-min">0</span></label>
                                    <input type="range" class="form-range" id="frp-range" min="0" max="100" value="0">
                                </div>
                            </div>
                            <div class="sidebar-section">
                                <h5>Display Options</h5>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="enable-clustering" checked>
                                    <label class="form-check-label" for="enable-clustering">Enable Clustering</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="show-heatmap">
                                    <label class="form-check-label" for="show-heatmap">Show Heatmap</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="lazy-loading" checked>
                                    <label class="form-check-label" for="lazy-loading">Lazy Load Data (Recommended)</label>
                                    <small class="form-text text-muted d-block">Only loads data for visible map area</small>
                                </div>
                                <div class="form-group mt-2">
                                    <label for="markers-per-page">Max Visible Markers</label>
                                    <select id="markers-per-page" class="form-select">
                                        <option value="500">500 (Fast)</option>
                                        <option value="1000" selected>1,000 (Balanced)</option>
                                        <option value="3000">3,000 (Detailed)</option>
                                        <option value="10000">10,000 (Full)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="sidebar-section">
                                <button id="apply-filters" class="btn btn-primary w-100">
                                    <i class="fas fa-filter"></i> Apply Filters
                                </button>
                                <button id="reset-filters" class="btn btn-outline-secondary w-100 mt-2">
                                    <i class="fas fa-sync"></i> Reset Filters
                                </button>
                            </div>
                            <div class="pagination-container">
                                <div class="btn-group pagination">
                                    <button id="prev-page" class="btn btn-outline-secondary">
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                    <span id="page-info" class="btn btn-outline-secondary disabled">
                                        <span id="current-page">1</span>/<span id="total-pages">1</span>
                                    </span>
                                    <button id="next-page" class="btn btn-outline-secondary">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="toggle-sidebar">
                        <i class="fas fa-chevron-left"></i>
                    </div>
                    <!-- Map controls -->
                    <div class="map-controls">
                        <button class="map-control-btn" id="zoom-in" title="Zoom In">
                            <i class="fas fa-plus"></i>
                            <span class="map-control-tooltip">Zoom In</span>
                        </button>
                        <button class="map-control-btn" id="zoom-out" title="Zoom Out">
                            <i class="fas fa-minus"></i>
                            <span class="map-control-tooltip">Zoom Out</span>
                        </button>
                        <button class="map-control-btn" id="recenter" title="Find Fires Near Me">
                            <i class="fas fa-location-crosshairs"></i>
                            <span class="map-control-tooltip">Find Fires Near Me</span>
                        </button>
                        <button class="map-control-btn" id="show-stats" title="Fire Statistics">
                            <i class="fas fa-chart-simple"></i>
                            <span class="map-control-tooltip">Fire Statistics</span>
                        </button>
                    </div>
                    
                    <!-- Map interaction hint -->
                    <div class="map-interaction-hint">
                        <i class="fas fa-hand-pointer"></i> Touch map to show controls
                    </div>
                    <!-- Legend -->
                    <div id="legend">
                        <h6 style="font-size: 12px; margin-top: 0;">Fire Confidence</h6>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #FF0000;"></div>
                            <span>High (80-100%)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #FF4500;"></div>
                            <span>Medium (60-79%)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #FFA500;"></div>
                            <span>Low (30-59%)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #FFCC00;"></div>
                            <span>Very Low (0-29%)</span>
                        </div>
                        <div style="margin-top: 6px; font-size: 10px;">
                            <strong>Circle Size:</strong> Fire Power (MW)
                        </div>
                        <div class="color-scale">
                            <div style="background-color: #FFCC00;"></div>
                            <div style="background-color: #FFA500;"></div>
                            <div style="background-color: #FF4500;"></div>
                            <div style="background-color: #FF0000;"></div>
                        </div>
                    </div>
                    <!-- Status Panel -->
                    <div id="status-panel"></div>
                    <!-- View Mode Toggle -->
                    <div id="view-mode-toggle">
                        <button id="global-mode" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-globe"></i> Global View
                        </button>
                        <button id="usa-mode" class="btn btn-sm btn-primary">
                            <i class="fas fa-flag-usa"></i> USA Only
                        </button>
                    </div>
                    <!-- Region Loading Indicator -->
                    <div id="region-loading" class="region-loading">
                        <span class="region-loading-spinner"></span>
                        Loading fire data for this region...
                    </div>
                    <!-- Loading Data Message -->
                    <div id="loading-data-message" class="loading-data-message">
                        <span class="loading-data-spinner"></span>
                        Loading USA fire data...
                    </div>
                    <!-- Stats Panel -->
                    <div id="stats-panel">
                        <div class="stats-title">
                            <i class="fas fa-chart-simple"></i> Fire Statistics
                            <button type="button" class="btn-close float-end" id="close-stats" aria-label="Close"></button>
                        </div>
                        <div id="stats-content"></div>
                    </div>
                    <!-- Loading Overlay -->
                    <div class="loading-overlay" id="loading-overlay">
                        <div class="spinner"></div>
                        <p id="loading-message">Initializing map...</p>
                    </div>
                </div>
            </div>
        </main>
        <div class="container data-source-note">
            <small>Map data sourced from NASA FIRMS, NIFC, and other official US channels. Updates occur periodically. Always follow guidance from local emergency management officials.</small>
        </div>
    </section>
    <hr class="section-divider">
    <section id="about" class="content-section">
        <div class="container">
            <h2 class="section-title">Stay Informed, Stay Safe Nationwide</h2>
            <p class="section-intro">As wildfire risks impact communities across the <strong>United States</strong>, access to reliable, timely information is paramount. Eye on the Fire provides an essential service through our premier <strong>interactive fire map</strong>, consolidating data for clear, actionable insights nationwide. Our platform aids residents from coast to coast in assessing potential threats with <strong>real-time fire monitoring</strong>. Understanding current fire behavior is key to effective <strong>emergency preparedness</strong> and comprehensive <strong>fire safety</strong>. Trust Eye on the Fire for situational awareness.</p>
        </div>
    </section>
    <hr class="section-divider">
    <section id="prevention" class="content-section">
        <div class="container">
            <h2 class="section-title">Wildfire Prevention & Home Safety Guides</h2>
            <p class="section-intro">Protecting your property starts long before a wildfire approaches. Implementing <strong>fire prevention</strong> strategies like <strong>home hardening</strong> and creating <strong>defensible space</strong> are the most effective ways to increase your home's chance of survival, regardless of your location in the US. Explore these fundamental guides to build your <strong>wildfire action plan</strong>.</p>
            <div class="prevention-grid">
                <div class="prevention-item">
                    <i class="fas fa-home" aria-hidden="true"></i>
                    <h3>Defensible Space Zones</h3>
                    <p>Learn how to create and maintain recommended buffer zones around your home to reduce flammable vegetation and help stop fire spread. Essential nationwide guidance.</p>
                </div>
                <div class="prevention-item">
                    <i class="fas fa-tools" aria-hidden="true"></i>
                    <h3>Home Hardening Techniques</h3>
                    <p>Discover methods to make your home more resistant to embers and flames, focusing on roofs, vents, windows, siding, and decks applicable across the US.</p>
                </div>
                <div class="prevention-item">
                    <i class="fas fa-seedling" aria-hidden="true"></i>
                    <h3>Fire-Smart Landscaping</h3>
                    <p>Choose appropriate vegetation and spacing for plants near your home. Utilize fire-resistant native plants and maintain adequate irrigation for your climate zone.</p>
                </div>
            </div>
        </div>
    </section>
    <hr class="section-divider">
    <section id="community" class="content-section">
        <div class="container">
            <h2 class="section-title">National & Local Resources</h2>
            <p class="section-intro">Access official resources for emergency alerts, evacuation status, and support during wildfire events across the United States.</p>
            <div class="cta-banner">
                <p>Find National Interagency Fire Center (NIFC) Updates: <a href="https://www.nifc.gov/" target="_blank" rel="noopener noreferrer">Visit NIFC.gov</a></p>
            </div>
            <div class="gallery" role="list" aria-label="Community and wildfire images">
                <div class="gallery-item" role="listitem">
                    <img src="/images/us-wildfire-community-response.jpg" alt="Diverse group of community members clearing brush together for wildfire prevention in a US neighborhood" width="400" height="225" loading="lazy">
                </div>
                <div class="gallery-item" role="listitem">
                    <img src="/images/us-firefighters-working.jpg" alt="US firefighters monitoring a controlled burn or wildfire line in a forested area" width="400" height="225" loading="lazy">
                </div>
                <div class="gallery-item" role="listitem">
                    <img src="/images/us-wildfire-landscape-recovery.jpg" alt="Wide landscape view showing ecological recovery with green shoots emerging after a US wildfire" width="400" height="225" loading="lazy">
                </div>
            </div>
        </div>
    </section>
    <footer class="site-footer">
        <div class="footer-content">
            <div class="footer-section about">
                <h3 class="logo-text-footer">Eye on the Fire</h3>
                <p>Providing critical real-time wildfire monitoring and fire safety resources for the United States. Our interactive map helps you stay informed and prepared.</p>
            </div>
            <div class="footer-section links">
                <h3>Quick Links</h3>
                <ul>
                    <li><a href="about.html">About</a></li>
                    <li><a href="prepare.html">Prepare</a></li>
                    <li><a href="prevent.html">Prevent</a></li>
                    <li><a href="safety-info.html">Safety Info</a></li>
                    <li><a href="news-resources.html">News & Resources</a></li>
                    <li><a href="contact.html">Contact</a></li>
                </ul>
            </div>
            <div class="footer-section social">
                <h3>Follow Us</h3>
                <div class="social-icons">
                    <a href="#" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
                    <a href="#" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
                    <a href="#" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                    <a href="#" aria-label="RSS Feed"><i class="fas fa-rss"></i></a>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            Â© <span id="year"></span> Eye on the Fire | All Rights Reserved | Data provided "as is" without warranty |
            <a href="#">Terms of Use</a> |
            <a href="#">Privacy Policy</a>
        </div>
    </footer>
    <script src="https://unpkg.com/@googlemaps/markerclusterer@2.0.15/dist/index.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        class FireMap {
            // Update constructor to include Geocoder
            constructor() {
                this.config = {
                    apiEndpoint: 'https://eyeonthefire.com/api/nasa/firms', // Maintain existing server-side API endpoint
                    geocodingEndpoint: 'https://eyeonthefire.com/api/geocode', // Server-side geocoding endpoint
                    defaultCenter: { lat: 39.5, lng: -98.35 },
                    defaultZoom: 4,
                    usBounds: { west: -125, south: 24, east: -66, north: 49 },
                    maxFetchRetries: 3,
                    mobileBreakpoint: 768,
                    // Use the NASA_FIRMS_MAP_KEY from Cloudflare worker
                    apiKey: 'NASA_FIRMS_MAP_KEY' // This is handled by your Cloudflare worker
                };
                this.state = {
                    map: null,
                    viewport: { north: 0, south: 0, east: 0, west: 0 },
                    mapBounds: null,
                    markers: [],
                    markerClusterer: null,
                    heatmap: null,
                    totalFirePoints: 0,
                    filteredData: [],
                    allFireData: [],
                    currentPage: 1,
                    markersPerPage: 1000,
                    activeFilters: {},
                    infoWindow: null,
                    regionDataCache: new Map(),
                    viewMode: 'usa',
                    lazyLoading: true,
                    loadingRegions: new Set(),
                    isMobile: window.innerWidth < 768,
                    mapLoaded: false
                };
                
                // Initialize location cache
                this.locationCache = new Map();
                
                this.initialize();
            }
            async initialize() {
                console.log('Initializing FireMap application');
                this.checkMobile();
                this.setupEventListeners();
                try {
                    await this.waitForGoogleMaps();
                    this.initializeMap();
                    this.showLoadingMessage('Loading USA fire data...');
                    await this.loadUSAFireData();
                    this.hideLoadingMessage();
                    this.state.mapLoaded = true;
                } catch (error) {
                    console.error('Error initializing application:', error);
                    this.showStatus('Error initializing application: ' + error.message, 'error');
                    this.hideLoadingMessage();
                }
            }
            checkMobile() {
                this.state.isMobile = window.innerWidth < this.config.mobileBreakpoint;
                if (this.state.isMobile) {
                    setTimeout(() => {
                        $('#sidebar').addClass('collapsed');
                        $('#toggle-sidebar').addClass('collapsed');
                        $('#toggle-sidebar i').removeClass('fa-chevron-left').addClass('fa-chevron-right');
                        $('#status-panel').addClass('sidebar-collapsed');
                        $('#view-mode-toggle').addClass('sidebar-collapsed');
                    }, 500);
                }
            }
            waitForGoogleMaps() {
                return new Promise((resolve) => {
                    // Only resolve once ALL required APIs are loaded
                    const checkMapsReady = () => {
                        return typeof google !== 'undefined' && 
                               typeof google.maps !== 'undefined' && 
                               typeof google.maps.Geocoder !== 'undefined';
                    };
                    
                    if (checkMapsReady()) {
                        console.log('Google Maps and Geocoder already loaded');
                        resolve();
                        return;
                    }
                    
                    console.log('Waiting for Google Maps to load');
                    
                    // Set callback to be executed when Google Maps loads
                    this.onGoogleMapsLoaded = () => {
                        if (checkMapsReady()) {
                            console.log('Google Maps loaded via callback with all APIs');
                            resolve();
                        } else {
                            console.log('Google Maps loaded but not all required APIs yet');
                            // Still need to wait for other APIs
                            const apiCheckInterval = setInterval(() => {
                                if (checkMapsReady()) {
                                    clearInterval(apiCheckInterval);
                                    console.log('All Google Maps APIs now loaded');
                                    resolve();
                                }
                            }, 100);
                        }
                    };
                    
                    // Set a safety timeout
                    const timeout = setTimeout(() => {
                        console.warn('Google Maps load timeout - proceeding anyway');
                        resolve();
                    }, 15000); // Extended timeout for slower connections
                    
                    // Check periodically
                    const checkInterval = setInterval(() => {
                        if (checkMapsReady()) {
                            clearInterval(checkInterval);
                            clearTimeout(timeout);
                            console.log('Google Maps loaded successfully with all APIs');
                            resolve();
                        }
                    }, 100);
                });
            }
            // Initialize map with better options for a better UX
            initializeMap() {
                this.showStatus('Initializing map...');
                try {
                    console.log('Creating Google Map instance');
                    this.state.map = new google.maps.Map(document.getElementById('map'), {
                        center: this.config.defaultCenter,
                        zoom: this.config.defaultZoom,
                        mapTypeId: 'hybrid', // Hybrid view: satellite with road/label overlay for better visibility
                        mapTypeControl: true,
                        mapTypeControlOptions: {
                            style: google.maps.MapTypeControlStyle.DROPDOWN_MENU,
                            position: google.maps.ControlPosition.TOP_LEFT
                        },
                        fullscreenControl: false, // We'll implement our own fullscreen
                        streetViewControl: false,
                        zoomControlOptions: {
                            position: google.maps.ControlPosition.RIGHT_BOTTOM
                        },
                        gestureHandling: 'greedy', // Makes map more usable on mobile
                        restriction: {
                            latLngBounds: { north: 85, south: -85, west: -180, east: 180 }
                        },
                        // Enhanced map styles for better fire visualization
                        styles: [
                            {
                                "featureType": "water",
                                "elementType": "geometry",
                                "stylers": [{"color": "#e9e9e9"}, {"lightness": 17}]
                            },
                            {
                                "featureType": "landscape",
                                "elementType": "geometry",
                                "stylers": [{"color": "#f5f5f5"}, {"lightness": 20}]
                            },
                            {
                                "featureType": "administrative.country",
                                "elementType": "geometry.stroke",
                                "stylers": [{"color": "#a9b1b9"}, {"weight": 1.2}]
                            },
                            {
                                "featureType": "administrative.province",
                                "elementType": "geometry.stroke",
                                "stylers": [{"color": "#a9b1b9"}, {"weight": 1}]
                            },
                            {
                                "featureType": "road",
                                "elementType": "geometry",
                                "stylers": [{"visibility": "simplified"}]
                            },
                            {
                                "featureType": "poi",
                                "stylers": [{"visibility": "off"}]
                            },
                            {
                                "featureType": "transit",
                                "stylers": [{"visibility": "off"}]
                            }
                        ]
                    });
                    this.state.infoWindow = new google.maps.InfoWindow();
                    
                    // Apply adaptive map settings based on device
                    this.applyAdaptiveMapSettings();
                    
                    // Add map idle event for lazy loading and viewport tracking
                    google.maps.event.addListener(this.state.map, 'idle', () => {
                        const bounds = this.state.map.getBounds();
                        if (bounds) {
                            const ne = bounds.getNorthEast();
                            const sw = bounds.getSouthWest();
                            this.state.viewport = {
                                north: ne.lat(),
                                east: ne.lng(),
                                south: sw.lat(),
                                west: sw.lng()
                            };
                            if (this.state.lazyLoading && this.state.mapLoaded) {
                                this.loadDataForViewport();
                            }
                        }
                    });
                    
                    // Better user experience on mobile - enable location button if available
                    if (navigator.geolocation) {
                        this.showStatus('Location services available. Use "Find Fires Near Me" to locate fires in your area.', 'info');
                    }
                    
                    // Initial map view focus on the user's country if possible
                    this.tryToFocusOnUserLocation();
                    
                    this.hideLoading();
                    this.showStatus('Map initialized successfully', 'success');
                    console.log('Map initialized successfully');
                    return true;
                } catch (error) {
                    console.error('Error initializing map:', error);
                    this.showStatus('Error initializing map: ' + error.message, 'error');
                    return false;
                }
            }
            
            // Apply different map settings based on device
            applyAdaptiveMapSettings() {
                if (this.state.isMobile) {
                    // Mobile optimizations
                    this.state.map.setOptions({
                        zoomControl: false, // Hide default zoom, we'll use our custom controls
                        mapTypeControlOptions: {
                            style: google.maps.MapTypeControlStyle.DROPDOWN_MENU,
                            position: google.maps.ControlPosition.TOP_LEFT
                        }
                    });
                } else {
                    // Desktop optimizations
                    this.state.map.setOptions({
                        zoomControl: true,
                        mapTypeControlOptions: {
                            style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
                            position: google.maps.ControlPosition.TOP_RIGHT
                        }
                    });
                }
            }
            
            // Try to focus the initial map view on user's approximate location
            tryToFocusOnUserLocation() {
                // First, check if we can use browser geolocation
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            // Success - we have user's position
                            const userLat = position.coords.latitude;
                            const userLng = position.coords.longitude;
                            
                            // Center on user's location with closer zoom
                            this.state.map.setCenter({ lat: userLat, lng: userLng });
                            this.state.map.setZoom(8); // Closer zoom level
                            
                            // Add a location marker
                            if (this.userLocationMarker) {
                                this.userLocationMarker.setMap(null);
                            }
                            
                            this.userLocationMarker = new google.maps.Marker({
                                position: { lat: userLat, lng: userLng },
                                map: this.state.map,
                                icon: {
                                    path: google.maps.SymbolPath.CIRCLE,
                                    fillColor: '#4285F4',
                                    fillOpacity: 1,
                                    strokeColor: 'white',
                                    strokeWeight: 2,
                                    scale: 8
                                },
                                title: 'Your Location',
                                zIndex: 10000
                            });
                            
                            // Load nearby fire data immediately
                            this.loadDataForViewport();
                        },
                        (error) => {
                            // Failed to get location - fall back to IP-based geolocation or USA default
                            console.warn('Geolocation error:', error);
                            this.focusOnUSA(); // Default to USA view
                        },
                        {
                            timeout: 5000, // Don't wait too long
                            maximumAge: 60000 // Use cached position if available
                        }
                    );
                } else {
                    // Geolocation not available
                    this.focusOnUSA(); // Default to USA view
                }
            }
            setupEventListeners() {
                console.log('Setting up event listeners');
                
                // Map interaction controls
                let mapInteractionTimeout;
                let controlsVisible = false;
                const mapControls = document.querySelector('.map-controls');
                const mapInteractionHint = document.querySelector('.map-interaction-hint');
                
                // Show interaction hint after initial load
                setTimeout(() => {
                    mapInteractionHint.classList.add('visible');
                    setTimeout(() => {
                        mapInteractionHint.classList.remove('visible');
                    }, 5000);
                }, 3000);
                
                // Add map interaction listeners
                document.getElementById('map').addEventListener('touchstart', showControls);
                document.getElementById('map').addEventListener('mousemove', showControls);
                document.getElementById('map').addEventListener('click', showControls);
                
                function showControls() {
                    // Hide the hint when user interacts
                    mapInteractionHint.classList.remove('visible');
                    
                    // Show controls
                    if (!controlsVisible) {
                        mapControls.classList.add('visible');
                        controlsVisible = true;
                    }
                    
                    // Reset timer
                    clearTimeout(mapInteractionTimeout);
                    
                    // Hide controls after 5 seconds of no interaction
                    mapInteractionTimeout = setTimeout(() => {
                        mapControls.classList.remove('visible');
                        controlsVisible = false;
                    }, 5000);
                }
                
                // Find Fires Near Me button
                $('#find-fires-near-me').on('click', () => {
                    this.getUserLocation();
                });
                
                // Fullscreen toggle
                $('#fullscreen-toggle').on('click', () => {
                    $('.map-wrapper').toggleClass('fullscreen');
                    const isFullscreen = $('.map-wrapper').hasClass('fullscreen');
                    $('#fullscreen-toggle i').toggleClass('fa-expand', !isFullscreen).toggleClass('fa-compress', isFullscreen);
                });
                
                // Standard controls
                $('#toggle-sidebar').on('click', () => {
                    $('#sidebar').toggleClass('collapsed');
                    $('#toggle-sidebar').toggleClass('collapsed');
                    $('#status-panel').toggleClass('sidebar-collapsed');
                    $('#view-mode-toggle').toggleClass('sidebar-collapsed');
                    if ($('#sidebar').hasClass('collapsed')) {
                        $('#toggle-sidebar i').removeClass('fa-chevron-left').addClass('fa-chevron-right');
                    } else {
                        $('#toggle-sidebar i').removeClass('fa-chevron-right').addClass('fa-chevron-left');
                    }
                });
                $('#zoom-in').on('click', () => {
                    const currentZoom = this.state.map.getZoom();
                    this.state.map.setZoom(currentZoom + 1);
                });
                $('#zoom-out').on('click', () => {
                    const currentZoom = this.state.map.getZoom();
                    this.state.map.setZoom(currentZoom - 1);
                });
                $('#recenter').on('click', () => {
                    this.recenterMap();
                });
                $('#show-stats').on('click', () => {
                    this.showStatistics();
                });
                $('#close-stats').on('click', () => {
                    $('#stats-panel').hide();
                });
                $('#apply-filters').on('click', () => {
                    this.applyFilters();
                });
                $('#reset-filters').on('click', () => {
                    this.resetFilters();
                });
                $('.region-button').on('click', (e) => {
                    const $btn = $(e.currentTarget);
                    $('.region-button').removeClass('active');
                    $btn.addClass('active');
                    const bounds = $btn.data('bounds');
                    if (bounds) {
                        const [west, south, east, north] = bounds.split(',').map(Number);
                        this.focusOnRegion(north, south, east, west);
                    }
                });
                $('#usa-mode').on('click', () => {
                    this.setViewMode('usa');
                    $('#usa-mode').removeClass('btn-outline-primary').addClass('btn-primary');
                    $('#global-mode').removeClass('btn-primary').addClass('btn-outline-primary');
                    this.focusOnUSA();
                });
                $('#global-mode').on('click', () => {
                    this.setViewMode('global');
                    $('#global-mode').removeClass('btn-outline-primary').addClass('btn-primary');
                    $('#usa-mode').removeClass('btn-primary').addClass('btn-outline-primary');
                });
                $('#prev-page').on('click', () => {
                    if (this.state.currentPage > 1) {
                        this.state.currentPage--;
                        this.updateMarkers();
                    }
                });
                $('#next-page').on('click', () => {
                    const totalPages = this.getTotalPages();
                    if (this.state.currentPage < totalPages) {
                        this.state.currentPage++;
                        this.updateMarkers();
                    }
                });
                $('#show-heatmap').on('change', () => {
                    this.toggleHeatmap($('#show-heatmap').is(':checked'));
                });
                $('#enable-clustering').on('change', () => {
                    this.updateMarkers();
                });
                $('#lazy-loading').on('change', () => {
                    this.state.lazyLoading = $('#lazy-loading').is(':checked');
                    if (!this.state.lazyLoading) {
                        if (this.state.viewMode === 'usa') {
                            this.loadUSAFireData();
                        } else {
                            this.loadWorldFireData();
                        }
                    }
                });
                $('#markers-per-page').on('change', () => {
                    this.state.markersPerPage = parseInt($('#markers-per-page').val());
                    this.state.currentPage = 1;
                    this.updateMarkers();
                });
                $('#confidence-range').on('input', function() {
                    const value = parseInt($(this).val());
                    $('#confidence-min').text(value + '%');
                });
                $('#frp-range').on('input', function() {
                    const value = parseInt($(this).val());
                    if (value === 0) {
                        $('#frp-min').text('0');
                    } else {
                        $('#frp-min').text(value);
                    }
                });
                window.addEventListener('resize', () => {
                    this.checkMobile();
                });
            }
            setViewMode(mode) {
                this.state.viewMode = mode;
                if (mode === 'usa') {
                    this.focusOnUSA();
                    this.loadUSAFireData();
                }
            }
            focusOnUSA() {
                const bounds = new google.maps.LatLngBounds(
                    new google.maps.LatLng(this.config.usBounds.south, this.config.usBounds.west),
                    new google.maps.LatLng(this.config.usBounds.north, this.config.usBounds.east)
                );
                this.state.map.fitBounds(bounds);
            }
            focusOnRegion(north, south, east, west) {
                const bounds = new google.maps.LatLngBounds(
                    new google.maps.LatLng(south, west),
                    new google.maps.LatLng(north, east)
                );
                this.state.map.fitBounds(bounds);
            }
            async loadDataForViewport() {
                const viewportString = JSON.stringify(this.state.viewport);
                if (this.state.loadingRegions.has(viewportString)) {
                    return;
                }
                const isUSAViewport = this.isViewportInUSA();
                if (this.state.viewMode === 'usa' && !isUSAViewport) {
                    return;
                }
                if (this.state.regionDataCache.has(viewportString)) {
                    console.log('Using cached data for viewport:', this.state.viewport);
                    return;
                }
                this.state.loadingRegions.add(viewportString);
                this.showRegionLoading();
                try {
                    let url = this.config.apiEndpoint;
                    const params = new URLSearchParams();
                    const source = this.state.activeFilters.source?.value || 'MODIS_NRT';
                    params.append('source', source);
                    params.append('area', 'world');
                    const days = this.state.activeFilters.days?.value || '1';
                    params.append('days', days);
                    url = `${url}?${params.toString()}`;
                    console.log(`Fetching fire data for viewport:`, this.state.viewport);
                    const response = await this.fetchWithRetry(url);
                    if (response.ok) {
                        try {
                            const data = await response.json();
                            if (Array.isArray(data)) {
                                console.log(`Received ${data.length} fire data points`);
                                const viewportData = this.filterDataToViewport(data, this.state.viewport);
                                console.log(`${viewportData.length} points are in current viewport`);
                                this.state.regionDataCache.set(viewportString, viewportData);
                                this.mergeFireData(viewportData);
                                this.filterData();
                                this.updateMarkers();
                                this.showStatus(`Loaded ${viewportData.length} fire data points for this area`, 'success');
                            }
                        } catch (error) {
                            console.error('Error processing viewport data:', error);
                        }
                    }
                } catch (error) {
                    console.error('Error loading viewport data:', error);
                } finally {
                    this.state.loadingRegions.delete(viewportString);
                    if (this.state.loadingRegions.size === 0) {
                        this.hideRegionLoading();
                    }
                }
            }
            mergeFireData(newData) {
                if (this.state.allFireData.length === 0) {
                    this.state.allFireData = [...newData];
                    return;
                }
                const existingIds = new Set();
                this.state.allFireData.forEach(point => {
                    const id = `${point.latitude},${point.longitude},${point.acq_date || ''},${point.acq_time || ''}`;
                    existingIds.add(id);
                });
                const uniqueNewData = newData.filter(point => {
                    const id = `${point.latitude},${point.longitude},${point.acq_date || ''},${point.acq_time || ''}`;
                    return !existingIds.has(id);
                });
                this.state.allFireData = [...this.state.allFireData, ...uniqueNewData];
                console.log(`Added ${uniqueNewData.length} new unique fire points`);
            }
            filterDataToViewport(data, viewport) {
                return data.filter(point => {
                    const lat = parseFloat(point.latitude);
                    const lng = parseFloat(point.longitude);
                    return (
                        lat >= viewport.south &&
                        lat <= viewport.north &&
                        lng >= viewport.west &&
                        lng <= viewport.east
                    );
                });
            }
            isViewportInUSA() {
                const viewport = this.state.viewport;
                const usBounds = this.config.usBounds;
                return !(
                    viewport.north < usBounds.south ||
                    viewport.south > usBounds.north ||
                    viewport.east < usBounds.west ||
                    viewport.west > usBounds.east
                );
            }
            async loadUSAFireData() {
                this.showStatus('Loading USA fire data...');
                try {
                    let url = this.config.apiEndpoint;
                    const params = new URLSearchParams();
                    const source = this.state.activeFilters.source?.value || 'MODIS_NRT';
                    params.append('source', source);
                    params.append('area', 'world');
                    const days = this.state.activeFilters.days?.value || '1';
                    params.append('days', days);
                    url = `${url}?${params.toString()}`;
                    console.log(`Fetching USA fire data: ${url}`);
                    const response = await this.fetchWithRetry(url);
                    if (response.ok) {
                        try {
                            const data = await response.json();
                            if (Array.isArray(data)) {
                                console.log(`Received ${data.length} global fire data points`);
                                const usaData = this.filterDataToUSA(data);
                                console.log(`${usaData.length} fire points are in the USA`);
                                this.processFireData(usaData);
                                this.showStatus(`Loaded ${usaData.length} USA fire data points`, 'success');
                            } else if (data.error) {
                                throw new Error(data.message || 'Unknown API error');
                            } else {
                                throw new Error('Unexpected response format from API');
                            }
                        } catch (error) {
                            console.error(`Error parsing API response: ${error.message}`);
                            throw error;
                        }
                    } else {
                        throw new Error(`API responded with status ${response.status}`);
                    }
                } catch (error) {
                    console.error(`Error loading USA fire data: ${error.message}`);
                    this.showStatus(`Error loading USA fire data: ${error.message}`, 'error');
                    if (this.state.allFireData.length === 0) {
                        console.warn('Generating sample data as fallback');
                        this.generateSampleData();
                    }
                }
            }
            filterDataToUSA(data) {
                const usBounds = this.config.usBounds;
                const alaskaBounds = { west: -170, south: 51, east: -130, north: 71 };
                const hawaiiBounds = { west: -160, south: 18, east: -154, north: 23 };
                return data.filter(point => {
                    const lat = parseFloat(point.latitude);
                    const lng = parseFloat(point.longitude);
                    const inContUS = (
                        lat >= usBounds.south &&
                        lat <= usBounds.north &&
                        lng >= usBounds.west &&
                        lng <= usBounds.east
                    );
                    const inAlaska = (
                        lat >= alaskaBounds.south &&
                        lat <= alaskaBounds.north &&
                        lng >= alaskaBounds.west &&
                        lng <= alaskaBounds.east
                    );
                    const inHawaii = (
                        lat >= hawaiiBounds.south &&
                        lat <= hawaiiBounds.north &&
                        lng >= hawaiiBounds.west &&
                        lng <= hawaiiBounds.east
                    );
                    return inContUS || inAlaska || inHawaii;
                });
            }
            async loadWorldFireData() {
                if (!this.state.lazyLoading) {
                    this.showLoadingMessage('Loading global fire data...');
                }
                this.showStatus('Loading global fire data...');
                try {
                    let url = this.config.apiEndpoint;
                    const params = new URLSearchParams();
                    const source = this.state.activeFilters.source?.value || 'MODIS_NRT';
                    params.append('source', source);
                    params.append('area', 'world');
                    const days = this.state.activeFilters.days?.value || '1';
                    params.append('days', days);
                    url = `${url}?${params.toString()}`;
                    console.log(`Fetching global fire data: ${url}`);
                    const response = await this.fetchWithRetry(url);
                    if (response.ok) {
                        try {
                            const data = await response.json();
                            if (Array.isArray(data)) {
                                console.log(`Received ${data.length} global fire data points`);
                                this.processFireData(data);
                                this.showStatus(`Loaded ${data.length} global fire data points`, 'success');
                            } else if (data.error) {
                                throw new Error(data.message || 'Unknown API error');
                            } else {
                                throw new Error('Unexpected response format from API');
                            }
                        } catch (error) {
                            console.error(`Error parsing API response: ${error.message}`);
                            throw error;
                        }
                    } else {
                        throw new Error(`API responded with status ${response.status}`);
                    }
                } catch (error) {
                    console.error(`Error loading global fire data: ${error.message}`);
                    this.showStatus(`Error loading global fire data: ${error.message}`, 'error');
                    if (this.state.allFireData.length === 0) {
                        console.warn('Generating sample data as fallback');
                        this.generateSampleData();
                    }
                } finally {
                    if (!this.state.lazyLoading) {
                        this.hideLoadingMessage();
                    }
                }
            }
            recenterMap() {
                if (this.state.viewMode === 'usa') {
                    this.focusOnUSA();
                } else if (this.state.filteredData.length > 0) {
                    const bounds = new google.maps.LatLngBounds();
                    this.state.filteredData.forEach(point => {
                        bounds.extend(new google.maps.LatLng(parseFloat(point.latitude), parseFloat(point.longitude)));
                    });
                    this.state.map.fitBounds(bounds);
                } else {
                    this.state.map.setCenter(this.config.defaultCenter);
                    this.state.map.setZoom(this.config.defaultZoom);
                }
            }
            
            // Get user's location and find fires nearby
            getUserLocation() {
                this.showStatus('Finding your location...', 'info');
                
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        // Success callback
                        (position) => {
                            const userLat = position.coords.latitude;
                            const userLng = position.coords.longitude;
                            
                            this.showStatus(`Found your location. Searching for fires nearby...`, 'success');
                            
                            // Create a marker for user's location
                            if (this.userLocationMarker) {
                                this.userLocationMarker.setMap(null);
                            }
                            
                            this.userLocationMarker = new google.maps.Marker({
                                position: { lat: userLat, lng: userLng },
                                map: this.state.map,
                                icon: {
                                    path: google.maps.SymbolPath.CIRCLE,
                                    fillColor: '#4285F4',
                                    fillOpacity: 1,
                                    strokeColor: 'white',
                                    strokeWeight: 2,
                                    scale: 8
                                },
                                title: 'Your Location',
                                zIndex: 10000
                            });
                            
                            // Center map on user location with appropriate zoom
                            this.state.map.setCenter({ lat: userLat, lng: userLng });
                            this.state.map.setZoom(9); // Closer zoom to show nearby fires
                            
                            // Find fires within range
                            this.findFiresNearLocation(userLat, userLng);
                        },
                        // Error callback
                        (error) => {
                            console.error('Geolocation error:', error);
                            let errorMsg = 'Unable to find your location. ';
                            
                            switch (error.code) {
                                case error.PERMISSION_DENIED:
                                    errorMsg += 'Please allow location access to find fires near you.';
                                    break;
                                case error.POSITION_UNAVAILABLE:
                                    errorMsg += 'Location information is unavailable.';
                                    break;
                                case error.TIMEOUT:
                                    errorMsg += 'Location request timed out.';
                                    break;
                                default:
                                    errorMsg += 'An unknown error occurred.';
                            }
                            
                            this.showStatus(errorMsg, 'error');
                        },
                        // Options
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 30000
                        }
                    );
                } else {
                    this.showStatus('Geolocation is not supported by your browser.', 'error');
                }
            }
            
            // Find fires near a specific location
            findFiresNearLocation(lat, lng, radius = 100) { // radius in km
                // Convert km to rough degrees for a simple filter
                // This is a simplification - 1 degree is roughly 111km at the equator
                const degRadius = radius / 111;
                
                if (this.state.filteredData.length === 0) {
                    this.showStatus('No fire data available to search', 'warning');
                    return;
                }
                
                const nearbyFires = this.state.filteredData.filter(fire => {
                    const fireLat = parseFloat(fire.latitude);
                    const fireLng = parseFloat(fire.longitude);
                    
                    const latDiff = Math.abs(fireLat - lat);
                    const lngDiff = Math.abs(fireLng - lng);
                    
                    return (latDiff <= degRadius && lngDiff <= degRadius);
                });
                
                if (nearbyFires.length > 0) {
                    // Highlight nearby fires - create a bound that includes user location and all nearby fires
                    const bounds = new google.maps.LatLngBounds();
                    bounds.extend(new google.maps.LatLng(lat, lng)); // Include user location
                    
                    // Create or update circle visualization showing search radius
                    if (this.userRadiusCircle) {
                        this.userRadiusCircle.setMap(null);
                    }
                    
                    this.userRadiusCircle = new google.maps.Circle({
                        map: this.state.map,
                        center: { lat, lng },
                        radius: radius * 1000, // Convert km to meters
                        strokeColor: '#4285F4',
                        strokeOpacity: 0.5,
                        strokeWeight: 1,
                        fillColor: '#4285F4',
                        fillOpacity: 0.1
                    });
                    
                    // Add all nearby fires to the bounds and (optionally) highlight them
                    nearbyFires.forEach(fire => {
                        const fireLat = parseFloat(fire.latitude);
                        const fireLng = parseFloat(fire.longitude);
                        bounds.extend(new google.maps.LatLng(fireLat, fireLng));
                        
                        // Here you could add highlight effects to these markers if desired
                    });
                    
                    // Fit map to show all nearby fires
                    this.state.map.fitBounds(bounds, { padding: 50 });
                    
                    // Display info about nearby fires
                    this.showStatus(`Found ${nearbyFires.length} fire${nearbyFires.length === 1 ? '' : 's'} within ${radius}km of your location.`, 'success');
                } else {
                    this.showStatus(`No fires found within ${radius}km of your location.`, 'info');
                }
            }
            applyFilters() {
                this.updateActiveFilters();
                if (this.state.activeFilters.source || this.state.activeFilters.days) {
                    this.state.regionDataCache.clear();
                    if (this.state.viewMode === 'usa') {
                        this.loadUSAFireData();
                    } else if (this.state.lazyLoading) {
                        this.loadDataForViewport();
                    } else {
                        this.loadWorldFireData();
                    }
                } else {
                    this.filterData();
                    this.updateMarkers();
                }
            }
            resetFilters() {
                $('#data-source').val('MODIS_NRT');
                $('#days-range').val('1');
                $('#confidence-range').val(0);
                $('#frp-range').val(0);
                $('#confidence-min').text('0%');
                $('#frp-min').text('0');
                $('#enable-clustering').prop('checked', true);
                $('#show-heatmap').prop('checked', false);
                $('#markers-per-page').val('1000');
                this.state.markersPerPage = 1000;
                this.state.currentPage = 1;
                this.state.activeFilters = {};
                $('#active-filters').empty();
                this.state.regionDataCache.clear();
                if (this.state.viewMode === 'usa') {
                    this.loadUSAFireData();
                } else {
                    this.loadWorldFireData();
                }
            }
            updateActiveFilters() {
                this.state.activeFilters = {};
                $('#active-filters').empty();
                const source = $('#data-source').val();
                const sourceText = $('#data-source option:selected').text();
                if (source !== 'MODIS_NRT') {
                    this.state.activeFilters.source = { value: source, label: sourceText };
                    this.addFilterTag('source', sourceText, () => {
                        $('#data-source').val('MODIS_NRT');
                        this.removeFilterTag('source');
                        delete this.state.activeFilters.source;
                    });
                }
                const days = $('#days-range').val();
                const daysText = $('#days-range option:selected').text();
                if (days !== '1') {
                    this.state.activeFilters.days = { value: days, label: daysText };
                    this.addFilterTag('days', daysText, () => {
                        $('#days-range').val('1');
                        this.removeFilterTag('days');
                        delete this.state.activeFilters.days;
                    });
                }
                const confidence = parseInt($('#confidence-range').val());
                if (confidence > 0) {
                    this.state.activeFilters.confidence = { value: confidence, label: `Confidence â¥ ${confidence}%` };
                    this.addFilterTag('confidence', `Confidence â¥ ${confidence}%`, () => {
                        $('#confidence-range').val(0);
                        $('#confidence-min').text('0%');
                        this.removeFilterTag('confidence');
                        delete this.state.activeFilters.confidence;
                    });
                }
                const frp = parseInt($('#frp-range').val());
                if (frp > 0) {
                    this.state.activeFilters.frp = { value: frp, label: `FRP â¥ ${frp} MW` };
                    this.addFilterTag('frp', `FRP â¥ ${frp} MW`, () => {
                        $('#frp-range').val(0);
                        $('#frp-min').text('0');
                        this.removeFilterTag('frp');
                        delete this.state.activeFilters.frp;
                    });
                }
            }
            addFilterTag(id, text, removeCallback) {
                const tag = $(`<span class="filter-tag" data-filter-id="${id}">${text} <span class="remove-filter">Ã</span></span>`);
                tag.find('.remove-filter').on('click', removeCallback);
                $('#active-filters').append(tag);
            }
            removeFilterTag(id) {
                $(`.filter-tag[data-filter-id="${id}"]`).remove();
            }
            processFireData(data) {
                this.state.allFireData = data;
                this.state.totalFirePoints = data.length;
                this.filterData();
                this.updateMarkers();
            }
            filterData() {
                let filtered = [...this.state.allFireData];
                if (this.state.activeFilters.confidence) {
                    const minConfidence = parseInt(this.state.activeFilters.confidence.value);
                    filtered = filtered.filter(point => {
                        const confidence = parseInt(point.confidence) || 0;
                        return confidence >= minConfidence;
                    });
                }
                if (this.state.activeFilters.frp) {
                    const minFrp = parseInt(this.state.activeFilters.frp.value);
                    filtered = filtered.filter(point => {
                        const frp = parseFloat(point.frp) || 0;
                        return frp >= minFrp;
                    });
                }
                this.state.filteredData = filtered;
                this.updatePaginationInfo();
            }
            updateMarkers() {
                this.clearMarkers();
                if (this.state.currentPage > this.getTotalPages()) {
                    this.state.currentPage = 1;
                }
                this.updatePaginationInfo();
                if (this.state.filteredData.length === 0) {
                    this.showStatus('No fire data points match your filters.', 'warning');
                    return;
                }
                let displayData;
                if (this.state.markersPerPage === Number.MAX_SAFE_INTEGER) {
                    displayData = this.state.filteredData;
                } else {
                    const startIndex = (this.state.currentPage - 1) * this.state.markersPerPage;
                    const endIndex = startIndex + this.state.markersPerPage;
                    displayData = this.state.filteredData.slice(startIndex, endIndex);
                }
                const heatmapData = [];
                const markers = displayData.map(fire => {
                    if (!fire.latitude || !fire.longitude) return null;
                    const lat = parseFloat(fire.latitude);
                    const lng = parseFloat(fire.longitude);
                    if (isNaN(lat) || isNaN(lng)) return null;
                    heatmapData.push({
                        location: new google.maps.LatLng(lat, lng),
                        weight: parseFloat(fire.frp) || 1
                    });
                    const marker = new google.maps.Marker({
                        position: { lat, lng },
                        map: this.state.map,
                        icon: this.createFireIcon(fire),
                        title: `Fire at ${lat}, ${lng}`
                    });
                    marker.addListener('click', () => {
                        this.showFireInfo(marker, fire);
                    });
                    this.addMarkerHoverEffect(marker, fire);
                    return marker;
                }).filter(marker => marker !== null);
                this.state.markers = markers;
                if ($('#enable-clustering').is(':checked')) {
                    this.setupMarkerClusterer();
                }
                if ($('#show-heatmap').is(':checked')) {
                    this.setupHeatmap(heatmapData);
                }
                this.showStatus(`Showing ${markers.length} of ${this.state.filteredData.length} fire points`, 'success');
            }
            setupMarkerClusterer() {
                try {
                    if (typeof MarkerClusterer === 'undefined') {
                        console.error('MarkerClusterer is not defined. Skipping clustering');
                        return;
                    }
                    console.log('Setting up marker clustering');
                    if (this.state.markerClusterer) {
                        this.state.markerClusterer.clearMarkers();
                    }
                    const renderer = {
                        render: ({ count, position }) => {
                            return new google.maps.Marker({
                                position,
                                label: { text: String(count), color: "white", fontSize: "10px" },
                                icon: {
                                    path: google.maps.SymbolPath.CIRCLE,
                                    fillColor: "#ff4500",
                                    fillOpacity: 0.7,
                                    strokeColor: "#ffffff",
                                    strokeWeight: 1,
                                    scale: Math.min(count / 5 + 10, 25)
                                },
                                zIndex: 1000
                            });
                        }
                    };
                    this.state.markerClusterer = new MarkerClusterer({
                        map: this.state.map,
                        markers: this.state.markers,
                        renderer: renderer
                    });
                    console.log('Marker clustering set up successfully');
                } catch (error) {
                    console.error('Error setting up marker clustering:', error);
                }
            }
            setupHeatmap(heatmapData) {
                if (this.state.heatmap) {
                    this.state.heatmap.setMap(null);
                }
                this.state.heatmap = new google.maps.visualization.HeatmapLayer({
                    data: heatmapData,
                    map: this.state.map,
                    radius: 20,
                    opacity: 0.7,
                    gradient: [
                        'rgba(255, 255, 0, 0)',
                        'rgba(255, 255, 0, 1)',
                        'rgba(255, 204, 0, 1)',
                        'rgba(255, 153, 0, 1)',
                        'rgba(255, 102, 0, 1)',
                        'rgba(255, 51, 0, 1)',
                        'rgba(255, 0, 0, 1)'
                    ]
                });
            }
            toggleHeatmap(visible) {
                if (visible) {
                    const heatmapData = this.state.filteredData.map(fire => {
                        return {
                            location: new google.maps.LatLng(parseFloat(fire.latitude), parseFloat(fire.longitude)),
                            weight: parseFloat(fire.frp) || 1
                        };
                    });
                    this.setupHeatmap(heatmapData);
                } else if (this.state.heatmap) {
                    this.state.heatmap.setMap(null);
                    this.state.heatmap = null;
                }
            }
            clearMarkers() {
                this.state.markers.forEach(marker => marker.setMap(null));
                this.state.markers = [];
                if (this.state.markerClusterer) {
                    this.state.markerClusterer.clearMarkers();
                }
                if (this.state.heatmap) {
                    this.state.heatmap.setMap(null);
                }
                if (this.state.infoWindow) {
                    this.state.infoWindow.close();
                }
            }
            createFireIcon(fire) {
                const confidence = parseInt(fire.confidence) || 50;
                const frp = parseFloat(fire.frp) || 10;
                const color = this.getFireColor(confidence);
                const size = this.getFireSize(frp);
                return {
                    path: google.maps.SymbolPath.CIRCLE,
                    fillColor: color,
                    fillOpacity: 0.7,
                    strokeColor: '#FFFFFF',
                    strokeWeight: 1,
                    scale: size
                };
            }
            getFireColor(confidence) {
                if (confidence >= 80) return '#FF0000';
                if (confidence >= 60) return '#FF4500';
                if (confidence >= 30) return '#FFA500';
                return '#FFCC00';
            }
            getFireSize(frp) {
                if (frp > 50) return 14;
                if (frp > 20) return 12;
                if (frp > 10) return 10;
                return 8;
            }
            showFireInfo(marker, fire) {
                let dateTimeInfo = '';
                if (fire.acq_date) {
                    dateTimeInfo += `<p><strong>Detection Date:</strong> ${fire.acq_date}</p>`;
                    if (fire.acq_time) {
                        const timeStr = fire.acq_time.toString().padStart(4, '0');
                        const hours = timeStr.substring(0, 2);
                        const minutes = timeStr.substring(2, 4);
                        dateTimeInfo += `<p><strong>Detection Time:</strong> ${hours}:${minutes} UTC</p>`;
                    }
                }
                
                // Show loading state first
                const loadingContent = `
                    <div style="padding: 15px; max-width: 300px; min-width: 250px; text-align: center;">
                        <h5 style="margin-top: 0; color: #ff4500; border-bottom: 1px solid #eee; padding-bottom: 8px;">
                            <i class="fas fa-fire" style="color: #ff4500;"></i> Fire Information
                        </h5>
                        <div style="padding: 15px 0;">
                            <i class="fas fa-spinner fa-spin" style="font-size: 20px; color: #ff4500; margin-bottom: 15px;"></i>
                            <p>Loading location data...</p>
                        </div>
                        <p><strong>Coordinates:</strong> ${fire.latitude}, ${fire.longitude}</p>
                        <p><strong>Confidence:</strong> ${fire.confidence || 'Unknown'}%</p>
                        <p><strong>Fire Power:</strong> ${fire.frp || 'Unknown'} MW</p>
                        ${dateTimeInfo}
                    </div>
                `;
                
                this.state.infoWindow.setContent(loadingContent);
                this.state.infoWindow.open(this.state.map, marker);
                
                // Get location name
                this.getLocationName(fire.latitude, fire.longitude)
                    .then(locationName => {
                        // Proceed only if the infoWindow is still open
                        if (!this.state.infoWindow.getMap()) return;
                        
                        const content = `
                            <div style="padding: 15px; max-width: 300px; min-width: 250px;">
                                <h5 style="margin-top: 0; color: #ff4500; border-bottom: 1px solid #eee; padding-bottom: 8px;">
                                    <i class="fas fa-fire" style="color: #ff4500;"></i> Fire Information
                                </h5>
                                <p><strong>Location:</strong> ${locationName}</p>
                                <p><strong>Coordinates:</strong> ${fire.latitude}, ${fire.longitude}</p>
                                <p><strong>Confidence:</strong> ${fire.confidence || 'Unknown'}%</p>
                                <p><strong>Fire Power:</strong> ${fire.frp || 'Unknown'} MW</p>
                                ${dateTimeInfo}
                                <p style="margin-top: 8px; font-size: 12px; color: #666;">
                                    <i class="fas fa-info-circle"></i> Data source: ${$('#data-source option:selected').text()}
                                </p>
                                <div style="text-align: center; margin-top: 15px;">
                                    <button class="btn btn-sm btn-danger more-info-btn" 
                                            style="background: linear-gradient(135deg, var(--fire-red), var(--fire-orange)); border: none;">
                                        <i class="fas fa-info-circle"></i> More Fire Details
                                    </button>
                                </div>
                            </div>
                        `;
                        this.state.infoWindow.setContent(content);
                        
                        // Add event listener to the "More Fire Details" button
                        setTimeout(() => {
                            const moreInfoBtn = document.querySelector('.more-info-btn');
                            if (moreInfoBtn) {
                                moreInfoBtn.addEventListener('click', () => {
                                    this.showExtendedFireInfo(fire, locationName);
                                });
                            }
                        }, 100);
                    })
                    .catch(err => {
                        console.error('Geocoding error in info window:', err);
                        // Fallback content without location name
                        if (!this.state.infoWindow.getMap()) return;
                        
                        const content = `
                            <div style="padding: 15px; max-width: 300px; min-width: 250px;">
                                <h5 style="margin-top: 0; color: #ff4500; border-bottom: 1px solid #eee; padding-bottom: 8px;">
                                    <i class="fas fa-fire" style="color: #ff4500;"></i> Fire Information
                                </h5>
                                <p><strong>Coordinates:</strong> ${fire.latitude}, ${fire.longitude}</p>
                                <p><strong>Confidence:</strong> ${fire.confidence || 'Unknown'}%</p>
                                <p><strong>Fire Power:</strong> ${fire.frp || 'Unknown'} MW</p>
                                ${dateTimeInfo}
                                <p style="margin-top: 8px; font-size: 12px; color: #666;">
                                    <i class="fas fa-info-circle"></i> Data source: ${$('#data-source option:selected').text()}
                                </p>
                                <div style="text-align: center; margin-top: 15px;">
                                    <button class="btn btn-sm btn-danger more-info-btn"
                                            style="background: linear-gradient(135deg, var(--fire-red), var(--fire-orange)); border: none;">
                                        <i class="fas fa-info-circle"></i> More Fire Details
                                    </button>
                                </div>
                            </div>
                        `;
                        this.state.infoWindow.setContent(content);
                        
                        // Add event listener to the "More Fire Details" button
                        setTimeout(() => {
                            const moreInfoBtn = document.querySelector('.more-info-btn');
                            if (moreInfoBtn) {
                                moreInfoBtn.addEventListener('click', () => {
                                    this.showExtendedFireInfo(fire, this.roundedCoords(fire.latitude, fire.longitude));
                                });
                            }
                        }, 100);
                    });
            }
            
            // Show extended fire information in a modal-like popup
            showExtendedFireInfo(fire, locationName) {
                // Close the info window
                this.state.infoWindow.close();
                
                // Create a container for extended info if it doesn't exist
                let extendedInfoPanel = document.getElementById('extended-fire-info');
                if (!extendedInfoPanel) {
                    extendedInfoPanel = document.createElement('div');
                    extendedInfoPanel.id = 'extended-fire-info';
                    extendedInfoPanel.className = 'extended-fire-info';
                    document.body.appendChild(extendedInfoPanel);
                    
                    // Add CSS for the panel if not already defined
                    if (!document.getElementById('extended-fire-info-css')) {
                        const style = document.createElement('style');
                        style.id = 'extended-fire-info-css';
                        style.textContent = `
                            .extended-fire-info {
                                position: fixed;
                                top: 0;
                                left: 0;
                                right: 0;
                                bottom: 0;
                                background-color: rgba(0, 0, 0, 0.7);
                                z-index: 2000;
                                display: flex;
                                justify-content: center;
                                align-items: center;
                                opacity: 0;
                                transition: opacity 0.3s ease;
                            }
                            .extended-fire-info.visible {
                                opacity: 1;
                            }
                            .extended-fire-info-content {
                                background-color: white;
                                border-radius: 12px;
                                max-width: 500px;
                                width: 90%;
                                max-height: 80vh;
                                overflow-y: auto;
                                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
                                transform: translateY(20px);
                                transition: transform 0.3s ease;
                            }
                            .extended-fire-info.visible .extended-fire-info-content {
                                transform: translateY(0);
                            }
                            .extended-fire-info-header {
                                padding: 15px 20px;
                                border-bottom: 1px solid #eee;
                                position: sticky;
                                top: 0;
                                background: white;
                                border-radius: 12px 12px 0 0;
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                            }
                            .extended-fire-info-body {
                                padding: 20px;
                            }
                            .extended-fire-info-footer {
                                padding: 15px 20px;
                                border-top: 1px solid #eee;
                                text-align: right;
                            }
                            .close-extended-info {
                                background: none;
                                border: none;
                                font-size: 24px;
                                cursor: pointer;
                                color: #999;
                            }
                            .fire-stat-card {
                                border: 1px solid #eee;
                                border-radius: 8px;
                                padding: 15px;
                                margin-bottom: 15px;
                                background-color: #f9f9f9;
                            }
                            .fire-danger-level {
                                display: inline-block;
                                padding: 5px 10px;
                                border-radius: 15px;
                                font-weight: bold;
                                margin-top: 5px;
                            }
                            .danger-low {
                                background-color: #ffc107;
                                color: #212529;
                            }
                            .danger-medium {
                                background-color: #fd7e14;
                                color: white;
                            }
                            .danger-high {
                                background-color: #dc3545;
                                color: white;
                            }
                        `;
                        document.head.appendChild(style);
                    }
                }
                
                // Calculate fire danger level based on confidence and FRP
                const confidence = parseInt(fire.confidence) || 0;
                const frp = parseFloat(fire.frp) || 0;
                
                let dangerLevel = 'Low';
                let dangerClass = 'danger-low';
                
                if ((confidence >= 80 && frp >= 30) || frp >= 50) {
                    dangerLevel = 'High';
                    dangerClass = 'danger-high';
                } else if ((confidence >= 60 && frp >= 20) || frp >= 30) {
                    dangerLevel = 'Medium';
                    dangerClass = 'danger-medium';
                }
                
                // Format detection time
                let detectionTime = 'Unknown';
                if (fire.acq_date) {
                    detectionTime = fire.acq_date;
                    if (fire.acq_time) {
                        const timeStr = fire.acq_time.toString().padStart(4, '0');
                        const hours = timeStr.substring(0, 2);
                        const minutes = timeStr.substring(2, 4);
                        detectionTime += ` at ${hours}:${minutes} UTC`;
                    }
                }
                
                // Fill the panel with content
                extendedInfoPanel.innerHTML = `
                    <div class="extended-fire-info-content">
                        <div class="extended-fire-info-header">
                            <h4 style="margin: 0; color: #ff4500;">
                                <i class="fas fa-fire"></i> Fire at ${locationName}
                            </h4>
                            <button class="close-extended-info">&times;</button>
                        </div>
                        <div class="extended-fire-info-body">
                            <div class="fire-stat-card">
                                <h5>Location Details</h5>
                                <p><strong>Location:</strong> ${locationName}</p>
                                <p><strong>Coordinates:</strong> ${fire.latitude}, ${fire.longitude}</p>
                                <p><strong>Detection:</strong> ${detectionTime}</p>
                                <p><strong>Data Source:</strong> ${$('#data-source option:selected').text()}</p>
                            </div>
                            
                            <div class="fire-stat-card">
                                <h5>Fire Characteristics</h5>
                                <p><strong>Confidence:</strong> ${fire.confidence || 'Unknown'}%</p>
                                <p><strong>Fire Radiative Power:</strong> ${frp} MW</p>
                                <p><strong>Danger Level:</strong> <span class="fire-danger-level ${dangerClass}">${dangerLevel}</span></p>
                                <p><small>* Based on satellite detection parameters</small></p>
                            </div>
                            
                            <div class="fire-stat-card">
                                <h5>Safety Information</h5>
                                <p>If this fire is near you:</p>
                                <ul>
                                    <li>Stay informed through local emergency channels</li>
                                    <li>Prepare for possible evacuation</li>
                                    <li>Monitor air quality if smoke is present</li>
                                    <li>Follow all instructions from local authorities</li>
                                </ul>
                                <p><a href="safety-info.html" target="_blank">View Complete Fire Safety Guide</a></p>
                            </div>
                        </div>
                        <div class="extended-fire-info-footer">
                            <button class="btn btn-primary close-btn">Close</button>
                        </div>
                    </div>
                `;
                
                // Show the panel
                setTimeout(() => {
                    extendedInfoPanel.classList.add('visible');
                }, 10);
                
                // Add close functionality
                const closeBtn = extendedInfoPanel.querySelector('.close-btn');
                const closeX = extendedInfoPanel.querySelector('.close-extended-info');
                
                const closePanel = () => {
                    extendedInfoPanel.classList.remove('visible');
                    setTimeout(() => {
                        extendedInfoPanel.remove();
                    }, 300);
                };
                
                closeBtn.addEventListener('click', closePanel);
                closeX.addEventListener('click', closePanel);
                extendedInfoPanel.addEventListener('click', (e) => {
                    if (e.target === extendedInfoPanel) {
                        closePanel();
                    }
                });
            }
            addMarkerHoverEffect(marker, fire) {
                const tooltip = document.getElementById('custom-tooltip');
                const locationDiv = tooltip.querySelector('.tooltip-location');
                const dataDiv = tooltip.querySelector('.tooltip-data');
                
                marker.addListener('mouseover', (event) => {
                    const point = event.pixel;
                    tooltip.style.left = (point.x + 15) + 'px';
                    tooltip.style.top = (point.y - 15) + 'px';
                    
                    // Show initial loading state
                    locationDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading location...';
                    dataDiv.innerHTML = `
                        <div>Confidence: ${fire.confidence || 'Unknown'}%</div>
                        <div>Fire Power: ${fire.frp || 'Unknown'} MW</div>
                    `;
                    tooltip.style.display = 'block';
                    
                    // Get location info using reverse geocoding
                    this.getLocationName(fire.latitude, fire.longitude)
                        .then(locationName => {
                            if (tooltip.style.display === 'block') { // Only update if tooltip is still visible
                                locationDiv.innerHTML = `<i class="fas fa-fire"></i> ${locationName}`;
                            }
                        })
                        .catch(err => {
                            console.error('Geocoding error:', err);
                            if (tooltip.style.display === 'block') {
                                const fallback = this.roundedCoords(fire.latitude, fire.longitude);
                                locationDiv.innerHTML = `<i class="fas fa-map-marker-alt"></i> ${fallback}`;
                            }
                        });
                });
                
                marker.addListener('mouseout', function() {
                    tooltip.style.display = 'none';
                });
                
                marker.addListener('mousemove', function(event) {
                    const point = event.pixel;
                    tooltip.style.left = (point.x + 15) + 'px';
                    tooltip.style.top = (point.y - 15) + 'px';
                });
            }
            
            // Enhanced geocoding using existing Cloudflare worker
            async getLocationName(lat, lng) {
                try {
                    // Cache geocoding results to avoid excessive API calls
                    const cacheKey = `${lat},${lng}`;
                    if (this.locationCache && this.locationCache.has(cacheKey)) {
                        return this.locationCache.get(cacheKey);
                    }
                    
                    // For sample data, use realistic locations
                    if (this.isSampleData(lat, lng)) {
                        const fakeLocs = ['Denver, CO', 'Kansas City, MO', 'Omaha, NE', 'Oklahoma City, OK', 
                                         'Boise, ID', 'Salt Lake City, UT', 'Phoenix, AZ', 'Albuquerque, NM',
                                         'Minneapolis, MN', 'Des Moines, IA', 'Cheyenne, WY', 'Helena, MT'];
                        const randomLoc = fakeLocs[Math.floor(Math.random() * fakeLocs.length)];
                        this.locationCache.set(cacheKey, randomLoc);
                        return randomLoc;
                    }
                    
                    // Call the server-side geocoding API using the Cloudflare worker
                    try {
                        // Use existing Cloudflare worker endpoint
                        const response = await fetch(`${this.config.geocodingEndpoint}?lat=${lat}&lng=${lng}`, {
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json',
                                'Cache-Control': 'max-age=86400' // Cache for 24 hours
                            }
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            if (data.success && data.location) {
                                // Cache and return the location from server API
                                this.locationCache.set(cacheKey, data.location);
                                return data.location;
                            }
                        }
                        throw new Error('Server-side geocoding failed');
                    } catch (error) {
                        console.error('Server-side geocoding error:', error);
                        
                        // Fallback to built-in geocoder if available
                        if (window.google && google.maps && google.maps.Geocoder && this.state.map) {
                            try {
                                const result = await this.geocodeWithGoogleMaps(lat, lng);
                                if (result) {
                                    this.locationCache.set(cacheKey, result);
                                    return result;
                                }
                            } catch (gmapsError) {
                                console.error('Google Maps geocoder error:', gmapsError);
                            }
                        }
                    }
                    
                    // Ultimate fallback: formatted coordinates
                    const coordStr = this.roundedCoords(lat, lng);
                    this.locationCache.set(cacheKey, coordStr);
                    return coordStr;
                    
                } catch (error) {
                    console.error('Geocoding function error:', error);
                    return this.roundedCoords(lat, lng);
                }
            }
            
            // Process geocoding results to get the most accurate location name
            processGeocodingResults(results) {
                // First try to find the most relevant result type
                const priorityTypes = [
                    'locality',
                    'administrative_area_level_2',
                    'administrative_area_level_1',
                    'country'
                ];
                
                let bestResult = null;
                
                // Find the most specific result based on priority
                for (const type of priorityTypes) {
                    for (const result of results) {
                        if (result.types.includes(type)) {
                            bestResult = result;
                            break;
                        }
                    }
                    if (bestResult) break;
                }
                
                // If no priority match was found, use the first result
                if (!bestResult && results.length > 0) {
                    bestResult = results[0];
                }
                
                if (bestResult) {
                    // Extract components to build a location string
                    let locality = null;
                    let adminArea2 = null;
                    let adminArea1 = null;
                    let country = null;
                    
                    for (const component of bestResult.address_components) {
                        const types = component.types;
                        
                        if (types.includes('locality')) {
                            locality = component.long_name;
                        } else if (types.includes('administrative_area_level_2')) {
                            adminArea2 = component.long_name;
                        } else if (types.includes('administrative_area_level_1')) {
                            adminArea1 = component.short_name;
                        } else if (types.includes('country')) {
                            country = component.short_name;
                        }
                    }
                    
                    // Build the location string from most to least specific
                    if (locality) {
                        if (adminArea1) {
                            return `${locality}, ${adminArea1}`;
                        }
                        return locality;
                    } else if (adminArea2) {
                        if (adminArea1) {
                            return `${adminArea2}, ${adminArea1}`;
                        }
                        return adminArea2;
                    } else if (adminArea1) {
                        if (country && country !== adminArea1) {
                            return `${adminArea1}, ${country}`;
                        }
                        return adminArea1;
                    } else if (country) {
                        return country;
                    }
                    
                    // Fallback to formatted address if components couldn't be properly extracted
                    return bestResult.formatted_address;
                }
                
                return null;
            }
            
            // Use Google Maps Geocoder directly (as last resort)
            geocodeWithGoogleMaps(lat, lng) {
                return new Promise((resolve, reject) => {
                    const geocoder = new google.maps.Geocoder();
                    const latlng = { lat: parseFloat(lat), lng: parseFloat(lng) };
                    
                    geocoder.geocode({ 'location': latlng }, (results, status) => {
                        if (status === 'OK' && results && results.length > 0) {
                            const result = this.processGeocodingResults(results);
                            resolve(result || results[0].formatted_address);
                        } else {
                            reject(new Error(`Geocoding failed: ${status}`));
                        }
                    });
                });
            }
            
            // Format coordinates for a fallback location display
            roundedCoords(lat, lng) {
                return `${parseFloat(lat).toFixed(3)}Â°, ${parseFloat(lng).toFixed(3)}Â°`;
            }
            
            // Check if this is likely sample data
            isSampleData(lat, lng) {
                const centerLat = this.config.defaultCenter.lat;
                const centerLng = this.config.defaultCenter.lng;
                
                // Check if within 25 degrees of the default center (likely sample data)
                return (Math.abs(lat - centerLat) < 25 && Math.abs(lng - centerLng) < 50);
            }
            generateSampleData() {
                this.showStatus('Using sample data as fallback', 'warning');
                const center = this.config.defaultCenter;
                const sampleData = [];
                for (let i = 0; i < 50; i++) {
                    const latOffset = (Math.random() - 0.5) * 20;
                    const lngOffset = (Math.random() - 0.5) * 50;
                    const confidence = Math.floor(Math.random() * 100);
                    const frp = Math.random() * 100;
                    sampleData.push({
                        latitude: center.lat + latOffset,
                        longitude: center.lng + lngOffset,
                        confidence: confidence,
                        frp: frp,
                        acq_date: '2025-05-09',
                        acq_time: '1200'
                    });
                }
                this.processFireData(sampleData);
            }
            showLoading(message = 'Loading...') {
                document.getElementById('loading-overlay').style.display = 'flex';
                document.getElementById('loading-message').textContent = message;
            }
            hideLoading() {
                document.getElementById('loading-overlay').style.display = 'none';
            }
            showRegionLoading() {
                document.getElementById('region-loading').style.display = 'block';
            }
            hideRegionLoading() {
                document.getElementById('region-loading').style.display = 'none';
            }
            showLoadingMessage(message) {
                const loadingMessage = document.getElementById('loading-data-message');
                loadingMessage.innerHTML = `<span class="loading-data-spinner"></span> ${message}`;
                loadingMessage.style.display = 'block';
            }
            hideLoadingMessage() {
                document.getElementById('loading-data-message').style.display = 'none';
            }
            showStatus(message, type = 'info') {
                const statusPanel = document.getElementById('status-panel');
                statusPanel.textContent = message;
                statusPanel.className = '';
                statusPanel.classList.add('status-panel');
                if ($('#sidebar').hasClass('collapsed')) {
                    statusPanel.classList.add('sidebar-collapsed');
                }
                switch (type) {
                    case 'success':
                        statusPanel.style.backgroundColor = '#d4edda';
                        statusPanel.style.color = '#155724';
                        break;
                    case 'error':
                        statusPanel.style.backgroundColor = '#f8d7da';
                        statusPanel.style.color = '#721c24';
                        break;
                    case 'warning':
                        statusPanel.style.backgroundColor = '#fff3cd';
                        statusPanel.style.color = '#856404';
                        break;
                    default:
                        statusPanel.style.backgroundColor = '#d1ecf1';
                        statusPanel.style.color = '#0c5460';
                }
                statusPanel.style.display = 'block';
                if (type !== 'error') {
                    setTimeout(() => {
                        statusPanel.style.display = 'none';
                    }, 5000);
                }
            }
            updatePaginationInfo() {
                const totalPages = this.getTotalPages();
                $('#current-page').text(this.state.currentPage);
                $('#total-pages').text(totalPages);
                $('#prev-page').prop('disabled', this.state.currentPage <= 1);
                $('#next-page').prop('disabled', this.state.currentPage >= totalPages);
                if (totalPages <= 1) {
                    $('.pagination-container').hide();
                } else {
                    $('.pagination-container').show();
                }
            }
            getTotalPages() {
                return Math.ceil(this.state.filteredData.length / this.state.markersPerPage);
            }
            showStatistics() {
                if (this.state.filteredData.length === 0) {
                    this.showStatus('No data available for statistics', 'warning');
                    return;
                }
                $('#stats-panel').show();
                const totalFires = this.state.filteredData.length;
                const confidenceLevels = { high: 0, medium: 0, low: 0, veryLow: 0 };
                const frpLevels = { extreme: 0, high: 0, medium: 0, low: 0 };
                const dateMap = new Map();
                this.state.filteredData.forEach(fire => {
                    const confidence = parseInt(fire.confidence) || 0;
                    if (confidence >= 80) confidenceLevels.high++;
                    else if (confidence >= 60) confidenceLevels.medium++;
                    else if (confidence >= 30) confidenceLevels.low++;
                    else confidenceLevels.veryLow++;
                    const frp = parseFloat(fire.frp) || 0;
                    if (frp > 50) frpLevels.extreme++;
                    else if (frp > 20) frpLevels.high++;
                    else if (frp > 10) frpLevels.medium++;
                    else frpLevels.low++;
                    const date = fire.acq_date || 'Unknown';
                    if (dateMap.has(date)) {
                        dateMap.set(date, dateMap.get(date) + 1);
                    } else {
                        dateMap.set(date, 1);
                    }
                });
                const sortedDates = [...dateMap.entries()].sort((a, b) => b[1] - a[1]).slice(0, 5);
                let statsHtml = `
                    <div class="mb-3">
                        <strong>Total Fire Points:</strong> ${totalFires}<br>
                        <strong>Data Source:</strong> ${$('#data-source option:selected').text()}<br>
                        <strong>Time Range:</strong> ${$('#days-range option:selected').text()}<br>
                        <strong>Region:</strong> ${this.state.viewMode === 'usa' ? 'USA' : 'Global'}
                    </div>
                    <div class="mb-3">
                        <strong>Confidence Levels:</strong><br>
                        High (80-100%): ${confidenceLevels.high} (${Math.round(confidenceLevels.high/totalFires*100)}%)<br>
                        Medium (60-79%): ${confidenceLevels.medium} (${Math.round(confidenceLevels.medium/totalFires*100)}%)<br>
                        Low (30-59%): ${confidenceLevels.low} (${Math.round(confidenceLevels.low/totalFires*100)}%)<br>
                        Very Low (0-29%): ${confidenceLevels.veryLow} (${Math.round(confidenceLevels.veryLow/totalFires*100)}%)
                    </div>
                    <div class="mb-3">
                        <strong>Fire Intensity (FRP):</strong><br>
                        Extreme (>50 MW): ${frpLevels.extreme} (${Math.round(frpLevels.extreme/totalFires*100)}%)<br>
                        High (20-50 MW): ${frpLevels.high} (${Math.round(frpLevels.high/totalFires*100)}%)<br>
                        Medium (10-20 MW): ${frpLevels.medium} (${Math.round(frpLevels.medium/totalFires*100)}%)<br>
                        Low (<10 MW): ${frpLevels.low} (${Math.round(frpLevels.low/totalFires*100)}%)
                    </div>
                `;
                if (sortedDates.length > 0 && sortedDates[0][0] !== 'Unknown') {
                    statsHtml += `
                        <div>
                            <strong>Top Detection Dates:</strong><br>
                    `;
                    sortedDates.forEach(([date, count]) => {
                        statsHtml += `${date}: ${count} fires (${Math.round(count/totalFires*100)}%)<br>`;
                    });
                    statsHtml += `</div>`;
                }
                $('#stats-content').html(statsHtml);
            }
            async fetchWithRetry(url, retries = 0) {
                try {
                    console.log(`Fetch attempt ${retries + 1}/${this.config.maxFetchRetries + 1}: ${url}`);
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: { 'Accept': 'application/json', 'Cache-Control': 'no-cache' },
                        cache: 'no-cache'
                    });
                    console.log(`Response status: ${response.status} ${response.statusText}`);
                    return response;
                } catch (error) {
                    console.error(`Fetch error: ${error.message}`);
                    if (retries < this.config.maxFetchRetries - 1) {
                        console.log(`Retrying... (${retries + 1}/${this.config.maxFetchRetries})`);
                        await new Promise(r => setTimeout(r, 1000 * Math.pow(2, retries)));
                        return this.fetchWithRetry(url, retries + 1);
                    }
                    throw error;
                }
            }
        }
        $(document).ready(function() {
            window.fireMap = new FireMap();
        });
    </script>
    <script>
        // This function will be replaced by your actual Cloudflare worker implementation
        // which handles the NASA_FIRMS_MAP_KEY and geocoding API keys
        
        // Mock the server-side geocoding API during development
        const originalFetch = window.fetch;
        window.fetch = function(url, options) {
            // Check if this is a geocoding request to our server API
            if (url.includes('/api/geocode')) {
                // In production, this is handled by your Cloudflare worker
                // which has access to the protected Google API key
                console.log('Using server-side geocoding API');
                
                // Development placeholder - remove this in production
                return new Promise((resolve) => {
                    // Parse the URL to get lat/lng
                    const urlObj = new URL(url);
                    const lat = urlObj.searchParams.get('lat');
                    const lng = urlObj.searchParams.get('lng');
                    
                    // In production, your Cloudflare worker would make the actual API call
                    // using NASA_FIRMS_MAP_KEY
                    
                    // This is just for testing - your worker handles the actual call
                    setTimeout(() => {
                        resolve({
                            ok: true,
                            json: () => Promise.resolve({
                                success: true,
                                location: `Vicinity of ${lat.substring(0, 5)}Â°, ${lng.substring(0, 6)}Â°`
                            })
                        });
                    }, 200);
                });
            }
            
            // Pass through all other requests
            return originalFetch(url, options);
        };
        
        function initMap() {
            console.log('Google Maps API loaded with all required libraries');
            if (window.fireMap && window.fireMap.onGoogleMapsLoaded) {
                window.fireMap.onGoogleMapsLoaded();
            }
        }
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD9MXRpmeXMKlezIOs3lPAjn0C5yLeTNUk&libraries=visualization,drawing,places&callback=initMap"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const hamburger = document.querySelector('.hamburger');
            const navMenu = document.querySelector('.nav-menu');
            const mainNavLinks = document.querySelectorAll('.main-menu a');
            if (hamburger && navMenu) {
                hamburger.addEventListener('click', () => {
                    const isActive = navMenu.classList.contains('active');
                    hamburger.classList.toggle('active');
                    navMenu.classList.toggle('active');
                    hamburger.setAttribute('aria-expanded', !isActive);
                    if (!navMenu.classList.contains('active')) {
                        document.querySelectorAll('.main-menu .has-dropdown.open').forEach(openDropdown => {
                            openDropdown.classList.remove('open');
                            const caret = openDropdown.querySelector('a > i.fa-caret-down');
                            if(caret) caret.style.transform = '';
                        });
                    }
                });
            }
            if (navMenu) {
                const dropdownToggles = navMenu.querySelectorAll('.main-menu .has-dropdown > a');
                dropdownToggles.forEach(toggleLink => {
                    toggleLink.addEventListener('click', (e) => {
                        if (hamburger && window.getComputedStyle(hamburger).display !== 'none') {
                            e.preventDefault();
                            const parentLi = toggleLink.closest('.has-dropdown');
                            if (parentLi) {
                                const currentlyOpen = parentLi.classList.contains('open');
                                document.querySelectorAll('.main-menu .has-dropdown.open').forEach(otherLi => {
                                    if (otherLi !== parentLi) {
                                        otherLi.classList.remove('open');
                                        const otherCaret = otherLi.querySelector('a > i.fa-caret-down');
                                        if(otherCaret) otherCaret.style.transform = '';
                                    }
                                });
                                parentLi.classList.toggle('open', !currentlyOpen);
                                const caret = toggleLink.querySelector('i.fa-caret-down');
                                if (caret) {
                                    caret.style.transform = parentLi.classList.contains('open') ? 'rotate(180deg)' : '';
                                }
                            }
                        }
                        else if (!toggleLink.getAttribute('href') || toggleLink.getAttribute('href') === '#') {
                            e.preventDefault();
                        }
                    });
                });
                mainNavLinks.forEach(link => {
                    const isToggle = link.matches('.has-dropdown > a');
                    const isInDropdown = link.closest('.dropdown') !== null;
                    if (!isToggle || (isInDropdown && hamburger && navMenu.classList.contains('active'))) {
                        link.addEventListener('click', (e) => {
                            const href = link.getAttribute('href');
                            let isExternal = false;
                            try {
                                isExternal = new URL(href, window.location.origin).origin !== window.location.origin;
                            } catch (_) {}
                            if (hamburger && navMenu.classList.contains('active') && (!href || href === '#' || (href.startsWith('#') && !isExternal))) {
                                hamburger.classList.remove('active');
                                navMenu.classList.remove('active');
                                hamburger.setAttribute('aria-expanded', 'false');
                                document.querySelectorAll('.main-menu .has-dropdown.open').forEach(openDropdown => {
                                    openDropdown.classList.remove('open');
                                    const caret = openDropdown.querySelector('a > i.fa-caret-down');
                                    if(caret) caret.style.transform = '';
                                });
                            }
                        });
                    }
                });
            }
            const yearSpan = document.getElementById('year');
            if (yearSpan) {
                yearSpan.textContent = new Date().getFullYear();
            }
        });
    </script>
</body>
</html>
