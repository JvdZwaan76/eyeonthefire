<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Eye on the Fire - Premier Interactive Fire Map & Live Updates</title>
  <meta name="description" content="Eye on the Fire is your premier destination to monitor active wildfires near you with our interactive live map. Get real-time updates, safety tips, and community insights instantly.">
  <meta name="keywords" content="interactive fire map, live wildfire updates, fires near me, real-time fire monitoring, fire safety, Eye on the Fire">
  <meta name="author" content="Eye on the Fire Team">
  <meta name="robots" content="index, follow">
  <link rel="canonical" href="https://eyeonthefire.com/"> <meta property="og:title" content="Eye on the Fire - Premier Interactive Fire Map">
  <meta property="og:description" content="Monitor active wildfires near you with Eye on the Fireâ€™s interactive live map. Stay updated with real-time fire data and safety resources.">
  <meta property="og:url" content="https://eyeonthefire.com/">
  <meta property="og:image" content="images/hero-bg.jpg"> <meta property="og:type" content="website">
  <meta name="twitter:card" content="summary_large_image">

  <link rel="shortcut icon" href="favicon/favicon.ico" type="image/x-icon">
  <link rel="icon" type="image/png" href="favicon/favicon-96x96.png" sizes="96x96">
  <link rel="apple-touch-icon" href="favicon/apple-touch-icon.png" sizes="180x180">
  <meta name="apple-mobile-web-app-title" content="eyeonthefire">
  <link rel="manifest" href="favicon/site.webmanifest">

  <script async src="https://www.googletagmanager.com/gtag/js?id=G-T8RE6KDBEW"></script> <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-T8RE6KDBEW'); // TODO: Replace with your GA ID
  </script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.fullscreen/2.0.0/Control.FullScreen.min.css" integrity="sha512-DRkMa+fn898M1uc6s9JZeztUoXN6viuHsXmh/pgz3jG6a77YWO3U3QYEjLoqbxOeclc2NunWfMTya4Y5twXAKA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Open+Sans:wght@300;400&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="styles.css">

</head>
<body>

  <nav class="navbar">...</nav>
  <header class="hero" id="home">...</header>
  <section id="map-section" class="map-section">...</section>
  <section id="about" class="content-section">...</section>
  <section id="prevention" class="content-section">...</section>
  <section id="community" class="content-section">...</section>
  <footer>...</footer>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.fullscreen/2.0.0/Control.FullScreen.min.js" integrity="sha512-c6ydt5Rypa1ptlnH2U1u+JybARYppbD1qxgythCI4pJ9EOfNYEWlLBjxBX926O3tq5p4Aw5GTY68vT0FdKbG3w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>
    console.log("[Script] Main script block started.");

    // ========================================================================
    // !!! CRITICAL SECURITY WARNING !!!
    // API KEYS ARE CURRENTLY EXPOSED CLIENT-SIDE. MOVE SERVER-SIDE BEFORE PRODUCTION.
    // ========================================================================
    const NASA_API_KEY = 'd152217c8391eb5b0fbd242290527ae8'; // !!! MOVE SERVER-SIDE !!!
    const AIRNOW_API_KEY = '54044855-7B0C-4023-BEE4-8B3FCA172DED';   // !!! MOVE SERVER-SIDE !!!
    const OPENCAGE_API_KEY = 'a40b9e954e50458bbc09ca24e70201a1'; // !!! MOVE SERVER-SIDE !!!

    // Map Variables and DOM Elements...
    let map; let fireLayer = L.layerGroup(); let airQualityLayer = L.layerGroup(); let nifcLayer = L.layerGroup(); let nwsLayer = L.layerGroup();
    let showFires = true; let showAirQuality = false; let showNIFC = true; let showNWS = true;
    const hamburger = document.getElementById('hamburger-menu'); const navMenu = document.getElementById('nav-menu');
    const mapLoadingMessage = document.getElementById('map-loading-message'); const mapErrorMessage = document.getElementById('map-error-message');
    const geolocationErrorDiv = document.getElementById('geolocation-error'); const mapWrapper = document.getElementById('map-wrapper');

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', initializeMap);

    // --- Function Definitions ---
    function addMapControls() { /* ... same code ... */ }
    function addMapLegend() { /* ... same code ... */ }

    // --- Core Functions ---
    function initializeMap() {
      console.log("[Init] Initializing map...");
      mapLoadingMessage.style.display = 'block';
      mapErrorMessage.style.display = 'none';
      geolocationErrorDiv.style.display = 'none';

      // *** ADDED: Check for geolocation object and wrap logic in try/catch ***
      try {
        console.log('[Init] Checking navigator.geolocation:', typeof navigator.geolocation);
        if (navigator.geolocation) {
          console.log("[Init] Attempting geolocation...");
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const userLat = position.coords.latitude;
              const userLon = position.coords.longitude;
              console.log('[Init] Geolocation successful:', userLat, userLon);
              setupMap([userLat, userLon], 10);
              loadInitialData(userLat, userLon);
            },
            (error) => {
              // Geolocation Failure Fallback
              console.warn(`[Init] Geolocation error (${error.code}): ${error.message}`);
              const defaultLat = 37.0902; const defaultLon = -95.7129; const defaultZoom = 5;
              geolocationErrorDiv.textContent = `Geolocation failed: ${error.message}. Showing default US view.`;
              geolocationErrorDiv.style.display = 'block';
              console.log("[Init] Geolocation failed, setting up map with default US view.");
              setupMap([defaultLat, defaultLon], defaultZoom);
              loadInitialData(defaultLat, defaultLon);
            },
            { timeout: 8000 }
          );
        } else {
          // No Geolocation Support Fallback
          console.warn('[Init] Geolocation is not supported by this browser.');
          const defaultLat = 37.0902; const defaultLon = -95.7129; const defaultZoom = 5;
          geolocationErrorDiv.textContent = 'Geolocation not supported. Showing default US view.';
          geolocationErrorDiv.style.display = 'block';
          console.log("[Init] Geolocation not supported, setting up map with default US view.");
          setupMap([defaultLat, defaultLon], defaultZoom);
          loadInitialData(defaultLat, defaultLon);
        }
      } catch (geoError) {
          console.error("[Init] Error accessing or using geolocation:", geoError);
          // Fallback if even accessing navigator.geolocation fails
          const defaultLat = 37.0902; const defaultLon = -95.7129; const defaultZoom = 5;
          geolocationErrorDiv.textContent = 'Could not access location services. Showing default US view.';
          geolocationErrorDiv.style.display = 'block';
          console.error("[Init] Falling back to default US view due to geolocation access error.");
          setupMap([defaultLat, defaultLon], defaultZoom);
          loadInitialData(defaultLat, defaultLon);
      }
    }

    function setupMap(centerCoords, zoomLevel) {
        console.log("[Setup] Setting up Leaflet map centered at:", centerCoords, " Zoom:", zoomLevel);
        let mapDiv = document.getElementById('fire-map');
        if (!mapDiv) { console.error("[Setup] CRITICAL: Map container div '#fire-map' not found!"); displayMapError("Map container not found. Cannot initialize map."); mapLoadingMessage.style.display = 'none'; return; }
        console.log("[Setup] Map container found. OffsetHeight:", mapDiv.offsetHeight, "OffsetWidth:", mapDiv.offsetWidth);

      try {
        if (map) { map.remove(); map = null; }
        console.log("[Setup] Creating L.map object...");
        map = L.map('fire-map', { center: centerCoords, zoom: zoomLevel, fullscreenControl: true });
        console.log("[Setup] L.map object created:", map ? 'Success' : 'Failed');

        const tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors | Fire Data: NASA FIRMS, NIFC | AQI: AirNow | Weather: NWS' });
        tileLayer.on('load', () => console.log("[Tiles] Tile layer loaded successfully."));
        tileLayer.on('tileerror', (error) => { console.error("[Tiles] Tile layer error:", error); displayMapError("Map tiles could not load."); });
        tileLayer.addTo(map);
        console.log("[Setup] Tile layer added to map.");

        console.log("[Setup] Adding initial data layers...");
        if (showFires && fireLayer) fireLayer.addTo(map); if (showNIFC && nifcLayer) nifcLayer.addTo(map); if (showNWS && nwsLayer) nwsLayer.addTo(map);

        addMapControls(); addMapLegend();

        map.on('fullscreenchange', function () { mapWrapper.classList.toggle('fullscreen', map.isFullscreen()); map.invalidateSize(); });
        map.on('resize', () => { console.log("[Event] Map resize event. Invalidating size."); if(map) map.invalidateSize();});

        mapLoadingMessage.style.display = 'none';
        // *** invalidateSize call at the END of setupMap, with delay ***
        setTimeout(() => { if (map) { console.log("[Setup] Calling delayed map.invalidateSize()."); map.invalidateSize(); } }, 150);
        console.log("[Setup] Map setup complete.");

      } catch(e) { console.error("[Setup] CRITICAL Error during map setup:", e); mapLoadingMessage.style.display = 'none'; displayMapError("Critical error setting up the map. Please refresh."); }
    }

    function loadInitialData(lat, lon) { /* ... same data loading code ... */ }

    // --- Data Loading Functions ---
    async function loadFIRMSFires(lat, lon) { /* ... same code ... */ }
    async function loadNIFCFires() { /* ... same code ... */ }
    async function loadAirQuality(lat, lon) { /* ... same code ... */ }
    async function loadNWSWarnings() { /* ... same code ... */ }

    // --- Control Handlers & Helper Functions ---
    /* ... same code ... */
     function addMapControls() { /* ... */ } function addMapLegend() { /* ... */ }
     hamburger.addEventListener('click', () => { /* ... */ }); navMenu.querySelectorAll('a').forEach(link => { /* ... */ });
     function centerOnUserLocation() { /* ... */ } function zoomToCA() { /* ... */ } function zoomToUS() { /* ... */ }
     function toggleFireLayers() { /* ... */ } function toggleAirQuality() { /* ... */ } function toggleNWSLayer() { /* ... */ }
     async function handleZipSearch(event) { /* ... */ }
     function getAQIColor(aqi) { /* ... */ } function displayMapError(message) { /* ... */ }

  </script>

</body>
</html>
