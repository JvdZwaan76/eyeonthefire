<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Eye on the Fire - Premier Interactive Fire Map & Live Updates</title>
  <meta name="description" content="Eye on the Fire is your premier destination to monitor active wildfires near you with our interactive live map. Get real-time updates, safety tips, and community insights instantly.">
  <meta name="keywords" content="interactive fire map, live wildfire updates, fires near me, real-time fire monitoring, fire safety, Eye on the Fire">
  <meta name="author" content="Eye on the Fire Team">
  <meta name="robots" content="index, follow">
  <link rel="canonical" href="https://eyeonthefire.com/"> <meta property="og:title" content="Eye on the Fire - Premier Interactive Fire Map">
  <meta property="og:description" content="Monitor active wildfires near you with Eye on the Fireâ€™s interactive live map. Stay updated with real-time fire data and safety resources.">
  <meta property="og:url" content="https://eyeonthefire.com/"> <meta property="og:image" content="/images/hero-bg.jpg"> <meta property="og:type" content="website">
  <meta name="twitter:card" content="summary_large_image">

  <link rel="shortcut icon" href="/favicon/favicon.ico" type="image/x-icon"> <link rel="icon" type="image/png" href="/favicon/favicon-96x96.png" sizes="96x96"> <link rel="apple-touch-icon" href="/favicon/apple-touch-icon.png" sizes="180x180"> <meta name="apple-mobile-web-app-title" content="eyeonthefire">
  <link rel="manifest" href="/favicon/site.webmanifest"> <script async src="https://www.googletagmanager.com/gtag/js?id=G-T8RE6KDBEW"></script> <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-T8RE6KDBEW'); // TODO: Replace with your GA ID
  </script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.fullscreen/2.0.0/Control.FullScreen.min.css" integrity="sha512-nMLF4DF8M5F0+Pf/3QuqfF2U2w7aJ3N0+r/QQ/Y07h6bF6HjGzG0jL9Uj71a3hK47a2U1yvPzx41mU1/7/tA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Open+Sans:wght@300;400&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="styles.css">

</head>
<body>

  <nav class="navbar">
    <div class="navbar-header"> <a href="#" class="logo">
            <img src="/images/fire-icon.png" alt="Eye on the Fire Logo"> <span class="logo-text">Eye on the Fire</span>
        </a>
        <button class="hamburger" id="hamburger-menu" aria-label="Toggle Menu">
            <span class="line"></span>
            <span class="line"></span>
            <span class="line"></span>
        </button>
    </div>
    <ul class="nav-menu" id="nav-menu">
        <li><a href="#map-section">Live Map</a></li>
        <li><a href="#about">Why Us</a></li>
        <li><a href="#prevention">Prevention</a></li>
        <li><a href="#community">Community</a></li>
    </ul>
  </nav>

  <header class="hero" id="home">
    <h1>Monitor Wildfires in Real-Time</h1>
    <p>Your premier destination for live interactive fire maps, updates, and safety information.</p>
    <a href="#map-section" class="cta-button">View Live Fire Map</a>
  </header>

  <section id="map-section" class="map-section">
    <div class="map-wrapper" id="map-wrapper">
        <div class="map-header">Interactive Wildfire Map</div>
        <div id="fire-map">
            <div id="map-loading-message" style="position:absolute; top:50%; left:50%; transform: translate(-50%, -50%); font-size: 1.2em; color: #555;">Loading map data...</div>
            <div id="map-error-message" style="position:absolute; top:50%; left:50%; transform: translate(-50%, -50%); font-size: 1.2em; color: red; display: none; text-align:center; background: rgba(255,255,255,0.8); padding: 15px; border-radius: 5px;"></div>
        </div>
    </div>
    <div id="geolocation-error" style="text-align: center; color: #b71c1c; margin-top: 10px; display: none;">Could not get your location. Showing default view.</div>
  </section>

  <section id="about" class="content-section">
    <div class="container">
      <h2>Why Choose Eye on the Fire?</h2>
      <p>We provide the most up-to-date and comprehensive wildfire information available, combining data from multiple trusted sources like NASA and NIFC. Our easy-to-use interactive map helps you stay informed and safe.</p>
      </div>
  </section>

  <section id="prevention" class="content-section">
    <div class="container">
      <h2>Fire Prevention Tips</h2>
      <p>Protect your home and community by following these essential fire prevention practices.</p>
      <div class="prevention-grid">
        <div class="prevention-item">
          <h3>Clear Defensible Space</h3>
          <p>Remove flammable vegetation, leaves, and debris from around your home (at least 30 feet).</p>
        </div>
        <div class="prevention-item">
          <h3>Maintain Roof & Gutters</h3>
          <p>Regularly clean roofs and gutters of pine needles, leaves, and other flammable materials.</p>
        </div>
        <div class="prevention-item">
          <h3>Choose Fire-Resistant Landscaping</h3>
          <p>Use native, drought-tolerant plants that are less likely to ignite easily.</p>
        </div>
        </div>
    </div>
  </section>

  <section id="community" class="content-section">
      <div class="container">
          <h2>Community Resources & Updates</h2>
          <p>Stay connected with local resources and see updates from affected areas.</p>
          <div class="cta-banner">
              <p>Find local emergency services and evacuation information: <a href="#" target="_blank" rel="noopener noreferrer">Local Authority Website</a></p> </div>
          <div class="gallery">
              <div class="gallery-item"><img src="/images/community-1.jpg" alt="Community effort example"></div> <div class="gallery-item"><img src="/images/community-2.jpg" alt="Firefighters working"></div>
              <div class="gallery-item"><img src="/images/community-3.jpg" alt="Landscape after fire"></div>
          </div>
      </div>
  </section>


  <footer>
    <div class="container">
      <p>&copy; 2025 Eye on the Fire. All Rights Reserved.</p>
      <p>
        <a href="#">Privacy Policy</a> | <a href="#">Terms of Service</a> | <a href="#">Contact Us</a>
      </p>
      <div class="social-icons">
        <a href="#" target="_blank" rel="noopener noreferrer" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
        <a href="#" target="_blank" rel="noopener noreferrer" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
        <a href="#" target="_blank" rel="noopener noreferrer" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
      </div>
    </div>
  </footer>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.fullscreen/2.0.0/Control.FullScreen.min.js" integrity="sha512-6FLNnFh+DOdXGqQG5j+1H+0+gQYNsY9m17+gPeN+x0QHONR9Xh0SgPzFTTe6P+mFFDRSLTClDdzGOZ/kDni2vw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>
    // ========================================================================
    // !!! CRITICAL SECURITY WARNING !!!
    // ========================================================================
    // THE API KEYS BELOW ARE CURRENTLY PLACEHOLDERS.
    // **DO NOT DEPLOY TO A PUBLIC SERVER WITH REAL KEYS HERE.**
    // These keys MUST be moved to a secure server-side environment (e.g., a backend API or serverless function)
    // BEFORE PUBLIC DEPLOYMENT.
    // Replace these placeholders with your REAL keys ONLY for LOCAL testing.
    // ========================================================================
    const NASA_API_KEY = 'd152217c8391eb5b0fbd242290527ae8'; // <-- !!! REPLACE FOR LOCAL TESTING ONLY !!! MOVE SERVER-SIDE FOR PRODUCTION !!!
    const AIRNOW_API_KEY = '54044855-7B0C-4023-BEE4-8B3FCA172DED';   // <-- !!! REPLACE FOR LOCAL TESTING ONLY !!! MOVE SERVER-SIDE FOR PRODUCTION !!!
    const OPENCAGE_API_KEY = 'a40b9e954e50458bbc09ca24e70201a1'; // <-- !!! REPLACE FOR LOCAL TESTING ONLY !!! MOVE SERVER-SIDE FOR PRODUCTION !!!

    // Map Variables
    let map;
    let fireLayer = L.layerGroup();
    let airQualityLayer = L.layerGroup();
    let nifcLayer = L.layerGroup();
    let nwsLayer = L.layerGroup();
    let showFires = true;
    let showAirQuality = false; // Default to off
    let showNIFC = true;
    let showNWS = true;

    // DOM Elements
    const hamburger = document.getElementById('hamburger-menu');
    const navMenu = document.getElementById('nav-menu');
    const mapLoadingMessage = document.getElementById('map-loading-message');
    const mapErrorMessage = document.getElementById('map-error-message');
    const geolocationErrorDiv = document.getElementById('geolocation-error');
    const mapWrapper = document.getElementById('map-wrapper');

    // Initial Map Load Function (called after Leaflet is ready)
    function initializeMap() {
      mapLoadingMessage.style.display = 'block'; // Show loading message
      mapErrorMessage.style.display = 'none';   // Hide error message
      geolocationErrorDiv.style.display = 'none'; // Hide geolocation error

      // Attempt Geolocation first
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            // Geolocation successful
            const userLat = position.coords.latitude;
            const userLon = position.coords.longitude;
            console.log('Geolocation successful:', userLat, userLon);
            // Focus map near Moorpark, CA (user's current location context)
            // You can adjust the zoom level (10 is relatively close)
            setupMap([34.2836, -118.8815], 10);
            loadInitialData(userLat, userLon); // Load data for user's actual location for accuracy
          },
          (error) => {
            // Geolocation failed or denied
            console.warn(`Geolocation error (${error.code}): ${error.message}`);
            geolocationErrorDiv.style.display = 'block'; // Show error message
            // Fallback to Moorpark, CA if geolocation fails
            const defaultLat = 34.2836;
            const defaultLon = -118.8815;
            setupMap([defaultLat, defaultLon], 9); // Slightly more zoomed out default
            loadInitialData(defaultLat, defaultLon); // Load data for default location
          },
          { timeout: 8000 } // Set a timeout for geolocation
        );
      } else {
        // Geolocation not supported by browser
        console.warn('Geolocation is not supported by this browser.');
        geolocationErrorDiv.textContent = 'Geolocation not supported by this browser. Showing default view.';
        geolocationErrorDiv.style.display = 'block';
        // Fallback to Moorpark, CA
        const defaultLat = 34.2836;
        const defaultLon = -118.8815;
        setupMap([defaultLat, defaultLon], 9);
        loadInitialData(defaultLat, defaultLon);
      }
    }

    // Setup Map Function
    function setupMap(centerCoords, zoomLevel) {
        map = L.map('fire-map', {
            center: centerCoords,
            zoom: zoomLevel,
            fullscreenControl: true, // Enable fullscreen control
        });

        // Tile Layer (OpenStreetMap)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors | Fire Data: NASA FIRMS, NIFC | AQI: AirNow | Weather: NWS'
        }).addTo(map);

        // Add initial layers
        fireLayer.addTo(map);
        nifcLayer.addTo(map);
        nwsLayer.addTo(map);
        // airQualityLayer is added based on toggle

        // Add Controls after map is initialized
        addMapControls();
        addMapLegend();

        // Handle map resize after fullscreen toggle
        map.on('fullscreenchange', function () {
            mapWrapper.classList.toggle('fullscreen', map.isFullscreen());
            map.invalidateSize(); // Important to resize map correctly
        });

        mapLoadingMessage.style.display = 'none'; // Hide loading message once map is set up
    }

    // Function to load all initial data
    function loadInitialData(lat, lon) {
        console.log('Loading initial data for:', lat, lon);
        loadNIFCFires(); // Load NIFC fires (usually nationwide)
        loadNWSWarnings(); // Load NWS warnings (usually nationwide/regional)
        loadFIRMSFires(lat, lon); // Load FIRMS hotspots (can be centered)
        // Optionally load AQI immediately if desired
        // loadAirQuality(lat, lon);

        // Set interval for periodic updates
        // Consider staggering intervals if needed
        // setInterval(loadFIRMSFires, 900000); // Refresh FIRMS every 15 mins
        // setInterval(loadNIFCFires, 1800000); // Refresh NIFC every 30 mins
        // setInterval(loadNWSWarnings, 3600000); // Refresh NWS every 60 mins
        // AQI might be better loaded on demand or when location changes significantly
    }

    // Add Custom Controls to the Map
    function addMapControls() {
        // --- Zoom/Location Control ---
        L.Control.Custom = L.Control.extend({
            onAdd: function(map) {
                const container = L.DomUtil.create('div', 'leaflet-control-custom leaflet-bar');
                container.innerHTML = `
                    <button id="zoom-ca" class="map-button" title="Zoom to California">Zoom CA</button>
                    <button id="zoom-us" class="map-button" title="Zoom to United States">Zoom US</button>
                    <button id="locate-me" class="map-button" title="Use My Location"><i class="fas fa-location-crosshairs"></i> My Location</button>
                `;
                L.DomEvent.disableClickPropagation(container); // Prevent map click when clicking control
                // Add event listeners
                L.DomEvent.on(container.querySelector('#zoom-ca'), 'click', zoomToCA);
                L.DomEvent.on(container.querySelector('#zoom-us'), 'click', zoomToUS);
                L.DomEvent.on(container.querySelector('#locate-me'), 'click', centerOnUserLocation);
                return container;
            },
            onRemove: function(map) {} // Cleanup if needed
        });
        new L.Control.Custom({ position: 'topleft' }).addTo(map);

        // --- Layer Toggle Control ---
         L.Control.LayerToggle = L.Control.extend({
            onAdd: function(map) {
                const container = L.DomUtil.create('div', 'leaflet-control-custom leaflet-bar');
                container.innerHTML = `
                    <button id="toggle-fires" class="map-button active" title="Toggle FIRMS/NIFC Layers"><i class="fas fa-fire"></i> Fires</button>
                    <button id="toggle-aqi" class="map-button" title="Toggle Air Quality Layer"><i class="fas fa-wind"></i> AQI</button>
                    <button id="toggle-nws" class="map-button active" title="Toggle NWS Alerts Layer"><i class="fas fa-cloud-sun-rain"></i> Weather</button>
                `;
                L.DomEvent.disableClickPropagation(container);
                L.DomEvent.on(container.querySelector('#toggle-fires'), 'click', toggleFireLayers);
                L.DomEvent.on(container.querySelector('#toggle-aqi'), 'click', toggleAirQuality);
                 L.DomEvent.on(container.querySelector('#toggle-nws'), 'click', toggleNWSLayer);
                return container;
            },
            onRemove: function(map) {}
        });
        new L.Control.LayerToggle({ position: 'topleft' }).addTo(map);

        // --- Zip Code Search Control ---
        L.Control.ZipSearch = L.Control.extend({
            onAdd: function(map) {
                const container = L.DomUtil.create('div', 'location-form leaflet-control'); // Use leaflet-control for default styling base
                container.innerHTML = `
                    <form id="location-form" style="display: flex; align-items: center; gap: 5px;">
                      <input type="text" id="zip-code" placeholder="Zip Code (US/CA)" required pattern="^(\\d{5}(-\\d{4})?|[A-Za-z]\\d[A-Za-z][ -]?\\d[A-Za-z]\\d)$" title="Enter 5-digit US zip or Canadian postal code (e.g., A1A 1A1)">
                      <button type="submit" title="Search by Zip Code"><i class="fas fa-search"></i></button>
                    </form>
                    <div class="disclosure">US/Canada Only</div>
                `;
                L.DomEvent.disableClickPropagation(container);
                L.DomEvent.on(container.querySelector('#location-form'), 'submit', handleZipSearch);
                return container;
            },
            onRemove: function(map) {}
        });
        new L.Control.ZipSearch({ position: 'topright' }).addTo(map);
    }

     // Add Map Legend
    function addMapLegend() {
        const legend = L.control({ position: 'bottomright' });
        legend.onAdd = function (map) {
            const div = L.DomUtil.create('div', 'info legend');
            div.innerHTML = `
                <h4>Legend</h4>
                <div><img src="/images/fire-icon.png" alt="FIRMS Icon" style="width: 18px; height: 18px; vertical-align: middle;"> FIRMS Hotspot</div>
                <div><img src="/images/nifc-fire.png" alt="NIFC Icon" style="width: 18px; height: 18px; vertical-align: middle;"> NIFC Incident</div>
                <div><span class="polygon" style="display: inline-block; vertical-align: middle;"></span> NWS Warning</div>
                <hr style="margin: 5px 0;">
                <strong>AQI (PM2.5)</strong><br>
                <div style="margin-top: 3px;"><i style="background: #00e400;"></i> Good (0-50)</div>
                <div><i style="background: #ffff00;"></i> Moderate (51-100)</div>
                <div><i style="background: #ff7e00;"></i> Unhealthy Sensitive (101-150)</div>
                <div><i style="background: #ff0000;"></i> Unhealthy (151-200)</div>
                <div><i style="background: #8f3f97;"></i> Very Unhealthy (201-300)</div>
                <div><i style="background: #7e0023;"></i> Hazardous (301+)</div>
            `;
            // TODO: Update icon paths as needed
            return div;
        };
        legend.addTo(map);
    }


    // --- Data Loading Functions ---

    // Load NASA FIRMS Fire Data
    async function loadFIRMSFires(lat, lon) {
        // TODO: Consider fetching based on map bounds (map.getBounds()) instead of a fixed area
        // const bounds = map.getBounds();
        // const bbox = `${bounds.getWest()},${bounds.getSouth()},${bounds.getEast()},${bounds.getNorth()}`;
        const source = 'VIIRS_SNPP_NRT'; // Or 'MODIS_NRT', 'VIIRS_NOAA20_NRT' etc.
        const lookbackDays = 1; // Check fires within the last 24 hours
        const area = 'USA'; // Use 'USA' or 'CANADA' or specific bbox
        const url = `https://firms.modaps.eosdis.nasa.gov/api/area/csv/${NASA_API_KEY}/${source}/${area}/${lookbackDays}`;
        // !!! THIS URL CONSTRUCTION SHOULD HAPPEN SERVER-SIDE FOR PRODUCTION!!!

        console.log("Fetching FIRMS data...");
        mapLoadingMessage.style.display = 'block'; // Show loading indicator

        try {
            // ** Direct API Call - FOR LOCAL TESTING ONLY **
            const response = await fetch(url);

            if (!response.ok) {
                throw new Error(`FIRMS API Error: ${response.status} ${response.statusText}`);
            }
            const csvData = await response.text();
            fireLayer.clearLayers(); // Clear previous FIRMS points

            const lines = csvData.trim().split('\\n');
            if (lines.length <= 1) {
                console.log("No active FIRMS hotspots found.");
                return; // No data or only header
            }
            const headers = lines[0].split(',');

            // Find indices (more robust than assuming fixed positions)
            const latIndex = headers.indexOf('latitude');
            const lonIndex = headers.indexOf('longitude');
            const brightIndex = headers.indexOf('bright_ti5'); // VIIRS I-Band 5 Brightness Temp
            const dateIndex = headers.indexOf('acq_date');
            const timeIndex = headers.indexOf('acq_time');
            const confidenceIndex = headers.indexOf('confidence');

            const fireIcon = L.icon({
                iconUrl: '/images/fire-icon.png', // TODO: Update path
                iconSize: [25, 25],
                iconAnchor: [12, 25],
                popupAnchor: [0, -25]
            });

            // Optimization: Consider using L.markerClusterGroup() if performance is an issue
            // const clusterGroup = L.markerClusterGroup();

            lines.slice(1).forEach(line => {
                const values = line.split(',');
                const lat = parseFloat(values[latIndex]);
                const lon = parseFloat(values[lonIndex]);
                const brightness = values[brightIndex];
                const date = values[dateIndex];
                const time = values[timeIndex].padStart(4, '0'); // Format time HHMM
                const confidence = values[confidenceIndex];

                if (!isNaN(lat) && !isNaN(lon)) {
                   const marker = L.marker([lat, lon], { icon: fireIcon })
                      .bindPopup(`<b>FIRMS Hotspot (${confidence})</b><br>Detected: ${date} ${time.substring(0,2)}:${time.substring(2)}<br>Brightness: ${brightness} K`);
                   fireLayer.addLayer(marker); // Add to layer group
                   // clusterGroup.addLayer(marker); // Or add to cluster group
                }
            });
             console.log(`Added ${lines.length - 1} FIRMS points.`);
             // map.addLayer(clusterGroup); // Add cluster group to map if using

        } catch (error) {
            console.error('Error fetching or processing FIRMS data:', error);
            displayMapError('Could not load FIRMS fire data. Please try again later.');
        } finally {
            mapLoadingMessage.style.display = 'none';
        }
    }

    // Load NIFC Fire Data
    async function loadNIFCFires() {
        const url = 'https://services3.arcgis.com/T4QMspbfLg3qTGWY/arcgis/rest/services/CY_WildlandFire_Locations_ToDate/FeatureServer/0/query?where=1%3D1&outFields=IncidentName,FireDiscoveryDateTime,InitialLatitude,InitialLongitude,PercentContained,CalculatedAcres,EstimatedCostToDate&outSR=4326&f=json';
        // !!! CONSIDER MOVING THIS FETCH SERVER-SIDE for stability/rate-limiting !!!

        console.log("Fetching NIFC data...");
         mapLoadingMessage.style.display = 'block';

        try {
            // ** Direct API Call **
            const response = await fetch(url);
             if (!response.ok) throw new Error(`NIFC API Error: ${response.status}`);
            const data = await response.json();
            nifcLayer.clearLayers();

            const nifcIcon = L.icon({
                iconUrl: '/images/nifc-fire.png', // TODO: Update path
                iconSize: [30, 30],
                iconAnchor: [15, 30],
                popupAnchor: [0, -30]
            });

            if (data.features && data.features.length > 0) {
                data.features.forEach(feature => {
                    const props = feature.attributes;
                    const geom = feature.geometry;
                    if (geom && geom.y && geom.x) {
                         const discoveredDate = props.FireDiscoveryDateTime ? new Date(props.FireDiscoveryDateTime).toLocaleString() : 'N/A';
                         const containment = props.PercentContained !== null ? `${props.PercentContained}%` : 'N/A';
                         const acres = props.CalculatedAcres !== null ? Math.round(props.CalculatedAcres).toLocaleString() : 'N/A';
                         const cost = props.EstimatedCostToDate !== null ? `$${Math.round(props.EstimatedCostToDate).toLocaleString()}` : 'N/A';

                         const marker = L.marker([geom.y, geom.x], { icon: nifcIcon })
                            .bindPopup(`<b>${props.IncidentName || 'NIFC Incident'}</b><br>Discovered: ${discoveredDate}<br>Acres: ${acres}<br>Containment: ${containment}<br>Est. Cost: ${cost}`);
                         nifcLayer.addLayer(marker);
                    }
                });
                console.log(`Added ${data.features.length} NIFC points.`);
            } else {
                 console.log("No active NIFC incidents found.");
            }

        } catch (error) {
            console.error('Error fetching NIFC data:', error);
             displayMapError('Could not load NIFC fire data.');
        } finally {
             mapLoadingMessage.style.display = 'none';
        }
    }

    // Load Air Quality Data (Example for a specific point)
    async function loadAirQuality(lat, lon) {
        const date = new Date().toISOString().split('T')[0]; // Today's date YYYY-MM-DD
        const distance = 50; // Search radius in miles
        const url = `https://www.airnowapi.org/aq/forecast/latLong/?format=application/json&latitude=${lat}&longitude=${lon}&date=${date}&distance=${distance}&API_KEY=${AIRNOW_API_KEY}`;
        // !!! THIS URL CONSTRUCTION SHOULD HAPPEN SERVER-SIDE FOR PRODUCTION!!!

        console.log(`Fetching AQI data for ${lat}, ${lon}...`);
        mapLoadingMessage.style.display = 'block';

        try {
             // ** Direct API Call - FOR LOCAL TESTING ONLY **
            const response = await fetch(url);
             if (!response.ok) throw new Error(`AirNow API Error: ${response.status}`);
            const data = await response.json();
            airQualityLayer.clearLayers();

            if (data && data.length > 0) {
                // Find PM2.5 data (usually the most relevant for smoke)
                const pm25Data = data.find(item => item.ParameterName === 'PM2.5');

                if (pm25Data) {
                    const aqi = pm25Data.AQI;
                    const category = pm25Data.Category.Name;
                    const reportingArea = pm25Data.ReportingArea;
                    const stateCode = pm25Data.StateCode;

                    const aqiColor = getAQIColor(aqi);
                    const radius = 10 + aqi / 5; // Example: radius based on AQI value

                    const circle = L.circle([pm25Data.Latitude, pm25Data.Longitude], {
                        color: aqiColor,
                        fillColor: aqiColor,
                        fillOpacity: 0.5,
                        radius: radius * 100 // Convert arbitrary radius to meters approx.
                    }).bindPopup(`<b>AQI for ${reportingArea}, ${stateCode}</b><br>PM2.5: ${aqi} (${category})`);
                    airQualityLayer.addLayer(circle);
                    console.log(`Added AQI point: ${aqi} (${category})`);
                } else {
                    console.log("No PM2.5 AQI data found for this location/time.");
                     // Optionally add a marker indicating no data
                     const noDataMarker = L.marker([lat, lon]).bindPopup("No PM2.5 AQI data available.");
                     airQualityLayer.addLayer(noDataMarker);
                }

            } else {
                console.log("No AQI data returned from API.");
                const noDataMarker = L.marker([lat, lon]).bindPopup("No AQI data available.");
                airQualityLayer.addLayer(noDataMarker);
            }
        } catch (error) {
            console.error('Error fetching Air Quality data:', error);
             displayMapError('Could not load Air Quality data.');
        } finally {
            mapLoadingMessage.style.display = 'none';
        }
    }

    // Load NWS Fire Weather Warnings
    async function loadNWSWarnings() {
        const url = 'https://api.weather.gov/alerts/active?event=Fire%20Weather%20Watch,Red%20Flag%20Warning';
        // Standard NWS API endpoint - generally safe to call client-side but consider server-side for robustness.

        console.log("Fetching NWS warnings...");
        mapLoadingMessage.style.display = 'block';

        try {
            // ** Direct API Call **
            const response = await fetch(url, { headers: { 'Accept': 'application/geo+json' } });
            if (!response.ok) throw new Error(`NWS API Error: ${response.status}`);
            const data = await response.json();
            nwsLayer.clearLayers();

            if (data.features && data.features.length > 0) {
                const nwsStyle = {
                    color: "#ff4500", // OrangeRed
                    weight: 2,
                    opacity: 0.7,
                    fillColor: "#ff4500",
                    fillOpacity: 0.2
                };

                L.geoJSON(data.features, {
                    style: nwsStyle,
                    onEachFeature: function (feature, layer) {
                        if (feature.properties) {
                           layer.bindPopup(`<b>${feature.properties.event}</b><br>${feature.properties.headline}<br>Effective: ${new Date(feature.properties.effective).toLocaleString()}<br>Expires: ${new Date(feature.properties.expires).toLocaleString()}`);
                        }
                    }
                }).addTo(nwsLayer);
                console.log(`Added ${data.features.length} NWS warning areas.`);
            } else {
                console.log("No active NWS fire weather warnings found.");
            }
        } catch (error) {
            console.error('Error fetching NWS warnings:', error);
             displayMapError('Could not load NWS weather warnings.');
        } finally {
             mapLoadingMessage.style.display = 'none';
        }
    }


    // --- Control Handlers & Helper Functions ---

    // Handle Hamburger Menu Toggle
    hamburger.addEventListener('click', () => {
      hamburger.classList.toggle('active');
      navMenu.classList.toggle('active');
    });

    // Close mobile menu when a link is clicked
    navMenu.querySelectorAll('a').forEach(link => {
        link.addEventListener('click', () => {
            if (hamburger.classList.contains('active')) {
                hamburger.classList.remove('active');
                navMenu.classList.remove('active');
            }
        });
    });

    // Center map on user's current location
    function centerOnUserLocation() {
      mapLoadingMessage.style.display = 'block';
      geolocationErrorDiv.style.display = 'none';
      if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
              (position) => {
                  const userLat = position.coords.latitude;
                  const userLon = position.coords.longitude;
                  map.setView([userLat, userLon], 10);
                  console.log('Recentered on user location:', userLat, userLon);
                  // Optionally reload data centered on new location
                  // loadAirQuality(userLat, userLon); // Example: Reload AQI
                   mapLoadingMessage.style.display = 'none';
              },
              (error) => {
                  console.warn(`Geolocation error (${error.code}): ${error.message}`);
                  geolocationErrorDiv.textContent = 'Could not get current location. Please enable location services.';
                  geolocationErrorDiv.style.display = 'block';
                   mapLoadingMessage.style.display = 'none';
              },
              { timeout: 8000 }
          );
      } else {
          geolocationErrorDiv.textContent = 'Geolocation is not supported by this browser.';
          geolocationErrorDiv.style.display = 'block';
           mapLoadingMessage.style.display = 'none';
      }
    }

    // Zoom map to California
    function zoomToCA() { map.setView([36.7783, -119.4179], 6); }

    // Zoom map to Contiguous US
    function zoomToUS() { map.setView([37.0902, -95.7129], 5); }

    // Toggle combined Fire Layers (FIRMS + NIFC)
    function toggleFireLayers() {
        const btn = document.getElementById('toggle-fires');
        showFires = !showFires;
        if (showFires) {
            fireLayer.addTo(map);
            nifcLayer.addTo(map);
            btn.classList.add('active');
            btn.innerHTML = '<i class="fas fa-fire"></i> Fires';
        } else {
            fireLayer.remove();
            nifcLayer.remove();
            btn.classList.remove('active');
             btn.innerHTML = '<i class="far fa-eye-slash"></i> Fires Off'; // Indicate off state
        }
    }

    // Toggle Air Quality Layer
    function toggleAirQuality() {
        const btn = document.getElementById('toggle-aqi');
        showAirQuality = !showAirQuality;
        if (showAirQuality) {
            airQualityLayer.addTo(map);
            btn.classList.add('active');
            btn.innerHTML = '<i class="fas fa-wind"></i> AQI';
            // Load AQI data if not already loaded or if map moved significantly
            const center = map.getCenter();
            loadAirQuality(center.lat, center.lng);
        } else {
            airQualityLayer.remove();
            btn.classList.remove('active');
            btn.innerHTML = '<i class="far fa-eye-slash"></i> AQI Off';
        }
    }

    // Toggle NWS Layer
    function toggleNWSLayer() {
        const btn = document.getElementById('toggle-nws');
        showNWS = !showNWS;
        if (showNWS) {
            nwsLayer.addTo(map);
            btn.classList.add('active');
             btn.innerHTML = '<i class="fas fa-cloud-sun-rain"></i> Weather';
        } else {
            nwsLayer.remove();
            btn.classList.remove('active');
            btn.innerHTML = '<i class="far fa-eye-slash"></i> Weather Off';
        }
    }


    // Handle Zip Code Search Form Submission
    async function handleZipSearch(event) {
        event.preventDefault(); // Prevent default form submission
        const zipInput = document.getElementById('zip-code');
        const zip = zipInput.value.trim();

        // Basic validation (allows 5-digit US or A1A 1A1 Canadian format)
        const zipRegex = /^(\d{5}(-\d{4})?|[A-Za-z]\d[A-Za-z][ -]?\d[A-Za-z]\d)$/;
        if (!zipRegex.test(zip)) {
            alert('Please enter a valid USA (e.g., 90210) or Canadian (e.g., V6B 2W9) zip/postal code.');
            return;
        }

        console.log(`Geocoding zip code: ${zip}...`);
        mapLoadingMessage.style.display = 'block';

        // Use OpenCageData for geocoding
        const url = `https://api.opencagedata.com/geocode/v1/json?q=${encodeURIComponent(zip)}&key=${OPENCAGE_API_KEY}&countrycode=us,ca&limit=1`;
        // !!! THIS URL CONSTRUCTION SHOULD HAPPEN SERVER-SIDE FOR PRODUCTION!!!

        try {
            // ** Direct API Call - FOR LOCAL TESTING ONLY **
            const response = await fetch(url);
             if (!response.ok) throw new Error(`Geocoding API Error: ${response.status}`);
            const data = await response.json();

            if (data.results && data.results.length > 0) {
                const { lat, lng } = data.results[0].geometry;
                map.setView([lat, lng], 10); // Zoom to the location
                console.log(`Zip code ${zip} found at:`, lat, lng);
                // Load data relevant to the new location
                loadAirQuality(lat, lng); // Reload AQI for the searched area
                // Optionally reload FIRMS if using bbox
                // loadFIRMSFires(lat, lng);
                 zipInput.value = ''; // Clear input field on success
            } else {
                alert(`Zip code "${zip}" not found in USA or Canada. Please try again.`);
            }
        } catch (error) {
            console.error('Geocoding Error:', error);
            alert('Error finding location for the entered zip code. Please try again.');
        } finally {
            mapLoadingMessage.style.display = 'none';
        }
    }

    // Get color based on AQI value
    function getAQIColor(aqi) {
        if (aqi <= 50) return '#00e400'; // Good - Green
        if (aqi <= 100) return '#ffff00'; // Moderate - Yellow
        if (aqi <= 150) return '#ff7e00'; // Unhealthy for Sensitive Groups - Orange
        if (aqi <= 200) return '#ff0000'; // Unhealthy - Red
        if (aqi <= 300) return '#8f3f97'; // Very Unhealthy - Purple
        return '#7e0023'; // Hazardous - Maroon
    }

    // Display a persistent error message on the map
    function displayMapError(message) {
        mapErrorMessage.textContent = message;
        mapErrorMessage.style.display = 'block';
        // Optionally hide after a timeout
        // setTimeout(() => { mapErrorMessage.style.display = 'none'; }, 10000);
    }

    // --- Initialization ---
    // Use DOMContentLoaded to ensure the DOM is ready before trying to initialize the map
    document.addEventListener('DOMContentLoaded', initializeMap);

  </script>

</body>
</html>
