<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="description" content="Real-time wildfire tracking and safety alerts for California. Professional-grade fire intelligence powered by NASA satellite data.">
    <title>Eye on the Fire | Real-Time Wildfire Tracking & Safety Platform</title>
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-T8RE6KDBEW"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-T8RE6KDBEW', {
        anonymize_ip: true,
        cookie_flags: 'SameSite=None;Secure'
      });
    </script>
    
    <!-- Critical performance optimizations -->
    <link rel="preload" href="images/eyeonthefire-logo.png" as="image">
    <link rel="preload" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" as="style">
    <link rel="preload" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" as="script">
    <link rel="preload" href="assets/css/styles.css" as="style">
    
    <!-- Critical CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="assets/css/styles.css">
    
    <!-- Favicon and app icons -->
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="images/eyeonthefire-logo.png">
    <link rel="manifest" href="manifest.json">
    
    <!-- Mobile-specific optimizations -->
    <meta name="theme-color" content="#dc2626">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Eye on the Fire">
    
    <!-- Open Graph meta tags -->
    <meta property="og:title" content="Eye on the Fire - Real-Time Wildfire Tracking">
    <meta property="og:description" content="Professional wildfire intelligence platform powered by NASA satellite data">
    <meta property="og:image" content="https://eyeonthefire.com/images/eyeonthefire-logo.png">
    <meta property="og:url" content="https://eyeonthefire.com">
    <meta property="og:type" content="website">
    
    <!-- Emergency service structured data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "Eye on the Fire",
        "description": "Real-time wildfire tracking and safety alerts",
        "applicationCategory": "Emergency Services",
        "operatingSystem": "Web, iOS, Android",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "USD"
        },
        "logo": "https://eyeonthefire.com/images/eyeonthefire-logo.png"
    }
    </script>

    <!-- Inline critical CSS for faster loading -->
    <style>
        /* Critical path styles for immediate render */
        body { 
            margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            background: #f3f4f6; 
        }
        
        .loading-screen { 
            position: fixed; 
            inset: 0; 
            background: #111827; 
            color: white; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            z-index: 9999; 
        }
        
        .map-container { 
            position: fixed; 
            top: 60px; 
            left: 0; 
            right: 0; 
            bottom: 0; 
        }
        
        .fire-map { 
            width: 100%; 
            height: 100%; 
        }
        
        /* Prevent flash of unstyled content */
        .main-nav, .map-controls { 
            opacity: 0; 
            animation: fadeIn 0.3s ease-out 0.1s forwards; 
        }
        
        @keyframes fadeIn { 
            to { opacity: 1; } 
        }
    </style>
</head>
<body>
    <!-- Loading Screen with Performance Monitoring -->
    <div id="loading-screen" class="loading-screen" aria-hidden="true">
        <div class="loading-content">
            <img src="images/eyeonthefire-logo.png" alt="Eye on the Fire" class="loading-logo" width="80" height="80">
            <h2>Eye on the Fire</h2>
            <p>Loading real-time fire intelligence...</p>
            <div class="loading-bar">
                <div class="loading-progress"></div>
            </div>
            <div class="loading-status" id="loadingStatus">Initializing...</div>
        </div>
    </div>

    <!-- Location Permission Banner -->
    <div id="location-banner" class="location-banner" role="banner" aria-live="polite" style="display: none;">
        <div class="banner-content">
            <div class="banner-icon">üìç</div>
            <div class="banner-text">
                <h3>Get Personalized Fire Alerts</h3>
                <p>Enable location access to see fires near you and receive distance-based warnings</p>
            </div>
            <div class="banner-actions">
                <button class="banner-button primary" onclick="requestLocationAccess()">Enable Location</button>
                <button class="banner-button secondary" onclick="dismissLocationBanner()">Maybe Later</button>
            </div>
        </div>
    </div>

    <!-- Emergency Alert Banner -->
    <div id="emergency-alert" class="emergency-alert" role="alert" aria-live="assertive" style="display: none;">
        <div class="alert-content">
            <span class="alert-icon">‚ö†Ô∏è</span>
            <span class="alert-text"></span>
            <button class="alert-close" onclick="closeEmergencyAlert()" aria-label="Close alert">√ó</button>
        </div>
    </div>

    <!-- Main Navigation -->
    <nav class="main-nav" role="navigation" aria-label="Main navigation">
        <div class="nav-brand">
            <img src="images/eyeonthefire-logo.png" alt="Eye on the Fire" class="brand-logo" width="32" height="32">
            <span class="brand-text">Eye on the Fire</span>
        </div>
        
        <div class="nav-status">
            <div class="live-indicator">
                <span class="live-dot" aria-hidden="true"></span>
                <span class="live-text">Live</span>
            </div>
        </div>
        
        <button class="nav-toggle" id="navToggle" aria-expanded="false" aria-controls="navMenu" aria-label="Toggle navigation menu">
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
        </button>
        
        <div class="nav-menu" id="navMenu" role="menu">
            <div class="nav-section">
                <h3 class="nav-section-title">Fire Intelligence</h3>
                <a href="index.html" class="nav-link active" role="menuitem">
                    <span class="nav-icon">üó∫Ô∏è</span>
                    <span>Live Map</span>
                </a>
                <a href="safety.html" class="nav-link" role="menuitem">
                    <span class="nav-icon">üõ°Ô∏è</span>
                    <span>Safety</span>
                </a>
                <a href="prevention.html" class="nav-link" role="menuitem">
                    <span class="nav-icon">üåø</span>
                    <span>Prevention</span>
                </a>
                <a href="alerts" class="nav-link" role="menuitem">
                    <span class="nav-icon">üö®</span>
                    <span>Alerts</span>
                </a>
            </div>
            
            <div class="nav-section">
                <h3 class="nav-section-title">Information</h3>
                <a href="about.html" class="nav-link" role="menuitem">
                    <span class="nav-icon">‚ÑπÔ∏è</span>
                    <span>About</span>
                </a>
                <a href="support" class="nav-link" role="menuitem">
                    <span class="nav-icon">üìû</span>
                    <span>Support</span>
                </a>
            </div>
            
            <div class="nav-section">
                <h3 class="nav-section-title">Account</h3>
                <a href="settings" class="nav-link" role="menuitem">
                    <span class="nav-icon">‚öôÔ∏è</span>
                    <span>Settings</span>
                </a>
            </div>
        </div>
    </nav>

    <!-- Map Container with Performance Optimizations -->
    <main class="map-container" role="main">
        <div id="map" class="fire-map" aria-label="Interactive fire tracking map"></div>
        
        <!-- Mobile-Optimized Map Controls -->
        <div class="map-controls" role="toolbar" aria-label="Map controls">
            <!-- Compact Status Panel for Mobile -->
            <div class="status-panel" role="complementary" aria-label="Fire status information">
                <div class="status-header">
                    <h2 class="status-title">
                        <span class="status-icon">üî•</span>
                        <span class="count-number" id="fireCount">--</span>
                        <span class="count-label">Active</span>
                    </h2>
                    <div class="update-time">
                        <span id="lastUpdate">Loading...</span>
                    </div>
                </div>
            </div>

            <!-- Quick Action Buttons -->
            <div class="quick-actions" role="group" aria-label="Quick actions">
                <button class="action-button location-btn" id="findLocationBtn" onclick="findUserLocation()" aria-label="Find fires near my location" title="Find fires near me">
                    <span class="button-icon">üìç</span>
                    <span class="button-label">Near Me</span>
                </button>
                
                <button class="action-button" id="showAllBtn" onclick="showAllFires()" aria-label="Show all active fires" title="Show all fires">
                    <span class="button-icon">üî•</span>
                    <span class="button-label">All Fires</span>
                </button>
                
                <button class="action-button" id="refreshBtn" onclick="refreshFireData()" aria-label="Refresh fire data" title="Refresh data">
                    <span class="button-icon">üîÑ</span>
                    <span class="button-label">Refresh</span>
                </button>
            </div>
        </div>

        <!-- Expandable Layer Controls -->
        <div class="layer-panel" id="layerPanel">
            <button class="layer-toggle-btn" onclick="toggleLayerPanel()" aria-expanded="false" aria-controls="layerControls">
                <span class="toggle-icon">‚öôÔ∏è</span>
                <span class="toggle-text">Layers</span>
            </button>
            
            <div class="layer-controls" id="layerControls" role="group" aria-label="Map layer controls" style="display: none;">
                <div class="layer-options">
                    <label class="layer-option">
                        <input type="checkbox" id="satelliteHotspotsLayer" checked aria-describedby="satellite-help">
                        <span class="option-slider"></span>
                        <span class="option-label">Satellite Data</span>
                    </label>
                    
                    <label class="layer-option">
                        <input type="checkbox" id="weatherLayer" aria-describedby="weather-help">
                        <span class="option-slider"></span>
                        <span class="option-label">Weather</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Mobile-Optimized Nearby Fires Panel -->
        <div class="nearby-panel" id="nearbyPanel" role="complementary" aria-label="Nearby fires information" style="display: none;">
            <div class="panel-header">
                <h3 class="panel-title">
                    <span class="panel-icon">üìç</span>
                    Fires Near You
                </h3>
                <button class="panel-close" onclick="closeNearbyPanel()" aria-label="Close nearby fires panel">√ó</button>
            </div>
            
            <div class="nearby-content">
                <div class="user-location">
                    <span class="location-icon">üìç</span>
                    <span class="location-text" id="userLocationText">Determining location...</span>
                </div>
                
                <div class="nearby-list" id="nearbyList" role="list">
                    <!-- Populated dynamically -->
                </div>
                
                <div class="panel-footer">
                    <button class="footer-button" onclick="refreshNearbyFires()">
                        <span class="button-icon">üîÑ</span>
                        Update Location
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Mobile-Optimized Fire Detail Modal -->
    <div class="fire-modal" id="fireModal" role="dialog" aria-modal="true" aria-labelledby="fireModalTitle" style="display: none;">
        <div class="modal-backdrop" onclick="closeFireModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="fireModalTitle">
                    <img src="images/eyeonthefire-logo.png" alt="" class="modal-logo" width="24" height="24">
                    Fire Details
                </h2>
                <button class="modal-close" onclick="closeFireModal()" aria-label="Close fire details">√ó</button>
            </div>
            
            <div class="modal-body" id="fireModalBody">
                <!-- Populated dynamically -->
            </div>
        </div>
    </div>

    <!-- Mobile-Optimized Footer -->
    <footer class="site-footer" role="contentinfo">
        <div class="footer-content">
            <div class="footer-section">
                <p class="footer-text">NASA FIRMS ‚Ä¢ OpenStreetMap ‚Ä¢ Real-time data</p>
                <p class="footer-disclaimer">Emergency: Call 911</p>
            </div>
        </div>
    </footer>

    <!-- Accessibility helpers -->
    <div id="satellite-help" class="sr-only">Shows real-time fire hotspots detected by NASA satellites</div>
    <div id="weather-help" class="sr-only">Displays weather conditions affecting fire behavior</div>

    <!-- Performance-optimized script loading -->
    <script>
        // Performance monitoring
        const perfStart = performance.now();
        
        // Update loading status
        function updateLoadingStatus(status) {
            const statusEl = document.getElementById('loadingStatus');
            if (statusEl) statusEl.textContent = status;
        }
        
        // Preload critical scripts
        updateLoadingStatus('Loading map engine...');
    </script>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        updateLoadingStatus('Initializing application...');
    </script>
    <script src="assets/js/app.js" defer></script>

    <!-- Service Worker with offline support -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('SW registered successfully');
                        updateLoadingStatus('Ready for offline use');
                    })
                    .catch(error => {
                        console.log('SW registration failed:', error);
                    });
            });
        }
        
        // Performance tracking
        window.addEventListener('load', () => {
            const loadTime = performance.now() - perfStart;
            console.log(`Page loaded in ${loadTime.toFixed(2)}ms`);
            
            if (window.gtag) {
                gtag('event', 'page_view', {
                    page_title: 'Live Fire Map',
                    page_location: window.location.href,
                    page_load_time: Math.round(loadTime)
                });
                
                gtag('event', 'timing_complete', {
                    name: 'page_load',
                    value: Math.round(loadTime)
                });
            }
        });
        
        // Location permission banner logic
        function showLocationBanner() {
            if (!localStorage.getItem('locationBannerDismissed') && !localStorage.getItem('locationPermissionAsked')) {
                setTimeout(() => {
                    const banner = document.getElementById('location-banner');
                    if (banner) {
                        banner.style.display = 'block';
                        banner.setAttribute('aria-hidden', 'false');
                    }
                }, 3000); // Show after 3 seconds
            }
        }
        
        function requestLocationAccess() {
            localStorage.setItem('locationPermissionAsked', 'true');
            dismissLocationBanner();
            
            // Trigger the location request through the main app
            if (window.findUserLocation) {
                window.findUserLocation();
            }
            
            // Track user engagement
            if (window.gtag) {
                gtag('event', 'location_permission_requested', {
                    event_category: 'User Engagement',
                    event_label: 'Banner CTA'
                });
            }
        }
        
        function dismissLocationBanner() {
            const banner = document.getElementById('location-banner');
            if (banner) {
                banner.style.display = 'none';
                banner.setAttribute('aria-hidden', 'true');
                localStorage.setItem('locationBannerDismissed', 'true');
            }
            
            // Track dismissal
            if (window.gtag) {
                gtag('event', 'location_banner_dismissed', {
                    event_category: 'User Engagement'
                });
            }
        }
        
        function toggleLayerPanel() {
            const panel = document.getElementById('layerControls');
            const button = document.querySelector('.layer-toggle-btn');
            const isOpen = panel.style.display !== 'none';
            
            panel.style.display = isOpen ? 'none' : 'block';
            button.setAttribute('aria-expanded', !isOpen);
        }
        
        // Initialize location banner
        document.addEventListener('DOMContentLoaded', showLocationBanner);
        
        // Optimize for mobile performance
        if ('connection' in navigator) {
            const connection = navigator.connection;
            if (connection.effectiveType === 'slow-2g' || connection.effectiveType === '2g') {
                // Reduce update frequency on slow connections
                window.SLOW_CONNECTION = true;
            }
        }
    </script>
</body>
</html>
