<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Eye on the Fire - Premier Interactive Fire Map & Live Updates</title>
  <meta name="description" content="Eye on the Fire is your premier destination to monitor active wildfires near you with our interactive live map. Get real-time updates, safety tips, and community insights instantly.">
  <meta name="keywords" content="interactive fire map, live wildfire updates, fires near me, real-time fire monitoring, fire safety, Eye on the Fire">
  <meta name="author" content="Eye on the Fire Team">
  <meta name="robots" content="index, follow">
  <link rel="canonical" href="https://eyeonthefire.com/"> <meta property="og:title" content="Eye on the Fire - Premier Interactive Fire Map">
  <meta property="og:description" content="Monitor active wildfires near you with Eye on the Fireâ€™s interactive live map. Stay updated with real-time fire data and safety resources.">
  <meta property="og:url" content="https://eyeonthefire.com/">
  <meta property="og:image" content="images/hero-bg.jpg"> <meta property="og:type" content="website">
  <meta name="twitter:card" content="summary_large_image">

  <link rel="shortcut icon" href="favicon/favicon.ico" type="image/x-icon">
  <link rel="icon" type="image/png" href="favicon/favicon-96x96.png" sizes="96x96">
  <link rel="apple-touch-icon" href="favicon/apple-touch-icon.png" sizes="180x180">
  <meta name="apple-mobile-web-app-title" content="eyeonthefire">
  <link rel="manifest" href="favicon/site.webmanifest">

  <script async src="https://www.googletagmanager.com/gtag/js?id=G-T8RE6KDBEW"></script> <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-T8RE6KDBEW'); // TODO: Replace with your GA ID
  </script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.fullscreen/2.0.0/Control.FullScreen.min.css" integrity="sha512-DRkMa+fn898M1uc6s9JZeztUoXN6viuHsXmh/pgz3jG6a77YWO3U3QYEjLoqbxOeclc2NunWfMTya4Y5twXAKA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.1/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.1/dist/MarkerCluster.Default.css" />


  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Open+Sans:wght@300;400&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="styles.css">

</head>
<body>

  <nav class="navbar">...</nav>
  <header class="hero" id="home">...</header>
  <section id="map-section" class="map-section">...</section>
  <section id="about" class="content-section">...</section>
  <section id="prevention" class="content-section">...</section>
  <section id="community" class="content-section">...</section>
  <footer>...</footer>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.fullscreen/2.0.0/Control.FullScreen.min.js" integrity="sha512-c6ydt5Rypa1ptlnH2U1u+JybARYppbD1qxgythCI4pJ9EOfNYEWlLBjxBX926O3tq5p4Aw5GTY68vT0FdKbG3w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.1/dist/leaflet.markercluster.js" integrity="sha384-XIxtt9QvAUZPZZsXyXG9PnkWRD8T7v/5G33jJ58L7NzmHS+U52I0eAv6L81dwL44" crossorigin=""></script>


  <script>
    console.log("[Script] Main script block started.");

    // ========================================================================
    // !!! CRITICAL SECURITY WARNING !!!
    // API KEYS ARE CURRENTLY EXPOSED CLIENT-SIDE. MOVE SERVER-SIDE BEFORE PRODUCTION.
    // ========================================================================
    const NASA_API_KEY = 'd152217c8391eb5b0fbd242290527ae8'; // !!! MOVE SERVER-SIDE !!!
    const AIRNOW_API_KEY = '54044855-7B0C-4023-BEE4-8B3FCA172DED';   // !!! MOVE SERVER-SIDE !!!
    const OPENCAGE_API_KEY = 'a40b9e954e50458bbc09ca24e70201a1'; // !!! MOVE SERVER-SIDE !!!

    // Map Variables
    let map;
    // Use layer groups for non-clustered data
    let airQualityLayer = L.layerGroup();
    let nwsLayer = L.layerGroup();
    // Use specific cluster groups for clustered data
    let firmsClusterGroup; // Will hold the FIRMS cluster layer
    let nifcClusterGroup = L.layerGroup(); // Keep NIFC as layer group for now, or change to cluster later

    let showFires = true;
    let showAirQuality = false;
    let showNIFC = true; // Control visibility of NIFC layer/cluster
    let showNWS = true;

    // DOM Elements
    const hamburger = document.getElementById('hamburger-menu');
    const navMenu = document.getElementById('nav-menu');
    const mapLoadingMessage = document.getElementById('map-loading-message');
    const mapErrorMessage = document.getElementById('map-error-message');
    const geolocationErrorDiv = document.getElementById('geolocation-error');
    const mapWrapper = document.getElementById('map-wrapper');

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', initializeMap);

    // --- Function Definitions ---
    function addMapControls() { /* ... same code ... */ }
    function addMapLegend() { /* ... same code ... */ }

    // --- Core Functions ---
    function initializeMap() {
      console.log("[Init] Initializing map...");
      mapLoadingMessage.style.display = 'block';
      mapErrorMessage.style.display = 'none';
      geolocationErrorDiv.style.display = 'none';

      try {
        console.log('[Init] Checking navigator.geolocation:', typeof navigator.geolocation);
        if (navigator.geolocation) {
          console.log("[Init] Attempting geolocation...");
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const userLat = position.coords.latitude;
              const userLon = position.coords.longitude;
              console.log('[Init] Geolocation successful:', userLat, userLon);
              setupMap([userLat, userLon], 10);
              loadInitialData(userLat, userLon);
            },
            (error) => {
              console.warn(`[Init] Geolocation error (${error.code}): ${error.message}`);
              const defaultLat = 37.0902; const defaultLon = -95.7129; const defaultZoom = 5;
              geolocationErrorDiv.textContent = `Geolocation failed: ${error.message}. Showing default US view.`;
              geolocationErrorDiv.style.display = 'block';
              console.log("[Init] Geolocation failed, setting up map with default US view.");
              setupMap([defaultLat, defaultLon], defaultZoom);
              loadInitialData(defaultLat, defaultLon);
            },
            { timeout: 8000 }
          );
        } else {
          console.warn('[Init] Geolocation is not supported by this browser.');
          const defaultLat = 37.0902; const defaultLon = -95.7129; const defaultZoom = 5;
          geolocationErrorDiv.textContent = 'Geolocation not supported. Showing default US view.';
          geolocationErrorDiv.style.display = 'block';
          console.log("[Init] Geolocation not supported, setting up map with default US view.");
          setupMap([defaultLat, defaultLon], defaultZoom);
          loadInitialData(defaultLat, defaultLon);
        }
      } catch (geoError) {
          console.error("[Init] Error accessing or using geolocation:", geoError);
          const defaultLat = 37.0902; const defaultLon = -95.7129; const defaultZoom = 5;
          geolocationErrorDiv.textContent = 'Could not access location services. Showing default US view.';
          geolocationErrorDiv.style.display = 'block';
          console.error("[Init] Falling back to default US view due to geolocation access error.");
          setupMap([defaultLat, defaultLon], defaultZoom);
          loadInitialData(defaultLat, defaultLon);
      }
    }

    function setupMap(centerCoords, zoomLevel) {
        console.log("[Setup] Setting up Leaflet map centered at:", centerCoords, " Zoom:", zoomLevel);
        let mapDiv = document.getElementById('fire-map');
        if (!mapDiv) { /* ... error handling ... */ }
        console.log("[Setup] Map container found...");

      try {
        if (map) { map.remove(); map = null; }
        console.log("[Setup] Creating L.map object...");
        map = L.map('fire-map', { center: centerCoords, zoom: zoomLevel, fullscreenControl: true });
        console.log("[Setup] L.map object created:", map ? 'Success' : 'Failed');

        // Initialize non-clustered layers here
        airQualityLayer = L.layerGroup();
        nwsLayer = L.layerGroup();
        // Cluster groups will be initialized in their respective load functions
        console.log("[Setup] Non-clustered layer groups initialized.");

        const tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '...' });
        tileLayer.on('load', () => console.log("[Tiles] Tile layer loaded successfully."));
        tileLayer.on('tileerror', (error) => { console.error("[Tiles] Tile layer error:", error); displayMapError("Map tiles could not load."); });
        tileLayer.addTo(map);
        console.log("[Setup] Tile layer added to map.");

        console.log("[Setup] Adding initial data layers (NWS only initially)...");
        // Don't add fire/nifc layers directly initially, wait for cluster groups in load functions
        if (showNIFC && nifcClusterGroup) nifcClusterGroup.addTo(map); // Add NIFC if already loaded and visible
        if (showNWS && nwsLayer) nwsLayer.addTo(map);

        addMapControls(); addMapLegend();

        map.on('fullscreenchange', function () { mapWrapper.classList.toggle('fullscreen', map.isFullscreen()); map.invalidateSize(); });
        map.on('resize', () => { console.log("[Event] Map resize event. Invalidating size."); if(map) map.invalidateSize();});

        mapLoadingMessage.style.display = 'none';
        setTimeout(() => { if (map) { console.log("[Setup] Calling delayed map.invalidateSize()."); map.invalidateSize(); } }, 150);
        console.log("[Setup] Map setup complete.");

      } catch(e) { console.error("[Setup] CRITICAL Error during map setup:", e); mapLoadingMessage.style.display = 'none'; displayMapError("Critical error setting up the map. Please refresh."); }
    }

    function loadInitialData(lat, lon) { /* ... same code ... */ }

    // --- Data Loading Functions ---

    async function loadFIRMSFires(lat, lon) {
      const apiKey = NASA_API_KEY; /* ... key check ... */ const source = 'VIIRS_SNPP_NRT'; const lookbackDays = 2; const area = '-125,24,-66,50'; const url = `https://firms.modaps.eosdis.nasa.gov/api/area/csv/${apiKey}/${source}/${area}/${lookbackDays}`; console.log(`[FIRMS] Fetching FIRMS data for ${lookbackDays} days, bounding box:`, area); mapLoadingMessage.style.display = 'block'; let markerCount = 0;

      // *** Marker Cluster Implementation ***
      // 1. Clear previous cluster group from map if it exists
      if (map && firmsClusterGroup) {
          console.log("[FIRMS] Removing previous firmsClusterGroup from map.");
          map.removeLayer(firmsClusterGroup);
      }
      // 2. Create a new cluster group for this load
      firmsClusterGroup = L.markerClusterGroup(); // Initialize here
      console.log("[FIRMS] Created new markerClusterGroup.");
      // *** End Marker Cluster Init ***

      try {
          const response = await fetch(url); /* ... handle response ... */ if (!response.ok) { /* ... handle error ... */ } const csvData = await response.text(); /* ... */ const lines = csvData.trim().split(/\r?\n/); /* ... handle no lines ... */ const headers = lines[0].split(','); /* ... get indices ... */ if (latIndex === -1 || lonIndex === -1) { /* ... handle bad headers ... */ } const fireIcon = L.icon({ iconUrl: 'images/fire-icon.png', iconSize: [25, 25], iconAnchor: [12, 25], popupAnchor: [0, -25] });

          lines.slice(1).forEach((line, index) => { /* ... processing loop ... */
              console.log(`[FIRMS Processing Line ${index + 1}] Raw:`, line); // Keep detailed logging for now
              try { const values = line.split(','); if (values.length > Math.max(latIndex, lonIndex)) { const lat = parseFloat(values[latIndex]); const lon = parseFloat(values[lonIndex]); console.log(`[FIRMS Processing Line ${index + 1}] Parsed lat: ${lat}, lon: ${lon}`); if (!isNaN(lat) && !isNaN(lon)) { /* ... get other values ... */ const marker = L.marker([lat, lon], { icon: fireIcon }).bindPopup(/* ... */); console.log(`[FIRMS Processing Line ${index + 1}] Adding marker to cluster group.`);
                          // *** Add marker to Cluster Group ***
                          firmsClusterGroup.addLayer(marker);
                          markerCount++;
                      } else { /* ... log skip ... */ } } else { /* ... log skip ... */ } } catch (lineError) { /* ... log error ... */ } });

           console.log(`[FIRMS] Added ${markerCount} markers to cluster group.`);
           // *** Add the Cluster Group to the map ***
           if (map && showFires) {
               console.log("[FIRMS] Adding firmsClusterGroup to map.");
               map.addLayer(firmsClusterGroup);
           }
           if (markerCount > 0) { mapErrorMessage.style.display = 'none'; } else { displayMapError('FIRMS data received but no valid hotspots found.'); }

      } catch (error) { /* ... error handling ... */
      } finally { mapLoadingMessage.style.display = 'none'; console.log("[FIRMS] Data loading finished."); }
    }

    async function loadNIFCFires() { /* ... Apply similar Cluster logic if needed ... */
        const url = 'https://services3.arcgis.com/T4QMspbfLg3qTGWY/arcgis/rest/services/CY_WildlandFire_Locations_ToDate/FeatureServer/0/query?where=1%3D1&outFields=IncidentName,FireDiscoveryDateTime,InitialLatitude,InitialLongitude,PercentContained,CalculatedAcres,EstimatedCostToDate&outSR=4326&f=json'; console.log("[NIFC] Fetching NIFC data..."); mapLoadingMessage.style.display = 'block'; let markerCount = 0;
        // Clear previous NIFC layer (still using LayerGroup for now)
        nifcLayer.clearLayers();
        // If using cluster:
        // if (map && nifcClusterGroup) map.removeLayer(nifcClusterGroup);
        // nifcClusterGroup = L.markerClusterGroup();

      try { const response = await fetch(url); /* ... */ if (!response.ok) { /* ... */ } const data = await response.json(); const nifcIcon = L.icon({ iconUrl: 'images/nifc-fire.png', iconSize: [30, 30], iconAnchor: [15, 30], popupAnchor: [0, -30] });
          if (data.features && data.features.length > 0) { console.log("[NIFC] Processing features:", data.features.length); data.features.forEach((feature, index) => { try { const props = feature.attributes; const geom = feature.geometry; if (geom && typeof geom.y === 'number' && typeof geom.x === 'number') { /* ... */ const marker = L.marker([geom.y, geom.x], { icon: nifcIcon }).bindPopup(/* ... */);
                          // Add to NIFC LayerGroup (or ClusterGroup)
                          nifcLayer.addLayer(marker);
                          // nifcClusterGroup.addLayer(marker); // If using cluster
                          markerCount++; } } catch (featureError) { /* ... */ } }); console.log(`[NIFC] Added ${markerCount} markers.`); if (markerCount > 0) { mapErrorMessage.style.display = 'none'; }
          } else { console.log("[NIFC] No active incidents found."); }
          // If using cluster:
          // if (map && showNIFC) map.addLayer(nifcClusterGroup);
      } catch (error) { /* ... */
      } finally { /* ... */ // Ensure correct layer/cluster is shown based on showNIFC
          if (map) { if (showNIFC && !map.hasLayer(nifcLayer /* or nifcClusterGroup */)) { nifcLayer.addTo(map); /* or map.addLayer(nifcClusterGroup); */ } else if (!showNIFC && map.hasLayer(nifcLayer /* or nifcClusterGroup */)) { nifcLayer.remove(); /* or map.removeLayer(nifcClusterGroup); */ } }
          mapLoadingMessage.style.display = 'none'; console.log("[NIFC] Data loading finished."); } }

    async function loadAirQuality(lat, lon) { /* ... same code ... */ }
    async function loadNWSWarnings() { /* ... same code ... */ }

    // --- Control Handlers & Helper Functions ---
    hamburger.addEventListener('click', () => { /* ... */ }); navMenu.querySelectorAll('a').forEach(link => { /* ... */ });
    function centerOnUserLocation() { /* ... */ } function zoomToCA() { /* ... */ } function zoomToUS() { /* ... */ }

    function toggleFireLayers() {
        if (!map) { console.error("[Controls] Cannot toggle layers, map not initialized."); return; }
        const btn = document.getElementById('toggle-fires');
        showFires = !showFires; // Toggle the state variable for FIRMS cluster visibility

        console.log("[Controls] Toggling Fire Layers. Show:", showFires);
        // Toggle FIRMS Cluster Group
        if (showFires) {
            if (firmsClusterGroup && !map.hasLayer(firmsClusterGroup)) {
                map.addLayer(firmsClusterGroup);
                console.log("[Controls] Added firmsClusterGroup to map.");
            }
            if (nifcLayer && !map.hasLayer(nifcLayer)) { // Still using LayerGroup for NIFC
                map.addLayer(nifcLayer);
                 console.log("[Controls] Added nifcLayer to map.");
            }
             btn.classList.add('active');
             btn.innerHTML = '<i class="fas fa-fire"></i> Fires';
        } else {
            if (firmsClusterGroup && map.hasLayer(firmsClusterGroup)) {
                map.removeLayer(firmsClusterGroup);
                 console.log("[Controls] Removed firmsClusterGroup from map.");
            }
             if (nifcLayer && map.hasLayer(nifcLayer)) {
                map.removeLayer(nifcLayer);
                 console.log("[Controls] Removed nifcLayer from map.");
            }
            btn.classList.remove('active');
             btn.innerHTML = '<i class="far fa-eye-slash"></i> Fires Off';
        }
        // Note: We still need to track showNIFC separately if we want independent toggling later
        // For now, this button toggles both FIRMS (clustered) and NIFC (non-clustered)
    }

    function toggleAirQuality() { /* ... same code ... */ }
    function toggleNWSLayer() { /* ... same code ... */ }
    async function handleZipSearch(event) { /* ... same code ... */ }
    function getAQIColor(aqi) { /* ... same code ... */ }
    function displayMapError(message) { /* ... same code ... */ }

  </script>

</body>
</html>
