# Eye on the Fire - Production Apache Configuration
# Enterprise-grade .htaccess for optimal performance and security

# Enable mod_rewrite for clean URLs
RewriteEngine On

# Security Headers - Enhanced
<IfModule mod_headers.c>
    # Enable HSTS (HTTP Strict Transport Security) - Force HTTPS
    Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
    
    # Prevent clickjacking
    Header always set X-Frame-Options "DENY"
    
    # Prevent MIME type sniffing
    Header always set X-Content-Type-Options "nosniff"
    
    # Enable XSS protection
    Header always set X-XSS-Protection "1; mode=block"
    
    # Referrer Policy for privacy
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Enhanced Content Security Policy for Google Analytics
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'sha256-V6eiWrbNJxR7u6N+YzZTQ2BEjzKKxZvFQZlW5iq5RvE=' https://www.googletagmanager.com https://www.google-analytics.com https://unpkg.com https://cdnjs.cloudflare.com https://maps.googleapis.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https://www.googletagmanager.com https://www.google-analytics.com https://maps.googleapis.com https://maps.gstatic.com blob:; connect-src 'self' https://www.google-analytics.com https://analytics.google.com https://firms.modaps.eosdis.nasa.gov https://services3.arcgis.com https://www.airnowapi.org https://api.weather.gov https://maps.googleapis.com; frame-src 'none'; object-src 'none'; base-uri 'self'; form-action 'self';"
    
    # Permissions Policy
    Header always set Permissions-Policy "geolocation=(self), microphone=(), camera=(), payment=(), usb=(), magnetometer=(), accelerometer=(), gyroscope=(), interest-cohort=()"
    
    # Remove server signature for security
    Header unset Server
    Header unset X-Powered-By
    
    # Google Analytics optimization headers
    <FilesMatch "\.(js)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
        Header append Vary Accept-Encoding
    </FilesMatch>
</IfModule>

# Force HTTPS redirect with performance optimization
<IfModule mod_rewrite.c>
    RewriteCond %{HTTPS} off
    RewriteCond %{HTTP:X-Forwarded-Proto} !https
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301,E=nocache:1]
</IfModule>

# Advanced Compression for better Google PageSpeed
<IfModule mod_deflate.c>
    # Compress HTML, CSS, JavaScript, Text, XML and fonts
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/vnd.ms-fontobject
    AddOutputFilterByType DEFLATE application/x-font
    AddOutputFilterByType DEFLATE application/x-font-opentype
    AddOutputFilterByType DEFLATE application/x-font-otf
    AddOutputFilterByType DEFLATE application/x-font-truetype
    AddOutputFilterByType DEFLATE application/x-font-ttf
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE font/opentype
    AddOutputFilterByType DEFLATE font/otf
    AddOutputFilterByType DEFLATE font/ttf
    AddOutputFilterByType DEFLATE image/svg+xml
    AddOutputFilterByType DEFLATE image/x-icon
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/javascript
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE application/json
    AddOutputFilterByType DEFLATE application/ld+json
    
    # Remove browser bugs (legacy support)
    BrowserMatch ^Mozilla/4 gzip-only-text/html
    BrowserMatch ^Mozilla/4\.0[678] no-gzip
    BrowserMatch \bMSIE !no-gzip !gzip-only-text/html
    Header append Vary User-Agent
</IfModule>

# Optimized Cache Headers for Performance
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresDefault "access plus 1 day"
    
    # Cache images aggressively for better performance
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType image/avif "access plus 1 year"
    ExpiresByType image/x-icon "access plus 1 year"
    
    # Cache CSS and JavaScript for performance
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType text/javascript "access plus 1 month"
    
    # Cache fonts
    ExpiresByType application/vnd.ms-fontobject "access plus 1 year"
    ExpiresByType font/ttf "access plus 1 year"
    ExpiresByType font/otf "access plus 1 year"
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType font/woff2 "access plus 1 year"
    
    # Cache HTML with shorter duration for dynamic content
    ExpiresByType text/html "access plus 2 hours"
    
    # Cache manifest and service worker files
    ExpiresByType application/manifest+json "access plus 1 week"
    ExpiresByType text/cache-manifest "access plus 0 seconds"
    
    # Cache other assets
    ExpiresByType application/pdf "access plus 1 month"
    ExpiresByType video/mp4 "access plus 1 year"
    ExpiresByType audio/mpeg "access plus 1 year"
</IfModule>

# Enhanced Cache-Control Headers
<IfModule mod_headers.c>
    # Immutable assets with long cache
    <FilesMatch "\.(jpg|jpeg|png|gif|webp|avif|svg|css|js|woff|woff2|ttf|otf|eot)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
        Header append Vary Accept-Encoding
    </FilesMatch>
    
    # HTML files with validation cache
    <FilesMatch "\.(html|htm)$">
        Header set Cache-Control "public, max-age=7200, must-revalidate"
        Header append Vary Accept-Encoding
    </FilesMatch>
    
    # Service Worker - no cache
    <FilesMatch "^sw\.js$">
        Header set Cache-Control "no-cache, no-store, must-revalidate"
        Header set Pragma "no-cache"
        Header set Expires "0"
    </FilesMatch>
    
    # Manifest file
    <FilesMatch "\.webmanifest$">
        Header set Cache-Control "public, max-age=604800"
    </FilesMatch>
    
    # API responses - short cache
    <FilesMatch "^api/">
        Header set Cache-Control "public, max-age=900"
        Header append Vary Accept-Encoding
    </FilesMatch>
</IfModule>

# Clean URLs - Remove .html extension
<IfModule mod_rewrite.c>
    # Remove .html extension from URLs
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteRule ^([^\.]+)$ $1.html [NC,L]
    
    # Redirect .html requests to clean URLs
    RewriteCond %{THE_REQUEST} /([^.]+)\.html [NC]
    RewriteRule ^ /%1? [NC,L,R=301]
</IfModule>

# Custom Error Pages
ErrorDocument 400 /400.html
ErrorDocument 401 /401.html
ErrorDocument 403 /403.html
ErrorDocument 404 /404.html
ErrorDocument 500 /500.html
ErrorDocument 502 /502.html
ErrorDocument 503 /503.html
ErrorDocument 504 /504.html

# Security - Prevent access to sensitive files
<Files "robots.txt">
    Require all granted
</Files>

<Files "sitemap.xml">
    Require all granted
</Files>

<Files ".well-known/security.txt">
    Require all granted
</Files>

<FilesMatch "\.(htaccess|htpasswd|ini|log|sh|inc|bak|sql|env|config)$">
    Require all denied
</FilesMatch>

# Prevent access to hidden files and directories
<IfModule mod_rewrite.c>
    RewriteRule (^|/)\.(?!well-known/) - [F]
</IfModule>

# Block version control directories
<DirectoryMatch "\.git|\.svn|\.hg|\.bzr">
    Require all denied
</DirectoryMatch>

# Block bad bots and scrapers (enhanced)
<IfModule mod_rewrite.c>
    RewriteCond %{HTTP_USER_AGENT} ^.*(AhrefsBot|MJ12bot|DotBot|SemrushBot|BLEXBot|DataForSeoBot).*$ [NC]
    RewriteRule .* - [F,L]
    
    # Block requests with no user agent
    RewriteCond %{HTTP_USER_AGENT} ^$ [NC]
    RewriteCond %{REQUEST_METHOD} ^(GET|POST)$ [NC]
    RewriteRule .* - [F,L]
</IfModule>

# Prevent hotlinking of images and assets
<IfModule mod_rewrite.c>
    RewriteCond %{HTTP_REFERER} !^$
    RewriteCond %{HTTP_REFERER} !^https://eyeonthefire\.com [NC]
    RewriteCond %{HTTP_REFERER} !^https://www\.eyeonthefire\.com [NC]
    RewriteCond %{HTTP_REFERER} !^https://.*\.googletagmanager\.com [NC]
    RewriteCond %{HTTP_REFERER} !^https://.*\.google-analytics\.com [NC]
    RewriteCond %{REQUEST_URI} \.(jpg|jpeg|png|gif|webp|svg)$ [NC]
    RewriteRule .* - [F,L]
</IfModule>

# Disable ETags for better caching
<IfModule mod_headers.c>
    Header unset ETag
</IfModule>
FileETag None

# MIME Types for modern web
<IfModule mod_mime.c>
    # Proper MIME types
    AddType application/javascript .js
    AddType text/css .css
    AddType image/svg+xml .svg
    AddType application/font-woff2 .woff2
    AddType application/manifest+json .webmanifest
    AddType application/ld+json .jsonld
    
    # Modern image formats
    AddType image/avif .avif
    AddType image/webp .webp
    
    # Security-related files
    AddType text/plain .txt
    AddType text/plain security.txt
    
    # Enable server-side includes
    AddType text/html .shtml
    AddOutputFilter INCLUDES .shtml
</IfModule>

# SEO and Performance Redirects
<IfModule mod_rewrite.c>
    # Remove index.html from URLs
    RewriteCond %{THE_REQUEST} /index\.html [NC]
    RewriteRule ^index\.html$ /? [R=301,L]
    
    # Remove trailing slashes from files
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^(.+)/$ /$1 [R=301,L]
    
    # Add trailing slash to directories
    RewriteCond %{REQUEST_FILENAME} -d
    RewriteCond %{REQUEST_URI} !.*/$
    RewriteRule ^(.*)$ /$1/ [R=301,L]
    
    # Canonical domain redirect (if needed)
    # RewriteCond %{HTTP_HOST} ^www\.eyeonthefire\.com [NC]
    # RewriteRule ^(.*)$ https://eyeonthefire.com/$1 [R=301,L]
</IfModule>

# Rate limiting (if mod_evasive is available)
<IfModule mod_evasive24.c>
    DOSHashTableSize    2048
    DOSPageCount        15
    DOSPageInterval     1
    DOSSiteCount        75
    DOSSiteInterval     1
    DOSBlockingPeriod   300
    DOSLogDir           "/var/log/mod_evasive"
</IfModule>

# Performance optimization for slow connections
<IfModule mod_deflate.c>
    SetOutputFilter DEFLATE
    SetEnvIfNoCase Request_URI \
        \.(?:gif|jpe?g|png|webp|avif)$ no-gzip dont-vary
    SetEnvIfNoCase Request_URI \
        \.(?:exe|t?gz|zip|bz2|sit|rar)$ no-gzip dont-vary
</IfModule>

# Prevent execution in upload directories
<DirectoryMatch "^.*/uploads/">
    <FilesMatch "\.php$">
        Require all denied
    </FilesMatch>
</DirectoryMatch>

# Additional security headers for modern browsers
<IfModule mod_headers.c>
    # Cross-Origin Resource Policy
    Header set Cross-Origin-Resource-Policy "cross-origin"
    
    # Cross-Origin Embedder Policy
    Header set Cross-Origin-Embedder-Policy "unsafe-none"
    
    # Cross-Origin Opener Policy
    Header set Cross-Origin-Opener-Policy "same-origin-allow-popups"
    
    # DNS prefetch control
    Header set X-DNS-Prefetch-Control "on"
    
    # Cross-origin sharing for web fonts
    <FilesMatch "\.(ttf|ttc|otf|eot|woff|woff2|font\.css)$">
        Header set Access-Control-Allow-Origin "*"
        Header set Access-Control-Allow-Methods "GET"
        Header set Access-Control-Max-Age "31536000"
    </FilesMatch>
</IfModule>

# Browser caching with conditional requests
<IfModule mod_headers.c>
    # Add Last-Modified headers for better caching
    <FilesMatch "\.(css|js|png|jpg|jpeg|gif|webp|svg)$">
        Header set Last-Modified "Thu, 01 Jan 2025 00:00:00 GMT"
    </FilesMatch>
</IfModule>

# Character encoding
AddDefaultCharset utf-8
AddCharset utf-8 .css .js .xml .json .rss .atom .jsonld

# Preload hints for critical resources
<IfModule mod_headers.c>
    <FilesMatch "index\.html$">
        Header append Link "</assets/css/styles.css>; rel=preload; as=style"
        Header append Link "</assets/js/app.js>; rel=preload; as=script"
        Header append Link "<https://fonts.googleapis.com>; rel=preconnect; crossorigin"
        Header append Link "<https://www.googletagmanager.com>; rel=preconnect"
    </FilesMatch>
</IfModule>

# Performance monitoring (if available)
<IfModule mod_headers.c>
    # Server-Timing header for performance debugging
    Header set Server-Timing "total;dur=0"
</IfModule>
