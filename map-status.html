<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Eye On The Fire - NASA FIRMS Data</title>
  
  <!-- External Dependencies -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.css" />
  
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      font-family: Arial, sans-serif;
    }
    
    #map {
      height: 100%;
      width: 100%;
    }
    
    .status-bar {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background-color: white;
      padding: 10px;
      border-radius: 4px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.4);
      z-index: 1000;
    }
    
    .error {
      color: #d9534f;
      font-weight: bold;
    }
    
    .loading {
      color: #5bc0de;
    }
    
    .success {
      color: #5cb85c;
    }
    
    .warning {
      color: #f0ad4e;
    }
    
    .retry-button {
      background-color: #5bc0de;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 3px;
      cursor: pointer;
      margin-left: 10px;
    }
    
    .control-panel {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: white;
      padding: 10px;
      border-radius: 4px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.4);
      z-index: 1000;
      max-width: 300px;
    }
    
    .form-group {
      margin-bottom: 10px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    
    .form-group select, .form-group input {
      width: 100%;
      padding: 5px;
      border-radius: 3px;
      border: 1px solid #ccc;
    }
    
    .form-submit {
      background-color: #5cb85c;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 3px;
      cursor: pointer;
      width: 100%;
    }
    
    /* Legend styles */
    .legend {
      position: absolute;
      bottom: 30px;
      right: 10px;
      background-color: white;
      padding: 10px;
      border-radius: 4px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.4);
      z-index: 1000;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }
    
    .legend-color {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      margin-right: 8px;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="status" class="status-bar">Loading map...</div>
  
  <div class="control-panel">
    <h3>Fire Data Controls</h3>
    <div class="form-group">
      <label for="days">Past Days:</label>
      <select id="days">
        <option value="1">1 day</option>
        <option value="2" selected>2 days</option>
        <option value="3">3 days</option>
        <option value="7">7 days</option>
      </select>
    </div>
    <div class="form-group">
      <label for="satellite">Satellite Source:</label>
      <select id="satellite">
        <option value="MODIS">MODIS (Terra/Aqua)</option>
        <option value="VIIRS" selected>VIIRS (NOAA-20)</option>
        <option value="VIIRS_SNPP">VIIRS (Suomi NPP)</option>
      </select>
    </div>
    <button id="refresh-btn" class="form-submit">Refresh Data</button>
  </div>
  
  <div class="legend">
    <h4 style="margin-top: 0;">Fire Confidence</h4>
    <div class="legend-item">
      <div class="legend-color" style="background-color: red;"></div>
      <span>High (80-100%)</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background-color: orange;"></div>
      <span>Nominal (30-79%)</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background-color: yellow;"></div>
      <span>Low (0-29%)</span>
    </div>
  </div>

  <script>
    // Main app
    document.addEventListener('DOMContentLoaded', function() {
      // DOM elements
      const mapElement = document.getElementById('map');
      const statusElement = document.getElementById('status');
      const daysSelect = document.getElementById('days');
      const satelliteSelect = document.getElementById('satellite');
      const refreshBtn = document.getElementById('refresh-btn');
      
      // Constants
      const DEFAULT_CENTER = [36.0, -120.0]; // California
      const DEFAULT_ZOOM = 5;
      
      // Initialize map
      const map = L.map('map').setView(DEFAULT_CENTER, DEFAULT_ZOOM);
      
      // Add base map layer
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors | Fire data: NASA FIRMS',
        maxZoom: 19
      }).addTo(map);
      
      // Initialize marker cluster group
      const markers = L.markerClusterGroup();
      map.addLayer(markers);
      
      // Set status
      function setStatus(message, type = 'loading') {
        statusElement.innerHTML = message;
        statusElement.className = 'status-bar ' + type;
      }
      
      // Add retry button to status
      function addRetryButton() {
        const button = document.createElement('button');
        button.innerText = 'Retry';
        button.className = 'retry-button';
        button.onclick = loadFireData;
        statusElement.appendChild(button);
      }
      
      // Create a custom icon for the fire markers based on confidence
      function createFireIcon(confidence) {
        // Set color based on confidence
        let markerColor = 'red'; // Default
        
        if (confidence < 30) {
          markerColor = 'yellow';
        } else if (confidence < 80) {
          markerColor = 'orange';
        }
        
        return L.divIcon({
          html: `<div style="background-color: ${markerColor}; width: 10px; height: 10px; border-radius: 50%; border: 1px solid #fff;"></div>`,
          className: '',
          iconSize: [12, 12]
        });
      }
      
      // Display fire data on map
      function displayFires(fires) {
        // Clear existing markers
        markers.clearLayers();
        
        if (!fires || fires.length === 0) {
          setStatus('No fire data available', 'warning');
          return;
        }
        
        // Track valid points for bounds
        const validPoints = [];
        let count = 0;
        
        // Add markers for each fire
        fires.forEach(fire => {
          // Extract coordinates - handle different possible property names
          const lat = parseFloat(fire.latitude || fire.lat || '');
          const lng = parseFloat(fire.longitude || fire.lon || '');
          
          // Skip invalid coordinates
          if (isNaN(lat) || isNaN(lng)) {
            console.warn('Invalid coordinates:', fire);
            return;
          }
          
          // Get confidence level
          const confidence = parseFloat(fire.confidence || 0);
          
          // Create marker with appropriate icon
          const marker = L.marker([lat, lng], {
            icon: createFireIcon(confidence)
          });
          
          // Build popup content
          let popupContent = '<div style="max-height: 200px; overflow-y: auto;">';
          popupContent += '<h4>Fire Detection</h4>';
          
          // Format acquisition date/time if available
          if (fire.acq_date && fire.acq_time) {
            const dateStr = fire.acq_date;
            const timeStr = String(fire.acq_time).padStart(4, '0');
            const hours = timeStr.slice(0, 2);
            const minutes = timeStr.slice(2, 4);
            popupContent += `<strong>Date:</strong> ${dateStr}<br>`;
            popupContent += `<strong>Time:</strong> ${hours}:${minutes} UTC<br>`;
          }
          
          // Add confidence
          if (fire.confidence) {
            popupContent += `<strong>Confidence:</strong> ${fire.confidence}%<br>`;
          }
          
          // Add brightness if available
          if (fire.brightness || fire.bright_t31) {
            const brightness = fire.brightness || fire.bright_t31;
            popupContent += `<strong>Brightness:</strong> ${brightness} K<br>`;
          }
          
          // Add satellite info
          if (fire.satellite) {
            popupContent += `<strong>Satellite:</strong> ${fire.satellite}<br>`;
          }
          
          // Add coordinates
          popupContent += `<strong>Latitude:</strong> ${lat.toFixed(6)}<br>`;
          popupContent += `<strong>Longitude:</strong> ${lng.toFixed(6)}<br>`;
          
          popupContent += '</div>';
          marker.bindPopup(popupContent);
          markers.addLayer(marker);
          validPoints.push([lat, lng]);
          count++;
        });
        
        // Fit map to bounds if we have points
        if (validPoints.length > 0) {
          const bounds = L.latLngBounds(validPoints);
          map.fitBounds(bounds);
          setStatus(`Showing ${count} fire detections`, 'success');
        } else {
          setStatus('No fire detections found in this region', 'warning');
        }
      }
      
      // Function to get NASA FIRMS data directly
      async function fetchNASAData() {
        const days = daysSelect.value;
        const satellite = satelliteSelect.value;
        
        // Use NASA FIRMS API directly - Note: In production, you would need to use a proxy
        // This is a demo URL that would work with a proper API key
        const apiUrl = `https://firms.modaps.eosdis.nasa.gov/api/area/csv/abcdefghijklmnopqrstuvwxyz123456/CONTIGUOUS_US/${days}/${satellite}`;
        
        // Since we can't actually call the NASA API without a key in this example,
        // we'll use some sample data instead
        console.log(`In production, would fetch: ${apiUrl}`);
        
        // Return sample data for demonstration
        return getSampleFireData();
      }
      
      // Get sample fire data
      function getSampleFireData() {
        // Create a realistic sample based on actual FIRMS data format
        const sampleData = [];
        const satellites = ['MODIS', 'VIIRS', 'VIIRS_SNPP'];
        const satellite = satelliteSelect.value || satellites[Math.floor(Math.random() * satellites.length)];
        
        // Generate California fires
        const basePoints = [
          {lat: 34.05, lng: -118.24, name: "Los Angeles Area"}, // LA
          {lat: 37.77, lng: -122.41, name: "San Francisco Area"}, // SF
          {lat: 38.58, lng: -121.49, name: "Sacramento Area"}, // Sacramento
          {lat: 36.77, lng: -119.77, name: "Fresno Area"}, // Fresno
          {lat: 32.71, lng: -117.16, name: "San Diego Area"}, // San Diego
          {lat: 35.37, lng: -119.01, name: "Bakersfield Area"}, // Bakersfield
          {lat: 33.83, lng: -116.53, name: "Palm Springs Area"}, // Palm Springs
          {lat: 39.52, lng: -121.55, name: "Chico Area"}, // Chico
          {lat: 40.58, lng: -124.15, name: "Eureka Area"}, // Eureka
          {lat: 41.71, lng: -122.64, name: "Mount Shasta Area"} // Mt Shasta
        ];
        
        // Get current date
        const currentDate = new Date();
        
        // Generate several fire points for each base location
        basePoints.forEach(base => {
          // Randomly determine how many fires in this area (0-5)
          const fireCount = Math.floor(Math.random() * 6);
          
          for (let i = 0; i < fireCount; i++) {
            // Create some variation in location
            const latOffset = (Math.random() - 0.5) * 0.5;
            const lngOffset = (Math.random() - 0.5) * 0.5;
            
            // Generate random time in the past 48 hours
            const hoursAgo = Math.floor(Math.random() * 48);
            const fireDate = new Date(currentDate);
            fireDate.setHours(fireDate.getHours() - hoursAgo);
            
            // Format date as YYYY-MM-DD
            const acq_date = fireDate.toISOString().split('T')[0];
            
            // Format time as HHMM
            const hours = fireDate.getHours().toString().padStart(2, '0');
            const minutes = fireDate.getMinutes().toString().padStart(2, '0');
            const acq_time = hours + minutes;
            
            // Generate random confidence level
            const confidence = Math.floor(Math.random() * 100) + 1;
            
            // Generate random brightness temperature
            const brightness = 300 + Math.floor(Math.random() * 100);
            
            // Add to sample data
            sampleData.push({
              latitude: base.lat + latOffset,
              longitude: base.lng + lngOffset,
              brightness: brightness,
              scan: 0.5 + Math.random(),
              track: 0.5 + Math.random(),
              acq_date: acq_date,
              acq_time: acq_time,
              satellite: satellite,
              confidence: confidence,
              version: '1.0',
              bright_t31: brightness - 10,
              frp: Math.random() * 50
            });
          }
        });
        
        return sampleData;
      }
      
      // Parse CSV data from NASA FIRMS
      function parseCSV(text) {
        // Use PapaParse library for robust CSV parsing
        const results = Papa.parse(text, {
          header: true,
          dynamicTyping: true,
          skipEmptyLines: true
        });
        
        if (results.errors && results.errors.length > 0) {
          console.warn('CSV parsing had errors:', results.errors);
        }
        
        return results.data;
      }
      
      // Function to determine data format and parse accordingly
      function parseData(responseText) {
        // Try to parse as JSON first
        try {
          return JSON.parse(responseText);
        } catch (e) {
          // If not JSON, try CSV
          console.log('Response is not JSON, trying CSV format');
          return parseCSV(responseText);
        }
      }
      
      // Load fire data
      async function loadFireData() {
        setStatus('Loading fire data...');
        
        try {
          // For demo purposes, we'll use sample data
          // In production, replace this with actual API call
          const data = await fetchNASAData();
          
          if (!data || data.length === 0) {
            setStatus('No fire data returned', 'warning');
          } else {
            displayFires(data);
          }
        } catch (error) {
          console.error('Error loading fire data:', error);
          setStatus(`Error: ${error.message}`, 'error');
          addRetryButton();
          
          // Use fallback data as a last resort
          const fallbackData = [
            {
              latitude: 37.7749, longitude: -122.4194, 
              confidence: 95, brightness: 350,
              acq_date: '2023-07-01', acq_time: '2230',
              satellite: 'VIIRS'
            },
            {
              latitude: 34.0522, longitude: -118.2437,
              confidence: 60, brightness: 320,
              acq_date: '2023-07-01', acq_time: '2230',
              satellite: 'VIIRS'
            },
            {
              latitude: 38.5816, longitude: -121.4944,
              confidence: 30, brightness: 310,
              acq_date: '2023-07-01', acq_time: '2245',
              satellite: 'VIIRS'
            }
          ];
          
          displayFires(fallbackData);
        }
      }
      
      // Set up event handlers
      refreshBtn.addEventListener('click', loadFireData);
      
      // Debug feature - click map to see coordinates
      map.on('click', function(e) {
        const coord = e.latlng;
        const lat = coord.lat.toFixed(6);
        const lng = coord.lng.toFixed(6);
        console.log(`Clicked at: ${lat}, ${lng}`);
        
        L.popup()
          .setLatLng(coord)
          .setContent(`<strong>Coordinates:</strong><br>${lat}, ${lng}`)
          .openOn(map);
      });
      
      // Initial load
      loadFireData();
    });
  </script>
</body>
</html>
