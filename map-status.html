<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fire Map</title>
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://unpkg.com;
    script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://unpkg.com https://static.cloudflareinsights.com;
    style-src 'self' 'unsafe-inline' https://unpkg.com;
    connect-src 'self' https://firms.modaps.eosdis.nasa.gov;
    img-src 'self' https://*.tile.openstreetmap.org;
  ">
  <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.development.js" data-cfasync="false"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.development.js" data-cfasync="false"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js" data-cfasync="false"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" data-cfasync="false"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    .map-container { position: relative; width: 100%; height: 100vh; }
    .loading { position: absolute; top: 10px; left: 10px; z-index: 1000; background: rgba(255, 255, 255, 0.8); padding: 5px; }
    .error { position: absolute; top: 10px; left: 10px; z-index: 1000; background: rgba(255, 0, 0, 0.8); color: white; padding: 5px; }
    #map { height: 100%; width: 100%; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel" data-cfasync="false">
    const { useState, useEffect, useRef } = React;

    function parseCSV(csvText) {
      const rows = csvText.trim().split('\n').slice(1); // Skip header
      const fires = rows.map(row => {
        const columns = row.split(',');
        const lat = parseFloat(columns[0]); // latitude
        const lon = parseFloat(columns[1]); // longitude
        const acqDate = columns[5]; // acq_date
        const acqTime = columns[6]; // acq_time
        if (!isNaN(lat) && !isNaN(lon)) {
          return { lat, lon, title: `Fire on ${acqDate} at ${acqTime}` };
        }
        return null;
      }).filter(fire => fire !== null);
      console.log('Parsed fires:', fires);
      return fires;
    }

    async function loadFireData() {
      try {
        const apiKey = 'd152217c8391eb5b0fbd242290527ae8'; // Ensure this is your valid NASA FIRMS API key
        const apiUrl = `https://firms.modaps.eosdis.nasa.gov/api/area/csv/${apiKey}/VIIRS_SNPP_NRT/world/1`;
        const response = await fetch(apiUrl);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const csvText = await response.text();
        const fires = parseCSV(csvText);
        console.log('Fetched fires:', fires.length);
        return fires;
      } catch (error) {
        console.error('Error fetching fire data:', error);
        const fallback = [
          { lat: 37.7749, lon: -122.4194, title: 'San Francisco Fire' },
          { lat: 34.0522, lon: -118.2437, title: 'Los Angeles Fire' }
        ];
        console.log('Using fallback data:', fallback);
        return fallback;
      }
    }

    const MapComponent = () => {
      const [fires, setFires] = useState([]);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const mapRef = useRef(null);
      const mapContainerRef = useRef(null);
      const initialized = useRef(false);

      useEffect(() => {
        if (!initialized.current) {
          initialized.current = true;
          loadFireData().then(data => {
            setFires(data);
            setLoading(false);
          }).catch(err => {
            setError('Failed to load fire data.');
            setLoading(false);
          });
        }
      }, []);

      useEffect(() => {
        if (mapContainerRef.current && !mapRef.current) {
          mapRef.current = L.map(mapContainerRef.current).setView([36.0, -120.0], 6);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
          }).addTo(mapRef.current);
          console.log('Map initialized');
        }
      }, []);

      useEffect(() => {
        if (mapRef.current && fires.length > 0) {
          const markers = fires.map(fire => {
            console.log(`Adding marker at: ${fire.lat}, ${fire.lon}`);
            return L.marker([fire.lat, fire.lon]).bindPopup(fire.title);
          });
          L.layerGroup(markers).addTo(mapRef.current);
          console.log('Added markers:', fires.length);
        }
      }, [fires]);

      return (
        <div className="map-container">
          {loading && <div className="loading">Loading map...</div>}
          {error && <div className="error">{error}</div>}
          <div ref={mapContainerRef} id="map"></div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<MapComponent />);
  </script>
</body>
</html>
