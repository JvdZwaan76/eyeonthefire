<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" data-cfasync="false"></script>
<script src="https://cdn.jsdelivr.net/npm/react@17/umd/react.development.js" data-cfasync="false"></script>
<script src="https://cdn.jsdelivr.net/npm/react-dom@17/umd/react-dom.development.js" data-cfasync="false"></script>
<script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.20.6/babel.min.js" data-cfasync="false"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script type="text/babel" data-cfasync="false">
    window.addEventListener('load', function() {
        const { useState, useEffect, useRef } = React;

        const MapComponent = () => {
            const [fires, setFires] = useState([]);
            const [error, setError] = useState(null);
            const mapRef = useRef(null);
            const mapContainerRef = useRef(null);

            // Mock data as a temporary workaround
            const mockFireData = [
                { lat: 37.7749, lon: -122.4194, title: 'San Francisco Fire' },
                { lat: 34.0522, lon: -118.2437, title: 'Los Angeles Fire' }
            ];

            useEffect(() => {
                const loadFireData = async () => {
                    try {
                        const response = await fetch('https://eyeonthefire.com/api/nasa/');
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        const data = await response.json();
                        const fireList = (data.events || []).map(event => {
                            const lat = parseFloat(event.geometry[0].coordinates[1]);
                            const lon = parseFloat(event.geometry[0].coordinates[0]);
                            return isNaN(lat) || isNaN(lon) ? null : { lat, lon, title: event.title || 'Active Fire' };
                        }).filter(fire => fire !== null);
                        setFires(fireList);
                        setError(null);
                    } catch (error) {
                        console.error('Error fetching fire data:', error);
                        setError('Failed to load fire data from API. Displaying mock data.');
                        setFires(mockFireData); // Fallback to mock data
                    }
                };
                loadFireData();
            }, []);

            useEffect(() => {
                if (mapContainerRef.current && !mapRef.current) {
                    try {
                        mapRef.current = L.map(mapContainerRef.current).setView([36.0, -120.0], 6);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: 'Â© OpenStreetMap contributors | Eye on the Fire'
                        }).addTo(mapRef.current);
                    } catch (error) {
                        console.error('Map initialization failed:', error);
                        setError('Map initialization failed.');
                    }
                }
            }, []);

            useEffect(() => {
                if (mapRef.current && fires.length > 0) {
                    const markers = fires.map(fire => {
                        return L.marker([fire.lat, fire.lon]).bindPopup(fire.title);
                    });
                    L.layerGroup(markers).addTo(mapRef.current);
                }
            }, [fires]);

            return (
                <div className="map-container">
                    {error && <div style={{ color: 'red', padding: '10px' }}>{error}</div>}
                    <div ref={mapContainerRef} id="map" style={{ height: '500px', width: '100%' }}></div>
                </div>
            );
        };

        ReactDOM.render(<MapComponent />, document.getElementById('root'));
    });
</script>
<div id="root"></div>
