<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://unpkg.com https://www.googletagmanager.com https://static.cloudflareinsights.com;
    style-src 'self' 'unsafe-inline' https://unpkg.com https://fonts.googleapis.com https://cdnjs.cloudflare.com;
    connect-src 'self' https://eyeonthefire.com https://firms.modaps.eosdis.nasa.gov https://analytics.google.com https://www.google-analytics.com;
    img-src 'self' https://tile.openstreetmap.org data:;
    frame-src 'self' https://firms.modaps.eosdis.nasa.gov;
    font-src 'self' https://fonts.googleapis.com https://fonts.gstatic.com https://cdnjs.cloudflare.com;
  ">
  <title>Interactive Fire Map</title>
  <!-- External Scripts and Styles -->
  <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const MapComponent = () => {
      const [fires, setFires] = useState([]);
      const [loading, setLoading] = useState(true);
      const mapRef = useRef(null);
      const markersRef = useRef(null);
      const mapContainerRef = useRef(null);

      const loadFireData = async () => {
        try {
          const response = await fetch('https://eyeonthefire.com/api/nasa/');
          if (!response.ok) throw new Error('API failed');
          const text = await response.text();
          // Note: parseCSV is assumed to be defined elsewhere; replace with actual parsing logic if needed
          return parseCSV(text);
        } catch (error) {
          console.error('Error fetching fire data:', error);
          // Fallback data for San Francisco and Los Angeles
          return [
            { lat: 37.7749, lon: -122.4194, title: 'San Francisco Fire' },
            { lat: 34.0522, lon: -118.2437, title: 'Los Angeles Fire' },
          ];
        }
      };

      useEffect(() => {
        const initMap = async () => {
          setLoading(true);
          const data = await loadFireData();
          setFires(data);
          setLoading(false);
        };
        initMap();
      }, []);

      useEffect(() => {
        if (mapContainerRef.current && !mapRef.current) {
          mapRef.current = L.map(mapContainerRef.current).setView([36.0, -120.0], 6);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors',
          }).addTo(mapRef.current);
        }
        return () => {
          if (mapRef.current) {
            mapRef.current.remove();
            mapRef.current = null;
          }
        };
      }, []);

      useEffect(() => {
        if (mapRef.current && !loading && fires.length > 0) {
          if (markersRef.current) {
            mapRef.current.removeLayer(markersRef.current);
          }
          markersRef.current = L.markerClusterGroup();
          fires.forEach(fire => {
            markersRef.current.addLayer(L.marker([fire.lat, fire.lon]).bindPopup(fire.title));
          });
          mapRef.current.addLayer(markersRef.current);
        }
      }, [fires, loading]);

      return (
        <div style={{ position: 'relative', height: '500px', width: '100%' }}>
          {loading ? (
            <div style={{ position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)' }}>
              Loading map...
            </div>
          ) : (
            <div ref={mapContainerRef} id="map" style={{ height: '100%', width: '100%' }}></div>
          )}
        </div>
      );
    };

    ReactDOM.render(<MapComponent />, document.getElementById('root'));
  </script>
</body>
</html>
