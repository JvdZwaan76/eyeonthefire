<script src="https://cdn.jsdelivr.net/npm/react@17/umd/react.development.js"></script>
<script src="https://cdn.jsdelivr.net/npm/react-dom@17/umd/react-dom.development.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7/babel.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />

<div id="root"></div>

<style>
  #map {
    height: 500px !important;
    width: 100% !important;
    display: block !important;
  }
</style>

<script type="text/babel">
  const { useState, useEffect, useRef } = React;

  const MapComponent = () => {
    const [fires, setFires] = useState([]);
    const [showFallback, setShowFallback] = useState(false);
    const mapRef = useRef(null);
    const mapContainerRef = useRef(null);

    useEffect(() => {
      console.log('Component mounted');
      const loadFireData = async () => {
        try {
          const response = await fetch('https://eyeonthefire.com/api/nasa/');
          const data = await response.json();
          const fireList = (data.events || []).map(event => {
            const lat = parseFloat(event.geometry[0].coordinates[1]);
            const lon = parseFloat(event.geometry[0].coordinates[0]);
            return isNaN(lat) || isNaN(lon) ? null : { lat, lon, title: event.title || 'Active Fire' };
          }).filter(fire => fire !== null);
          setFires(fireList);
          console.log('Fires array length:', fireList.length);
          setShowFallback(false);
        } catch (error) {
          console.error('Error loading fire data:', error);
          setShowFallback(true);
        }
      };
      loadFireData();
    }, []);

    useEffect(() => {
      if (!showFallback && mapContainerRef.current && !mapRef.current) {
        console.log('mapContainerRef.current:', mapContainerRef.current);
        try {
          mapRef.current = L.map(mapContainerRef.current).setView([39.8283, -98.5795], 4);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors | Eye on the Fire'
          }).addTo(mapRef.current);
          console.log('Map initialized');
        } catch (error) {
          console.error('Map initialization failed:', error);
          setShowFallback(true);
        }
      }
    }, [showFallback]);

    console.log('Rendering, showFallback:', showFallback);

    return (
      <div className="map-container">
        {showFallback ? (
          <iframe
            src="https://firms.modaps.eosdis.nasa.gov/map/#d:24hrs;@0.0,0.0,3z"
            title="NASA FIRMS Fire Map"
            style={{ height: '500px', width: '100%' }}
          ></iframe>
        ) : (
          <div ref={mapContainerRef} id="map"></div>
        )}
      </div>
    );
  };

  ReactDOM.render(<MapComponent />, document.getElementById('root'));
</script>
