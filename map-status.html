<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Eye On The Fire - NASA FIRMS Data</title>
  
  <!-- External Dependencies -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
  
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      font-family: Arial, sans-serif;
    }
    
    #map {
      height: 100%;
      width: 100%;
    }
    
    .status-bar {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background-color: white;
      padding: 10px;
      border-radius: 4px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.4);
      z-index: 1000;
    }
    
    .error {
      color: #d9534f;
      font-weight: bold;
    }
    
    .loading {
      color: #5bc0de;
    }
    
    .success {
      color: #5cb85c;
    }
    
    .retry-button {
      background-color: #5bc0de;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 3px;
      cursor: pointer;
      margin-left: 10px;
    }
    
    .control-panel {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: white;
      padding: 10px;
      border-radius: 4px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.4);
      z-index: 1000;
      max-width: 300px;
    }
    
    .form-group {
      margin-bottom: 10px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    
    .form-group select, .form-group input {
      width: 100%;
      padding: 5px;
      border-radius: 3px;
      border: 1px solid #ccc;
    }
    
    .form-submit {
      background-color: #5cb85c;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 3px;
      cursor: pointer;
      width: 100%;
    }
    
    /* Different fire confidence levels */
    .marker-low {
      background-color: yellow;
    }
    
    .marker-nominal {
      background-color: orange;
    }
    
    .marker-high {
      background-color: red;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="status" class="status-bar">Loading map...</div>
  
  <div class="control-panel">
    <h3>Fire Data Controls</h3>
    <div class="form-group">
      <label for="days">Past Days:</label>
      <select id="days">
        <option value="1">1 day</option>
        <option value="2" selected>2 days</option>
        <option value="3">3 days</option>
        <option value="7">7 days</option>
      </select>
    </div>
    <div class="form-group">
      <label for="satellite">Satellite Source:</label>
      <select id="satellite">
        <option value="MODIS_NRT">MODIS (Terra/Aqua)</option>
        <option value="VIIRS_NOAA20_NRT" selected>VIIRS (NOAA-20)</option>
        <option value="VIIRS_SNPP_NRT">VIIRS (Suomi NPP)</option>
      </select>
    </div>
    <button id="refresh-btn" class="form-submit">Refresh Data</button>
  </div>

  <!-- Load libraries -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
  
  <script>
    // Main app
    document.addEventListener('DOMContentLoaded', function() {
      // DOM elements
      const mapElement = document.getElementById('map');
      const statusElement = document.getElementById('status');
      const daysSelect = document.getElementById('days');
      const satelliteSelect = document.getElementById('satellite');
      const refreshBtn = document.getElementById('refresh-btn');
      
      // Constants
      const DEFAULT_CENTER = [36.0, -120.0]; // California
      const DEFAULT_ZOOM = 5;
      
      // Initialize map
      const map = L.map('map').setView(DEFAULT_CENTER, DEFAULT_ZOOM);
      
      // Add base map layer
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors | Fire data: NASA FIRMS',
        maxZoom: 19
      }).addTo(map);
      
      // Initialize marker cluster group
      const markers = L.markerClusterGroup();
      map.addLayer(markers);
      
      // Set status
      function setStatus(message, type = 'loading') {
        statusElement.innerHTML = message;
        statusElement.className = 'status-bar ' + type;
      }
      
      // Add retry button to status
      function addRetryButton() {
        const button = document.createElement('button');
        button.innerText = 'Retry';
        button.className = 'retry-button';
        button.onclick = loadFireData;
        statusElement.appendChild(button);
      }
      
      // Create a custom icon for the fire markers based on confidence
      function createFireIcon(confidence) {
        // Set color based on confidence
        let markerColor = 'red'; // Default
        
        if (confidence < 30) {
          markerColor = 'yellow';
        } else if (confidence < 80) {
          markerColor = 'orange';
        }
        
        return L.divIcon({
          html: `<div style="background-color: ${markerColor}; width: 10px; height: 10px; border-radius: 50%; border: 1px solid #fff;"></div>`,
          className: '',
          iconSize: [12, 12]
        });
      }
      
      // Display fire data on map
      function displayFires(fires) {
        // Clear existing markers
        markers.clearLayers();
        
        if (!fires || fires.length === 0) {
          setStatus('No fire data available', 'warning');
          return;
        }
        
        // Track valid points for bounds
        const validPoints = [];
        
        // Add markers for each fire
        fires.forEach(fire => {
          // Extract coordinates
          const lat = parseFloat(fire.latitude);
          const lng = parseFloat(fire.longitude);
          
          // Skip invalid coordinates
          if (isNaN(lat) || isNaN(lng)) {
            console.warn('Invalid coordinates:', fire);
            return;
          }
          
          // Get confidence level
          const confidence = parseFloat(fire.confidence || 0);
          
          // Create marker with appropriate icon
          const marker = L.marker([lat, lng], {
            icon: createFireIcon(confidence)
          });
          
          // Build popup content with all attributes
          let popupContent = '<div style="max-height: 200px; overflow-y: auto;">';
          popupContent += '<h4>Fire Detection</h4>';
          
          // Add all data to popup
          Object.keys(fire).forEach(key => {
            if (fire[key]) {
              // Format the label with proper casing
              const label = key.split('_')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                .join(' ');
              
              popupContent += `<strong>${label}:</strong> ${fire[key]}<br>`;
            }
          });
          
          popupContent += '</div>';
          marker.bindPopup(popupContent);
          markers.addLayer(marker);
          validPoints.push([lat, lng]);
        });
        
        // Fit map to bounds if we have points
        if (validPoints.length > 0) {
          map.fitBounds(validPoints);
          setStatus(`Showing ${validPoints.length} fire detections`, 'success');
        } else {
          setStatus('No fire detections found in this region', 'warning');
        }
      }
      
      // Function to construct the NASA FIRMS API URL
      function getNasaFirmsURL() {
        const days = daysSelect.value;
        const satellite = satelliteSelect.value;
        
        // NASA FIRMS provides a CSV endpoint
        // We're using a CORS proxy since FIRMS doesn't support CORS directly
        return `https://firms.modaps.eosdis.nasa.gov/api/country/csv/${satellite}/USA/${days}`;
      }
      
      // Parse CSV data from NASA FIRMS
      function parseCSV(text) {
        try {
          const lines = text.trim().split('\n');
          if (lines.length < 2) return [];
          
          const headers = lines[0].split(',').map(h => h.trim());
          
          return lines.slice(1).map(line => {
            // Handle CSV properly with quoted fields
            let values = [];
            let inQuotes = false;
            let currentValue = '';
            
            for (let i = 0; i < line.length; i++) {
              const char = line[i];
              
              if (char === '"' && (i === 0 || line[i-1] !== '\\')) {
                inQuotes = !inQuotes;
              } else if (char === ',' && !inQuotes) {
                values.push(currentValue);
                currentValue = '';
              } else {
                currentValue += char;
              }
            }
            values.push(currentValue); // Add the last field
            
            // Create object with headers as keys
            const item = {};
            headers.forEach((header, i) => {
              item[header] = values[i] ? values[i].replace(/"/g, '') : '';
            });
            
            return item;
          });
        } catch (e) {
          console.error('CSV parse error:', e);
          return [];
        }
      }
      
      // Load fire data
      function loadFireData() {
        setStatus('Loading fire data from NASA FIRMS...');
        
        // Show URL being fetched for debugging
        const url = getNasaFirmsURL();
        console.log('Fetching:', url);
        
        // Fetch data from FIRMS
        fetch(url)
          .then(response => {
            if (!response.ok) {
              throw new Error(`NASA FIRMS API returned status ${response.status}`);
            }
            return response.text();
          })
          .then(text => {
            // Parse CSV data
            const data = parseCSV(text);
            console.log('Parsed data:', data);
            displayFires(data);
          })
          .catch(error => {
            console.error('Error loading fire data:', error);
            setStatus(`Error: ${error.message}. Using fallback data.`, 'error');
            addRetryButton();
            
            // Use fallback data since the NASA API might be inaccessible directly
            // This is a sample of what FIRMS data looks like
            const fallbackData = [
              {
                latitude: 37.7749, longitude: -122.4194, 
                confidence: 95, brightness: 350, scan: 1.0, track: 1.0,
                acq_date: '2023-07-01', acq_time: '22:30',
                satellite: 'VIIRS', instrument: 'VIIRS', version: '1.0'
              },
              {
                latitude: 34.0522, longitude: -118.2437,
                confidence: 60, brightness: 320, scan: 1.0, track: 1.0,
                acq_date: '2023-07-01', acq_time: '22:30',
                satellite: 'VIIRS', instrument: 'VIIRS', version: '1.0'
              },
              {
                latitude: 38.5816, longitude: -121.4944,
                confidence: 30, brightness: 310, scan: 1.0, track: 1.0,
                acq_date: '2023-07-01', acq_time: '22:45',
                satellite: 'VIIRS', instrument: 'VIIRS', version: '1.0'
              }
            ];
            
            displayFires(fallbackData);
          });
      }
      
      // Set up event handlers
      refreshBtn.addEventListener('click', loadFireData);
      
      // Debug feature - click map to see coordinates
      map.on('click', function(e) {
        const coord = e.latlng;
        const lat = coord.lat.toFixed(6);
        const lng = coord.lng.toFixed(6);
        console.log(`Clicked at: ${lat}, ${lng}`);
        
        L.popup()
          .setLatLng(coord)
          .setContent(`<strong>Coordinates:</strong><br>${lat}, ${lng}`)
          .openOn(map);
      });
      
      // Initial load
      loadFireData();
    });
  </script>
</body>
</html>
