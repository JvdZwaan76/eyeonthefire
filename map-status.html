<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Eye on the Fire - Wildfire Map</title>
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://unpkg.com;
    style-src 'self' 'unsafe-inline' https://unpkg.com https://cdnjs.cloudflare.com;
    connect-src 'self' https://eyeonthefire.com;
    img-src 'self' https://tile.openstreetmap.org data:;
    font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com
  ">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Roboto', sans-serif;
    }
    #root {
      height: 100vh;
      position: relative;
    }
    .map-container {
      height: 100%;
      position: relative;
    }
    #map {
      height: 100%;
    }
    .loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.5em;
      color: #555;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const fallbackData = [
      { lat: 37.7749, lon: -122.4194, title: 'San Francisco Fire' },
      { lat: 34.0522, lon: -118.2437, title: 'Los Angeles Fire' }
    ];

    function parseCSV(csvText) {
      const rows = csvText.trim().split('\n').slice(1);
      return rows.map(row => {
        const columns = row.split(',');
        if (columns.length < 10) return null;
        const lat = parseFloat(columns[0]);
        const lon = parseFloat(columns[1]);
        const acqDate = columns[5];
        const acqTime = columns[6];
        if (!isNaN(lat) && !isNaN(lon)) {
          return { lat, lon, title: `Fire on ${acqDate} at ${acqTime}` };
        }
        return null;
      }).filter(fire => fire !== null);
    }

    async function loadFireData(retries = 3, delay = 1000) {
      for (let attempt = 1; attempt <= retries; attempt++) {
        try {
          const response = await fetch('/api/nasa/');
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          const csvText = await response.text();
          return parseCSV(csvText);
        } catch (error) {
          console.error(`Fetch attempt ${attempt} failed:`, error);
          if (attempt < retries) {
            await new Promise(res => setTimeout(res, delay));
            delay *= 2; // Exponential backoff
          } else {
            throw error;
          }
        }
      }
    }

    const MapComponent = () => {
      const [fires, setFires] = useState([]);
      const [loading, setLoading] = useState(true);
      const mapRef = useRef(null);
      const mapContainerRef = useRef(null);

      useEffect(() => {
        const initMap = async () => {
          setLoading(true);
          try {
            const data = await loadFireData();
            setFires(data);
          } catch (error) {
            console.error('Error fetching fire data:', error);
            setFires(fallbackData);
          } finally {
            setLoading(false);
          }
        };
        initMap();
      }, []);

      useEffect(() => {
        if (mapContainerRef.current && !mapRef.current) {
          mapRef.current = L.map(mapContainerRef.current).setView([36.0, -120.0], 6);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
          }).addTo(mapRef.current);
        }
      }, []);

      useEffect(() => {
        if (mapRef.current && fires.length > 0) {
          const markers = L.markerClusterGroup();
          fires.forEach(fire => {
            markers.addLayer(L.marker([fire.lat, fire.lon]).bindPopup(fire.title));
          });
          mapRef.current.addLayer(markers);
        }
      }, [fires]);

      return (
        <div className="map-container">
          {loading ? (
            <div className="loading">Loading wildfire data...</div>
          ) : (
            <div ref={mapContainerRef} id="map"></div>
          )}
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<MapComponent />);
  </script>
</body>
</html>
