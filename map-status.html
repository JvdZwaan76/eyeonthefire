<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Eye on the Fire - Real-Time US Wildfire Tracker</title>
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://unpkg.com https://www.googletagmanager.com https://static.cloudflareinsights.com;
    style-src 'self' 'unsafe-inline' https://unpkg.com https://fonts.googleapis.com https://cdnjs.cloudflare.com;
    connect-src 'self' https://eyeonthefire.com https://firms.modaps.eosdis.nasa.gov https://analytics.google.com https://stats.g.doubleclick.net;
    img-src 'self' https://tile.openstreetmap.org data:;
    frame-src 'self' https://firms.modaps.eosdis.nasa.gov;
    font-src 'self' https://fonts.gstatic.com
  ">
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-T8RE6KDBEW"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-T8RE6KDBEW');
  </script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/styles.css">
  <link rel="icon" type="image/png" href="/favicon.png">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
</head>
<body>
  <header>
    <nav class="navbar">
      <div class="logo">Eye on the Fire</div>
      <button class="hamburger" aria-label="Toggle navigation">
        <span></span>
        <span></span>
        <span></span>
      </button>
      <ul class="nav-menu">
        <li class="nav-item dropdown">
          <a href="#" class="nav-link">Prepare <i class="fas fa-caret-down"></i></a>
          <ul class="dropdown-menu">
            <li><a href="#evacuation">Evacuation Planning</a></li>
            <li><a href="#emergency-kit">Emergency Kit</a></li>
            <li><a href="#home-safety">Home Safety</a></li>
          </ul>
        </li>
        <li class="nav-item dropdown">
          <a href="#" class="nav-link">Prevent <i class="fas fa-caret-down"></i></a>
          <ul class="dropdown-menu">
            <li><a href="#defensible-space">Defensible Space</a></li>
            <li><a href="#home-hardening">Home Hardening</a></li>
            <li><a href="#fire-smart">Fire-Smart Landscaping</a></li>
          </ul>
        </li>
        <li class="nav-item dropdown">
          <a href="#" class="nav-link">Safety Info <i class="fas fa-caret-down"></i></a>
          <ul class="dropdown-menu">
            <li><a href="#wildfire-safety">Wildfire Safety Tips</a></li>
            <li><a href="#air-quality">Air Quality Monitoring</a></li>
            <li><a href="#emergency-contacts">Emergency Contacts</a></li>
          </ul>
        </li>
        <li class="nav-item dropdown">
          <a href="#" class="nav-link">News & Resources <i class="fas fa-caret-down"></i></a>
          <ul class="dropdown-menu">
            <li><a href="#news">Wildfire News</a></li>
            <li><a href="#resources">Fire Management Resources</a></li>
            <li><a href="#nifc">NIFC Updates</a></li>
          </ul>
        </li>
        <li class="nav-item">
          <a href="#contact" class="nav-link">Contact</a>
        </li>
      </ul>
    </nav>
  </header>
  <main>
    <section class="hero">
      <h1>Monitor US Wildfires in Real-Time</h1>
      <p>Stay informed with our interactive wildfire tracker.</p>
      <a href="#map-section" class="cta-button">View Live Map</a>
    </section>
    <section class="intro">
      <h2>Welcome to Eye on the Fire</h2>
      <p>Track wildfires across the US with real-time data and access safety resources to protect your community.</p>
    </section>
    <section id="map-section">
      <h2>Interactive Live US Wildfire Tracker</h2>
      <p>Use our map to monitor wildfire activity nationwide. Features include real-time fire locations, zoom controls, and geolocation.</p>
      <div id="root"></div>
    </section>
    <section class="about">
      <h2>Why Eye on the Fire?</h2>
      <p>Our platform provides up-to-date wildfire information to help you stay safe and informed.</p>
    </section>
    <section class="prevention">
      <h2>Wildfire Prevention Guides</h2>
      <p>Learn how to create defensible space, harden your home, and adopt fire-smart landscaping practices.</p>
    </section>
    <section class="community">
      <h2>Community Resources</h2>
      <p>Access national and local resources, including the <a href="https://www.nifc.gov">National Interagency Fire Center (NIFC)</a>.</p>
      <div class="gallery">
        <img src="/images/fire-response.jpg" alt="Fire response team">
        <img src="/images/community-recovery.jpg" alt="Community recovery efforts">
      </div>
    </section>
  </main>
  <footer>
    <div class="footer-content">
      <div class="company-info">
        <h3>Eye on the Fire</h3>
        <p>Providing real-time wildfire tracking and safety resources.</p>
      </div>
      <div class="quick-links">
        <h3>Quick Links</h3>
        <ul>
          <li><a href="#map-section">Live Map</a></li>
          <li><a href="#prevention">Prevention</a></li>
          <li><a href="#contact">Contact</a></li>
        </ul>
      </div>
      <div class="social-media">
        <h3>Follow Us</h3>
        <a href="https://x.com/eyeonthefire" class="fab fa-x"></a>
        <a href="https://facebook.com/eyeonthefire" class="fab fa-facebook"></a>
        <a href="https://instagram.com/eyeonthefire" class="fab fa-instagram"></a>
      </div>
    </div>
    <div class="legal">
      <p>© <span id="year"></span> Eye on the Fire. All rights reserved.</p>
      <p><a href="/terms">Terms of Use</a> | <a href="/privacy">Privacy Policy</a></p>
    </div>
  </footer>
  <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    function parseCSV(csvText) {
      console.log('Raw CSV data:', csvText.substring(0, 100));
      const rows = csvText.trim().split('\n').slice(1);
      const fires = rows.map(row => {
        const columns = row.split(',');
        if (columns.length < 10) {
          console.warn('Invalid row format:', row);
          return null;
        }
        const lat = parseFloat(columns[0]);
        const lon = parseFloat(columns[1]);
        const acqDate = columns[5];
        const acqTime = columns[6];
        if (!isNaN(lat) && !isNaN(lon)) {
          return { lat, lon, title: `Fire on ${acqDate} at ${acqTime}` };
        }
        return null;
      }).filter(fire => fire !== null);
      console.log('Parsed fires:', fires);
      return fires;
    }

    async function loadFireData() {
      try {
        const apiUrl = '/api/nasa/';
        console.log('Fetching from:', apiUrl);
        const response = await fetch(apiUrl);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const csvText = await response.text();
        const fires = parseCSV(csvText);
        console.log('Fetched fires:', fires.length);
        return fires;
      } catch (error) {
        console.error('Error fetching fire data:', error);
        const fallback = [
          { lat: 37.7749, lon: -122.4194, title: 'San Francisco Fire' },
          { lat: 34.0522, lon: -118.2437, title: 'Los Angeles Fire' }
        ];
        console.log('Using fallback data:', fallback);
        return fallback;
      }
    }

    const MapComponent = () => {
      const [fires, setFires] = useState([]);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const mapRef = useRef(null);
      const mapContainerRef = useRef(null);
      const initialized = useRef(false);

      useEffect(() => {
        if (!initialized.current) {
          initialized.current = true;
          loadFireData().then(data => {
            setFires(data);
            setLoading(false);
          }).catch(err => {
            setError('Failed to load fire data.');
            setLoading(false);
          });
        }
      }, []);

      useEffect(() => {
        if (mapContainerRef.current && !mapRef.current) {
          mapRef.current = L.map(mapContainerRef.current).setView([36.0, -120.0], 6);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
          }).addTo(mapRef.current);
          console.log('Map initialized');
        }
      }, []);

      useEffect(() => {
        if (mapRef.current && fires.length > 0) {
          const markers = fires.map(fire => {
            console.log(`Adding marker at: ${fire.lat}, ${fire.lon}`);
            return L.marker([fire.lat, fire.lon], {
              icon: L.icon({
                iconUrl: '/images/fire-icon.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32],
                popupAnchor: [0, -32]
              })
            }).bindPopup(fire.title);
          });
          const markerGroup = L.markerClusterGroup();
          markerGroup.addLayers(markers);
          mapRef.current.addLayer(markerGroup);
          console.log('Added markers:', fires.length);
        }
      }, [fires]);

      return (
        <div className="map-container">
          {loading && <div className="loading">Loading map...</div>}
          {error && <div className="error">{error}</div>}
          <div ref={mapContainerRef} id="map"></div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<MapComponent />);
  </script>
  <script>
    document.getElementById('year').textContent = new Date().getFullYear();
    const hamburger = document.querySelector('.hamburger');
    const navMenu = document.querySelector('.nav-menu');
    hamburger.addEventListener('click', () => {
      hamburger.classList.toggle('active');
      navMenu.classList.toggle('active');
    });
    document.querySelectorAll('.nav-link').forEach(link => {
      link.addEventListener('click', (e) => {
        const dropdown = link.nextElementSibling;
        if (dropdown && dropdown.classList.contains('dropdown-menu')) {
          e.preventDefault();
          dropdown.classList.toggle('active');
          link.querySelector('.fa-caret-down').classList.toggle('rotate');
        }
      });
    });
  </script>
  <script>var _0x3f3b=["https://eyeonthefire.com/cdn-cgi/rum?","POST","open","send"];var xhr=new XMLHttpRequest();xhr[_0x3f3b[2]](_0x3f3b[1],_0x3f3b[0]);xhr[_0x3f3b[3]]()</script>
  <script>var _0x4e4b=["https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015","createElement","script","src","async","appendChild"];var script=document[_0x4e4b[1]](_0x4e4b[2]);script[_0x4e4b[3]]=_0x4e4b[0];script[_0x4e4b[4]]=true;document.body[_0x4e4b[5]](script)</script>
</body>
</html>
