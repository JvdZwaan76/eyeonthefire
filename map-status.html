<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wildfire Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/react@17/umd/react.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7/babel.min.js"></script>
    <style>
        #map { height: 500px; width: 100%; }
        .search-container { margin: 1rem; }
        .search-input { padding: 0.5rem; margin-right: 0.5rem; }
        .search-button { padding: 0.5rem; background-color: #ff4500; color: white; border: none; cursor: pointer; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        const MapComponent = () => {
            const [fires, setFires] = useState([]);
            const [zip, setZip] = useState('');
            const [center, setCenter] = useState([37.7749, -122.4194]); // Default: San Francisco

            // Fetch wildfire data from NASA Worker
            useEffect(() => {
                fetch('https://eyeonthefire.com/api/nasa/')
                    .then(res => res.json())
                    .then(data => setFires(data.events || []))
                    .catch(err => console.error('Error fetching fires:', err));
            }, []);

            // Handle zip code search
            const handleSearch = async () => {
                try {
                    const geoResponse = await fetch(`https://eyeonthefire.com/api/opencage?q=${zip}`);
                    const geoData = await geoResponse.json();
                    if (geoData.results && geoData.results.length > 0) {
                        const { lat, lng } = geoData.results[0].geometry;
                        setCenter([lat, lng]);

                        // Fetch air quality data
                        const airResponse = await fetch(`https://eyeonthefire.com/api/airnow?zip=${zip}`);
                        const airData = await airResponse.json();
                        console.log('Air Quality:', airData); // Add to popup if desired
                    }
                } catch (err) {
                    console.error('Error during search:', err);
                }
            };

            return (
                <div>
                    <div className="search-container">
                        <input
                            type="text"
                            value={zip}
                            onChange={(e) => setZip(e.target.value)}
                            placeholder="Enter zip code"
                            className="search-input"
                        />
                        <button onClick={handleSearch} className="search-button">Search</button>
                    </div>
                    <div id="map"></div>
                </div>
            );
        };

        ReactDOM.render(<MapComponent />, document.getElementById('root'));

        // Initialize Leaflet map
        const map = L.map('map').setView([37.7749, -122.4194], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // Update map with fires
        function updateMap(fires, center) {
            map.eachLayer(layer => {
                if (layer instanceof L.Marker) map.removeLayer(layer);
            });
            map.setView(center, 10);
            fires.forEach(fire => {
                L.marker([fire.geometry[0].coordinates[1], fire.geometry[0].coordinates[0]])
                    .addTo(map)
                    .bindPopup(fire.title);
            });
        }

        // Observe changes in React state
        const observer = new MutationObserver(() => {
            const fires = JSON.parse(localStorage.getItem('fires') || '[]');
            const center = JSON.parse(localStorage.getItem('center') || '[37.7749, -122.4194]');
            updateMap(fires, center);
        });
        observer.observe(document.getElementById('root'), { childList: true, subtree: true });

        // Store state in localStorage for observer
        function updateLocalStorage() {
            const fires = React.Component.prototype.fires || [];
            const center = React.Component.prototype.center || [37.7749, -122.4194];
            localStorage.setItem('fires', JSON.stringify(fires));
            localStorage.setItem('center', JSON.stringify(center));
        }

        setInterval(updateLocalStorage, 100);
    </script>
</body>
</html>
