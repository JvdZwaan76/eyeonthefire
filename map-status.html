<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fire Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react@17/umd/react.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@17/umd/react-dom.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.20.6/babel.min.js"></script>
  <style>
    #map, .fallback-map {
      height: 500px;
      width: 100%;
      display: block;
    }
    .map-container {
      position: relative;
      width: 100%;
    }
    .map-status {
      padding: 10px;
      text-align: center;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const MapComponent = () => {
      const [fires, setFires] = useState([]);
      const [showFallback, setShowFallback] = useState(false);
      const [isLoading, setIsLoading] = useState(true);
      const mapRef = useRef(null);
      const mapContainerRef = useRef(null);

      console.log('Component mounted');

      const loadFireData = async () => {
        try {
          console.log('Fetching fire data...');
          const response = await fetch('https://eyeonthefire.com/api/nasa/');
          const data = await response.json();
          console.log('Fetched fire data:', data);
          const fireList = (data.events || []).map(event => {
            const lat = parseFloat(event.geometry[0].coordinates[1]);
            const lon = parseFloat(event.geometry[0].coordinates[0]);
            if (isNaN(lat) || isNaN(lon)) {
              console.warn('Invalid coordinates:', event);
              return null;
            }
            return { lat, lon, title: event.title || 'Active Fire' };
          }).filter(fire => fire !== null);
          setFires(fireList);
          console.log('Processed fires:', fireList.length);
          setShowFallback(false);
        } catch (error) {
          console.error('Error loading fire data:', error);
          setShowFallback(true);
        } finally {
          setIsLoading(false);
        }
      };

      useEffect(() => {
        loadFireData();
      }, []);

      useEffect(() => {
        if (!showFallback && mapContainerRef.current && !mapRef.current) {
          try {
            console.log('Initializing map...');
            mapRef.current = L.map(mapContainerRef.current).setView([39.8283, -98.5795], 4);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              attribution: 'Â© OpenStreetMap contributors | Eye on the Fire'
            }).addTo(mapRef.current);
            console.log('Map initialized successfully');
          } catch (error) {
            console.error('Map initialization error:', error);
            setShowFallback(true);
          }
        }
      }, [showFallback]);

      useEffect(() => {
        if (mapRef.current && !showFallback && fires.length > 0) {
          console.log('Adding markers...');
          const markers = fires.map(fire => 
            L.marker([fire.lat, fire.lon]).bindPopup(fire.title)
          );
          L.layerGroup(markers).addTo(mapRef.current);
          console.log('Markers added:', fires.length);
        }
      }, [fires, showFallback]);

      return (
        <div className="map-container">
          <div className="map-status">
            {isLoading ? 'Loading...' : 
             showFallback ? 'Using fallback map' : 
             fires.length === 0 ? 'No fires detected' : 
             `Displaying ${fires.length} fires`}
          </div>
          {showFallback ? (
            <iframe
              className="fallback-map"
              src="https://firms.modaps.eosdis.nasa.gov/map/#d:24hrs;@0.0,0.0,3z"
              title="NASA FIRMS Fire Map"
              frameBorder="0"
              allowFullScreen
            ></iframe>
          ) : (
            <div ref={mapContainerRef} id="map"></div>
          )}
        </div>
      );
    };

    ReactDOM.render(<MapComponent />, document.getElementById('root'));
  </script>
</body>
</html>
