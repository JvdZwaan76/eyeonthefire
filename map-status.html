<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fire Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map {
            height: 500px !important;
            width: 100% !important;
            display: block !important;
            position: relative;
            z-index: 1;
        }
        .map-container {
            position: relative;
            width: 100%;
            min-height: 500px;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script data-cfasync="false" src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script data-cfasync="false" src="https://cdn.jsdelivr.net/npm/react@17/umd/react.development.js"></script>
    <script data-cfasync="false" src="https://cdn.jsdelivr.net/npm/react-dom@17/umd/react-dom.development.js"></script>
    <script data-cfasync="false" src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.20.6/babel.min.js"></script>
    <script type="text/babel" data-cfasync="false">
        document.addEventListener('DOMContentLoaded', function() {
            const { useState, useEffect, useRef } = React;

            const MapComponent = () => {
                const [fires, setFires] = useState([]);
                const [showFallback, setShowFallback] = useState(false);
                const mapRef = useRef(null);
                const mapContainerRef = useRef(null);

                useEffect(() => {
                    console.log('Component mounted');
                    const loadFireData = async () => {
                        try {
                            const response = await fetch('https://eyeonthefire.com/api/nasa/');
                            const data = await response.json();
                            const fireList = (data.events || []).map(event => {
                                const lat = parseFloat(event.geometry[0].coordinates[1]);
                                const lon = parseFloat(event.geometry[0].coordinates[0]);
                                return isNaN(lat) || isNaN(lon) ? null : { lat, lon, title: event.title || 'Active Fire' };
                            }).filter(fire => fire !== null);
                            setFires(fireList);
                            console.log('Fires array length:', fireList.length);
                            setShowFallback(false);
                        } catch (error) {
                            console.error('Error loading fire data:', error);
                            setShowFallback(true);
                        }
                    };
                    loadFireData();
                }, []);

                useEffect(() => {
                    if (!showFallback && mapContainerRef.current && !mapRef.current) {
                        try {
                            console.log('Initializing map');
                            mapRef.current = L.map(mapContainerRef.current).setView([39.8283, -98.5795], 4);
                            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                attribution: 'Â© OpenStreetMap contributors | Eye on the Fire'
                            }).addTo(mapRef.current);
                            console.log('Map initialized');
                        } catch (error) {
                            console.error('Map initialization failed:', error);
                            setShowFallback(true);
                        }
                    }
                }, [showFallback]);

                useEffect(() => {
                    if (mapRef.current && !showFallback && fires.length > 0) {
                        console.log('Adding markers for fires:', fires.length);
                        const markers = fires.map(fire => L.marker([fire.lat, fire.lon]).bindPopup(fire.title));
                        L.layerGroup(markers).addTo(mapRef.current);
                    }
                }, [fires, showFallback]);

                console.log('Rendering, showFallback:', showFallback);

                return (
                    <div className="map-container">
                        {showFallback ? (
                            <iframe
                                src="https://firms.modaps.eosdis.nasa.gov/map/#d:24hrs;@0.0,0.0,3z"
                                title="NASA FIRMS Fire Map"
                                style={{ height: '500px', width: '100%' }}
                            ></iframe>
                        ) : (
                            <div ref={mapContainerRef} id="map"></div>
                        )}
                    </div>
                );
            };

            ReactDOM.render(<MapComponent />, document.getElementById('root'));
        });
    </script>
</body>
</html>
