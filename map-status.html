<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eye on the Fire - Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map {
            height: 500px;
            width: 100%;
        }
        .map-container {
            position: relative;
        }
        .error {
            color: red;
            padding: 10px;
        }
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5em;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" data-cfasync="false"></script>
    <script src="https://cdn.jsdelivr.net/npm/react@17/umd/react.development.js" data-cfasync="false"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@17/umd/react-dom.development.js" data-cfasync="false"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.20.6/babel.min.js" data-cfasync="false"></script>
    <script type="text/babel" data-cfasync="false">
        window.addEventListener('load', function() {
            const { useState, useEffect, useRef } = React;

            const MapComponent = () => {
                const [fires, setFires] = useState([]);
                const [loading, setLoading] = useState(true);
                const [error, setError] = useState(null);
                const mapRef = useRef(null);
                const mapContainerRef = useRef(null);

                useEffect(() => {
                    const loadFireData = async () => {
                        try {
                            const apiUrl = window.location.origin + '/api/nasa';
                            const response = await fetch(apiUrl);
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            const data = await response.json();
                            const fireList = data.events.map(event => {
                                const lat = parseFloat(event.latitude);
                                const lon = parseFloat(event.longitude);
                                const title = event.acq_date ? `Fire on ${event.acq_date}` : 'Active Fire';
                                return { lat, lon, title };
                            }).filter(fire => !isNaN(fire.lat) && !isNaN(fire.lon));
                            setFires(fireList);
                            setError(null);
                        } catch (error) {
                            console.error('Error fetching fire data:', error);
                            setError('Failed to load fire data from API.');
                            setFires([]);
                        } finally {
                            setLoading(false);
                        }
                    };
                    loadFireData();
                }, []);

                useEffect(() => {
                    if (mapContainerRef.current && !mapRef.current) {
                        try {
                            mapRef.current = L.map(mapContainerRef.current).setView([36.0, -120.0], 6);
                            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                attribution: 'Â© OpenStreetMap contributors | Eye on the Fire'
                            }).addTo(mapRef.current);
                        } catch (error) {
                            console.error('Map initialization failed:', error);
                            setError('Map initialization failed.');
                            setLoading(false);
                        }
                    }
                }, []);

                useEffect(() => {
                    if (mapRef.current && fires.length > 0) {
                        const markers = fires.map(fire => {
                            return L.marker([fire.lat, fire.lon]).bindPopup(fire.title);
                        });
                        L.layerGroup(markers).addTo(mapRef.current);
                    }
                }, [fires]);

                return (
                    <div className="map-container">
                        {loading && <div className="loading">Loading map...</div>}
                        {error && <div className="error">{error}</div>}
                        <div ref={mapContainerRef} id="map" style={{ height: '500px', width: '100%' }}></div>
                    </div>
                );
            };

            ReactDOM.render(<MapComponent />, document.getElementById('root'));
        });
    </script>
</body>
</html>
