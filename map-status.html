<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>USA Fire Map | Real-Time Fire Tracker</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    
    <!-- Pre-load the MarkerClusterer library -->
    <script src="https://unpkg.com/@googlemaps/markerclusterer@2.0.15/dist/index.min.js"></script>
    
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }
        
        #map-container {
            position: relative;
            height: 100vh;
            width: 100%;
            overflow: hidden;
        }
        
        #map {
            height: 100%;
            width: 100%;
        }
        
        #sidebar {
            position: absolute;
            top: 0;
            left: 0;
            width: 300px;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.2);
            overflow-y: auto;
            z-index: 1000;
            transition: transform 0.3s ease;
        }
        
        #sidebar.collapsed {
            transform: translateX(-300px);
        }
        
        #toggle-sidebar {
            position: absolute;
            left: 300px;
            top: 10px;
            background: white;
            padding: 8px 12px;
            border-radius: 0 4px 4px 0;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            z-index: 1000;
            transition: left 0.3s ease;
        }
        
        #toggle-sidebar.collapsed {
            left: 0;
        }
        
        .sidebar-content {
            padding: 15px;
            font-size: 0.9rem;
        }
        
        .sidebar-header {
            padding: 15px;
            border-bottom: 1px solid #ddd;
            background-color: #f8f9fa;
        }
        
        .sidebar-section {
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }
        
        .sidebar-section h5 {
            margin-bottom: 10px;
            color: #333;
            font-size: 1rem;
        }
        
        .form-group {
            margin-bottom: 12px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }
        
        .slider-container {
            display: flex;
            flex-direction: column;
            margin-bottom: 12px;
        }
        
        .slider-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.8rem;
        }
        
        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 900;
        }
        
        .map-control-btn {
            background: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            margin-bottom: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #555;
        }
        
        .map-control-btn:hover {
            background: #f0f0f0;
        }
        
        #legend {
            position: absolute;
            bottom: 30px;
            right: 10px;
            background: white;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            z-index: 900;
            max-width: 240px;
            font-size: 11px;
        }
        
        @media (max-width: 640px) {
            #legend {
                bottom: 10px;
                right: 10px;
                padding: 8px;
                max-width: 180px;
                font-size: 10px;
            }
            
            #sidebar {
                width: 260px;
            }
            
            #toggle-sidebar {
                left: 260px;
            }
            
            .map-control-btn {
                width: 36px;
                height: 36px;
                font-size: 16px;
                margin-bottom: 4px;
            }
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 4px 0;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 8px;
            border: 1px solid #ddd;
        }
        
        #status-panel {
            position: absolute;
            bottom: 30px;
            left: 310px;
            background: white;
            padding: 10px 15px;
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            z-index: 900;
            max-width: 400px;
            font-size: 14px;
            display: none;
            transition: left 0.3s ease;
        }
        
        #status-panel.sidebar-collapsed {
            left: 10px;
        }
        
        #stats-panel {
            position: absolute;
            top: 70px;
            right: 10px;
            background: white;
            padding: 15px;
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            z-index: 900;
            max-width: 300px;
            font-size: 13px;
            display: none;
        }
        
        .stats-title {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 10px;
            color: #333;
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .region-loading {
            position: absolute;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 15px;
            border-radius: 20px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            z-index: 900;
            font-size: 14px;
            display: none;
            text-align: center;
        }
        
        .region-loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-top-color: #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }
        
        .pagination-container {
            text-align: center;
            margin-top: 15px;
        }
        
        .pagination {
            display: inline-flex;
            justify-content: center;
        }
        
        .filter-tag {
            display: inline-block;
            background-color: #e9ecef;
            padding: 3px 8px;
            border-radius: 12px;
            margin-right: 4px;
            margin-bottom: 4px;
            font-size: 11px;
        }
        
        .filter-tag .remove-filter {
            margin-left: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        
        #active-filters {
            margin-bottom: 12px;
        }
        
        .custom-tooltip {
            position: absolute;
            background: white;
            padding: 8px;
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            display: none;
            font-size: 12px;
            max-width: 180px;
        }
        
        .color-scale {
            display: flex;
            margin-top: 5px;
            height: 8px;
            width: 100%;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .color-scale div {
            flex: 1;
            height: 8px;
        }
        
        .region-button {
            display: inline-block;
            margin: 4px;
            padding: 5px 10px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        
        .region-button:hover {
            background-color: #e9ecef;
        }
        
        .region-button.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        .region-buttons {
            margin-bottom: 10px;
        }
        
        #view-mode-toggle {
            position: absolute;
            bottom: 30px;
            left: 310px;
            background: white;
            padding: 8px 12px;
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            z-index: 900;
            font-size: 13px;
            transition: left 0.3s ease;
        }
        
        #view-mode-toggle.sidebar-collapsed {
            left: 10px;
        }
        
        .btn-xs {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            border-radius: 0.2rem;
        }
        
        .loading-data-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 15px 20px;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 1001;
            font-size: 14px;
            white-space: nowrap;
        }
        
        .loading-data-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-top-color: #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <div id="map-container">
        <div id="map"></div>
        
        <!-- Sidebar -->
        <div id="sidebar">
            <div class="sidebar-header">
                <h4><i class="fas fa-fire-flame-curved"></i> USA Fire Map</h4>
                <p class="text-muted mb-0" style="font-size: 12px;">NASA FIRMS Real-Time Fire Data</p>
            </div>
            
            <div class="sidebar-content">
                <div id="active-filters"></div>
                
                <div class="sidebar-section">
                    <h5>Quick View</h5>
                    <div class="region-buttons">
                        <div id="usa-button" class="region-button active" data-bounds="-125,24,-66,49">USA</div>
                        <div id="west-button" class="region-button" data-bounds="-125,31,-107,49">West</div>
                        <div id="central-button" class="region-button" data-bounds="-107,31,-90,49">Central</div>
                        <div id="east-button" class="region-button" data-bounds="-90,24,-66,49">East</div>
                        <div id="alaska-button" class="region-button" data-bounds="-170,51,-130,71">Alaska</div>
                        <div id="hawaii-button" class="region-button" data-bounds="-160,18,-154,23">Hawaii</div>
                    </div>
                </div>
                
                <div class="sidebar-section">
                    <h5>Data Source</h5>
                    <div class="form-group">
                        <select id="data-source" class="form-select form-select-sm">
                            <option value="MODIS_NRT">MODIS (Near Real-Time)</option>
                            <option value="VIIRS_NOAA20_NRT">VIIRS NOAA-20 (Near Real-Time)</option>
                            <option value="VIIRS_SNPP_NRT">VIIRS Suomi NPP (Near Real-Time)</option>
                            <option value="VIIRS_NOAA21_NRT">VIIRS NOAA-21 (Near Real-Time)</option>
                        </select>
                    </div>
                </div>
                
                <div class="sidebar-section">
                    <h5>Time Range</h5>
                    <div class="form-group">
                        <select id="days-range" class="form-select form-select-sm">
                            <option value="1">Last 24 hours</option>
                            <option value="2">Last 2 days</option>
                            <option value="3">Last 3 days</option>
                            <option value="7">Last 7 days</option>
                            <option value="10">Last 10 days</option>
                        </select>
                    </div>
                </div>
                
                <div class="sidebar-section">
                    <h5>Fire Filters</h5>
                    
                    <div class="form-group">
                        <label for="confidence-range">Confidence Level: <span id="confidence-min">0%</span></label>
                        <input type="range" class="form-range" id="confidence-range" min="0" max="100" value="0">
                    </div>
                    
                    <div class="form-group">
                        <label for="frp-range">Fire Power (MW): <span id="frp-min">0</span></label>
                        <input type="range" class="form-range" id="frp-range" min="0" max="100" value="0">
                    </div>
                </div>
                
                <div class="sidebar-section">
                    <h5>Display Options</h5>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="enable-clustering" checked>
                        <label class="form-check-label" for="enable-clustering">
                            Enable Clustering
                        </label>
                    </div>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="show-heatmap">
                        <label class="form-check-label" for="show-heatmap">
                            Show Heatmap
                        </label>
                    </div>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="lazy-loading" checked>
                        <label class="form-check-label" for="lazy-loading">
                            Lazy Load Data (Recommended)
                        </label>
                        <small class="form-text text-muted d-block">
                            Only loads data for visible map area
                        </small>
                    </div>
                    
                    <div class="form-group mt-2">
                        <label for="markers-per-page">Max Visible Markers</label>
                        <select id="markers-per-page" class="form-select form-select-sm">
                            <option value="500">500 (Fast)</option>
                            <option value="1000" selected>1,000 (Balanced)</option>
                            <option value="3000">3,000 (Detailed)</option>
                            <option value="10000">10,000 (Full)</option>
                        </select>
                    </div>
                </div>
                
                <div class="sidebar-section">
                    <button id="apply-filters" class="btn btn-primary btn-sm w-100">
                        <i class="fas fa-filter"></i> Apply Filters
                    </button>
                    
                    <button id="reset-filters" class="btn btn-outline-secondary btn-sm w-100 mt-2">
                        <i class="fas fa-sync"></i> Reset Filters
                    </button>
                </div>
                
                <div class="pagination-container">
                    <div class="btn-group pagination">
                        <button id="prev-page" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span id="page-info" class="btn btn-sm btn-outline-secondary disabled">
                            <span id="current-page">1</span>/<span id="total-pages">1</span>
                        </span>
                        <button id="next-page" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="toggle-sidebar">
            <i class="fas fa-chevron-left"></i>
        </div>
        
        <!-- Map Controls -->
        <div class="map-controls">
            <button class="map-control-btn" id="zoom-in" title="Zoom In">
                <i class="fas fa-plus"></i>
            </button>
            <button class="map-control-btn" id="zoom-out" title="Zoom Out">
                <i class="fas fa-minus"></i>
            </button>
            <button class="map-control-btn" id="recenter" title="Recenter Map">
                <i class="fas fa-location-crosshairs"></i>
            </button>
            <button class="map-control-btn" id="show-stats" title="Show Statistics">
                <i class="fas fa-chart-simple"></i>
            </button>
        </div>
        
        <!-- Legend -->
        <div id="legend">
            <h6 style="font-size: 12px; margin-top: 0;">Fire Confidence</h6>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #FF0000;"></div>
                <span>High (80-100%)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #FF4500;"></div>
                <span>Medium (60-79%)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #FFA500;"></div>
                <span>Low (30-59%)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #FFCC00;"></div>
                <span>Very Low (0-29%)</span>
            </div>
            <div style="margin-top: 6px; font-size: 10px;">
                <strong>Circle Size:</strong> Fire Power (MW)
            </div>
            <div class="color-scale">
                <div style="background-color: #FFCC00;"></div>
                <div style="background-color: #FFA500;"></div>
                <div style="background-color: #FF4500;"></div>
                <div style="background-color: #FF0000;"></div>
            </div>
        </div>
        
        <!-- Status Panel -->
        <div id="status-panel"></div>
        
        <!-- View Mode Toggle -->
        <div id="view-mode-toggle">
            <button id="global-mode" class="btn btn-sm btn-outline-primary">
                <i class="fas fa-globe"></i> Global View
            </button>
            <button id="usa-mode" class="btn btn-sm btn-primary">
                <i class="fas fa-flag-usa"></i> USA Only
            </button>
        </div>
        
        <!-- Region Loading Indicator -->
        <div id="region-loading" class="region-loading">
            <span class="region-loading-spinner"></span>
            Loading fire data for this region...
        </div>
        
        <!-- Loading Data Message -->
        <div id="loading-data-message" class="loading-data-message">
            <span class="loading-data-spinner"></span>
            Loading USA fire data...
        </div>
        
        <!-- Stats Panel -->
        <div id="stats-panel">
            <div class="stats-title">
                <i class="fas fa-chart-simple"></i> Fire Statistics
                <button type="button" class="btn-close float-end" id="close-stats" aria-label="Close"></button>
            </div>
            <div id="stats-content"></div>
        </div>
        
        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loading-overlay">
            <div class="spinner"></div>
            <p id="loading-message">Initializing map...</p>
        </div>
    </div>
    
    <!-- Custom Tooltip -->
    <div id="custom-tooltip" class="custom-tooltip"></div>
    
    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Main Fire Map Script -->
    <script>
        // Fire Map class
        class FireMap {
            constructor() {
                // Configuration
                this.config = {
                    // API endpoint (updated to only use the world parameter which works)
                    apiEndpoint: 'https://eyeonthefire.com/api/nasa/firms',
                    // Default center (center of contiguous USA)
                    defaultCenter: { lat: 39.5, lng: -98.35 },
                    // Default zoom level
                    defaultZoom: 4,
                    // US boundary
                    usBounds: {
                        west: -125,
                        south: 24,
                        east: -66,
                        north: 49
                    },
                    // Maximum retries for API fetching
                    maxFetchRetries: 3,
                    // Mobile breakpoint
                    mobileBreakpoint: 768
                };
                
                // State management
                this.state = {
                    // Google Map instance
                    map: null,
                    // Current viewport
                    viewport: {
                        north: 0,
                        south: 0,
                        east: 0,
                        west: 0
                    },
                    // Map bounds
                    mapBounds: null,
                    // Markers
                    markers: [],
                    // Marker clusterer
                    markerClusterer: null,
                    // Heatmap layer
                    heatmap: null,
                    // Total fire data points
                    totalFirePoints: 0,
                    // Filtered fire data
                    filteredData: [],
                    // All fire data
                    allFireData: [],
                    // Current page
                    currentPage: 1,
                    // Markers per page
                    markersPerPage: 1000,
                    // Active filters
                    activeFilters: {},
                    // Map info window
                    infoWindow: null,
                    // Region data cache
                    regionDataCache: new Map(),
                    // View mode (usa or global)
                    viewMode: 'usa',
                    // Lazy loading enabled
                    lazyLoading: true,
                    // Currently loading regions
                    loadingRegions: new Set(),
                    // Mobile detection
                    isMobile: window.innerWidth < 768,
                    // Map loaded
                    mapLoaded: false
                };
                
                // Initialize the application
                this.initialize();
            }
            
            // Initialize the fire map
            async initialize() {
                console.log('Initializing FireMap application');
                
                // Check if we're on mobile
                this.checkMobile();
                
                // Setup UI event listeners
                this.setupEventListeners();
                
                try {
                    // Wait for Google Maps to load
                    await this.waitForGoogleMaps();
                    
                    // Initialize the map
                    this.initializeMap();
                    
                    // Load initial USA fire data
                    this.showLoadingMessage('Loading USA fire data...');
                    await this.loadUSAFireData();
                    this.hideLoadingMessage();
                    
                    // Mark map as loaded
                    this.state.mapLoaded = true;
                } catch (error) {
                    console.error('Error initializing application:', error);
                    this.showStatus('Error initializing application: ' + error.message, 'error');
                    this.hideLoadingMessage();
                }
            }
            
            // Check if device is mobile
            checkMobile() {
                this.state.isMobile = window.innerWidth < this.config.mobileBreakpoint;
                
                // Adjust UI for mobile if needed
                if (this.state.isMobile) {
                    // If mobile, start with sidebar collapsed
                    setTimeout(() => {
                        $('#sidebar').addClass('collapsed');
                        $('#toggle-sidebar').addClass('collapsed');
                        $('#toggle-sidebar i').removeClass('fa-chevron-left').addClass('fa-chevron-right');
                        $('#status-panel').addClass('sidebar-collapsed');
                        $('#view-mode-toggle').addClass('sidebar-collapsed');
                    }, 500);
                }
            }
            
            // Wait for Google Maps to be available
            waitForGoogleMaps() {
                return new Promise((resolve) => {
                    // Check if Google Maps is already loaded
                    if (typeof google !== 'undefined' && typeof google.maps !== 'undefined') {
                        console.log('Google Maps already loaded');
                        resolve();
                        return;
                    }
                    
                    console.log('Waiting for Google Maps to load');
                    
                    // Check periodically if Google Maps is loaded
                    const checkInterval = setInterval(() => {
                        if (typeof google !== 'undefined' && typeof google.maps !== 'undefined') {
                            clearInterval(checkInterval);
                            console.log('Google Maps loaded successfully');
                            resolve();
                        }
                    }, 100);
                    
                    // Timeout after 10 seconds
                    setTimeout(() => {
                        clearInterval(checkInterval);
                        if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
                            console.error('Google Maps failed to load within timeout');
                            resolve(); // Resolve anyway to prevent hanging
                        }
                    }, 10000);
                });
            }
            
            // Initialize Google Map
            initializeMap() {
                this.showStatus('Initializing map...');
                
                try {
                    console.log('Creating Google Map instance');
                    
                    // Create the map
                    this.state.map = new google.maps.Map(document.getElementById('map'), {
                        center: this.config.defaultCenter,
                        zoom: this.config.defaultZoom,
                        mapTypeId: 'terrain',
                        mapTypeControl: true,
                        mapTypeControlOptions: {
                            style: google.maps.MapTypeControlStyle.DROPDOWN_MENU,
                            position: google.maps.ControlPosition.TOP_LEFT
                        },
                        fullscreenControl: false,
                        streetViewControl: false,
                        zoomControlOptions: {
                            position: google.maps.ControlPosition.RIGHT_BOTTOM
                        },
                        restriction: {
                            latLngBounds: {
                                north: 85,
                                south: -85,
                                west: -180,
                                east: 180
                            }
                        }
                    });
                    
                    // Create info window
                    this.state.infoWindow = new google.maps.InfoWindow();
                    
                    // Add idle event listener to detect viewport changes
                    google.maps.event.addListener(this.state.map, 'idle', () => {
                        // Get current viewport
                        const bounds = this.state.map.getBounds();
                        if (bounds) {
                            const ne = bounds.getNorthEast();
                            const sw = bounds.getSouthWest();
                            
                            this.state.viewport = {
                                north: ne.lat(),
                                east: ne.lng(),
                                south: sw.lat(),
                                west: sw.lng()
                            };
                            
                            // If lazy loading is enabled, load data for the current viewport
                            if (this.state.lazyLoading && this.state.mapLoaded) {
                                this.loadDataForViewport();
                            }
                        }
                    });
                    
                    // Initially set bounds to USA
                    this.focusOnUSA();
                    
                    // Hide loading overlay
                    this.hideLoading();
                    
                    // Show success message
                    this.showStatus('Map initialized successfully', 'success');
                    
                    console.log('Map initialized successfully');
                    
                    return true;
                } catch (error) {
                    console.error('Error initializing map:', error);
                    this.showStatus('Error initializing map: ' + error.message, 'error');
                    return false;
                }
            }
            
            // Set up UI event listeners
            setupEventListeners() {
                console.log('Setting up event listeners');
                
                // Sidebar toggle
                $('#toggle-sidebar').on('click', () => {
                    $('#sidebar').toggleClass('collapsed');
                    $('#toggle-sidebar').toggleClass('collapsed');
                    $('#status-panel').toggleClass('sidebar-collapsed');
                    $('#view-mode-toggle').toggleClass('sidebar-collapsed');
                    
                    // Update the toggle icon
                    if ($('#sidebar').hasClass('collapsed')) {
                        $('#toggle-sidebar i').removeClass('fa-chevron-left').addClass('fa-chevron-right');
                    } else {
                        $('#toggle-sidebar i').removeClass('fa-chevron-right').addClass('fa-chevron-left');
                    }
                });
                
                // Map control buttons
                $('#zoom-in').on('click', () => {
                    const currentZoom = this.state.map.getZoom();
                    this.state.map.setZoom(currentZoom + 1);
                });
                
                $('#zoom-out').on('click', () => {
                    const currentZoom = this.state.map.getZoom();
                    this.state.map.setZoom(currentZoom - 1);
                });
                
                $('#recenter').on('click', () => {
                    this.recenterMap();
                });
                
                $('#show-stats').on('click', () => {
                    this.showStatistics();
                });
                
                $('#close-stats').on('click', () => {
                    $('#stats-panel').hide();
                });
                
                // Apply filters button
                $('#apply-filters').on('click', () => {
                    this.applyFilters();
                });
                
                // Reset filters button
                $('#reset-filters').on('click', () => {
                    this.resetFilters();
                });
                
                // Region buttons
                $('.region-button').on('click', (e) => {
                    const $btn = $(e.currentTarget);
                    $('.region-button').removeClass('active');
                    $btn.addClass('active');
                    
                    const bounds = $btn.data('bounds');
                    if (bounds) {
                        const [west, south, east, north] = bounds.split(',').map(Number);
                        this.focusOnRegion(north, south, east, west);
                    }
                });
                
                // View mode toggle buttons
                $('#usa-mode').on('click', () => {
                    this.setViewMode('usa');
                    $('#usa-mode').removeClass('btn-outline-primary').addClass('btn-primary');
                    $('#global-mode').removeClass('btn-primary').addClass('btn-outline-primary');
                    this.focusOnUSA();
                });
                
                $('#global-mode').on('click', () => {
                    this.setViewMode('global');
                    $('#global-mode').removeClass('btn-outline-primary').addClass('btn-primary');
                    $('#usa-mode').removeClass('btn-primary').addClass('btn-outline-primary');
                });
                
                // Pagination buttons
                $('#prev-page').on('click', () => {
                    if (this.state.currentPage > 1) {
                        this.state.currentPage--;
                        this.updateMarkers();
                    }
                });
                
                $('#next-page').on('click', () => {
                    const totalPages = this.getTotalPages();
                    if (this.state.currentPage < totalPages) {
                        this.state.currentPage++;
                        this.updateMarkers();
                    }
                });
                
                // Show/hide heatmap
                $('#show-heatmap').on('change', () => {
                    this.toggleHeatmap($('#show-heatmap').is(':checked'));
                });
                
                // Change cluster status
                $('#enable-clustering').on('change', () => {
                    this.updateMarkers();
                });
                
                // Change lazy loading option
                $('#lazy-loading').on('change', () => {
                    this.state.lazyLoading = $('#lazy-loading').is(':checked');
                    
                    if (!this.state.lazyLoading) {
                        // If turning off lazy loading, load all data for the current view mode
                        if (this.state.viewMode === 'usa') {
                            this.loadUSAFireData();
                        } else {
                            // In global mode without lazy loading, load world data
                            this.loadWorldFireData();
                        }
                    }
                });
                
                // Change markers per page
                $('#markers-per-page').on('change', () => {
                    this.state.markersPerPage = parseInt($('#markers-per-page').val());
                    this.state.currentPage = 1;
                    this.updateMarkers();
                });
                
                // Sliders for confidence and FRP
                $('#confidence-range').on('input', function() {
                    const value = parseInt($(this).val());
                    $('#confidence-min').text(value + '%');
                });
                
                $('#frp-range').on('input', function() {
                    const value = parseInt($(this).val());
                    if (value === 0) {
                        $('#frp-min').text('0');
                    } else {
                        $('#frp-min').text(value);
                    }
                });
                
                // Handle window resize
                window.addEventListener('resize', () => {
                    this.checkMobile();
                });
            }
            
            // Set the view mode (usa or global)
            setViewMode(mode) {
                this.state.viewMode = mode;
                
                if (mode === 'usa') {
                    this.focusOnUSA();
                    this.loadUSAFireData();
                }
            }
            
            // Focus map on USA
            focusOnUSA() {
                const bounds = new google.maps.LatLngBounds(
                    new google.maps.LatLng(this.config.usBounds.south, this.config.usBounds.west),
                    new google.maps.LatLng(this.config.usBounds.north, this.config.usBounds.east)
                );
                
                this.state.map.fitBounds(bounds);
            }
            
            // Focus on a specific region
            focusOnRegion(north, south, east, west) {
                const bounds = new google.maps.LatLngBounds(
                    new google.maps.LatLng(south, west),
                    new google.maps.LatLng(north, east)
                );
                
                this.state.map.fitBounds(bounds);
            }
            
            // Load data for the current viewport (for lazy loading)
            async loadDataForViewport() {
                // Skip if we're already loading data for this viewport
                const viewportString = JSON.stringify(this.state.viewport);
                if (this.state.loadingRegions.has(viewportString)) {
                    return;
                }
                
                // Check if this is a USA viewport
                const isUSAViewport = this.isViewportInUSA();
                
                // In USA mode, only load data for USA viewports
                if (this.state.viewMode === 'usa' && !isUSAViewport) {
                    return;
                }
                
                // Check if we have cached data for this viewport
                if (this.state.regionDataCache.has(viewportString)) {
                    console.log('Using cached data for viewport:', this.state.viewport);
                    return;
                }
                
                // Mark this viewport as loading
                this.state.loadingRegions.add(viewportString);
                
                // Show loading indicator
                this.showRegionLoading();
                
                try {
                    // Build request URL with parameters
                    let url = this.config.apiEndpoint;
                    const params = new URLSearchParams();
                    
                    // Add source parameter (default: MODIS_NRT)
                    const source = this.state.activeFilters.source?.value || 'MODIS_NRT';
                    params.append('source', source);
                    
                    // Always use "world" as the area parameter
                    params.append('area', 'world');
                    
                    // Add days parameter (default: 1)
                    const days = this.state.activeFilters.days?.value || '1';
                    params.append('days', days);
                    
                    // Append parameters to URL
                    url = `${url}?${params.toString()}`;
                    
                    console.log(`Fetching fire data for viewport:`, this.state.viewport);
                    
                    // Fetch data from API
                    const response = await this.fetchWithRetry(url);
                    
                    // Process response
                    if (response.ok) {
                        try {
                            const data = await response.json();
                            
                            if (Array.isArray(data)) {
                                // Success! We have fire data
                                console.log(`Received ${data.length} fire data points`);
                                
                                // Filter data to current viewport
                                const viewportData = this.filterDataToViewport(data, this.state.viewport);
                                console.log(`${viewportData.length} points are in current viewport`);
                                
                                // Cache the viewport data
                                this.state.regionDataCache.set(viewportString, viewportData);
                                
                                // Merge with existing data
                                this.mergeFireData(viewportData);
                                
                                // Update markers
                                this.filterData();
                                this.updateMarkers();
                                
                                this.showStatus(`Loaded ${viewportData.length} fire data points for this area`, 'success');
                            }
                        } catch (error) {
                            console.error('Error processing viewport data:', error);
                        }
                    }
                } catch (error) {
                    console.error('Error loading viewport data:', error);
                } finally {
                    // Remove this viewport from loading regions
                    this.state.loadingRegions.delete(viewportString);
                    
                    // Hide loading indicator if no more regions are loading
                    if (this.state.loadingRegions.size === 0) {
                        this.hideRegionLoading();
                    }
                }
            }
            
            // Merge new fire data with existing data
            mergeFireData(newData) {
                // If we have no existing data, just use the new data
                if (this.state.allFireData.length === 0) {
                    this.state.allFireData = [...newData];
                    return;
                }
                
                // Create a set of existing IDs
                const existingIds = new Set();
                this.state.allFireData.forEach(point => {
                    // Use a combination of coordinates, date, and time as a unique ID
                    const id = `${point.latitude},${point.longitude},${point.acq_date || ''},${point.acq_time || ''}`;
                    existingIds.add(id);
                });
                
                // Filter out duplicates and add new points
                const uniqueNewData = newData.filter(point => {
                    const id = `${point.latitude},${point.longitude},${point.acq_date || ''},${point.acq_time || ''}`;
                    return !existingIds.has(id);
                });
                
                // Merge with existing data
                this.state.allFireData = [...this.state.allFireData, ...uniqueNewData];
                console.log(`Added ${uniqueNewData.length} new unique fire points`);
            }
            
            // Filter data to a specific viewport
            filterDataToViewport(data, viewport) {
                return data.filter(point => {
                    const lat = parseFloat(point.latitude);
                    const lng = parseFloat(point.longitude);
                    
                    return (
                        lat >= viewport.south &&
                        lat <= viewport.north &&
                        lng >= viewport.west &&
                        lng <= viewport.east
                    );
                });
            }
            
            // Check if the current viewport is within the USA
            isViewportInUSA() {
                const viewport = this.state.viewport;
                const usBounds = this.config.usBounds;
                
                // Check if the viewport overlaps with the USA bounds
                return !(
                    viewport.north < usBounds.south ||
                    viewport.south > usBounds.north ||
                    viewport.east < usBounds.west ||
                    viewport.west > usBounds.east
                );
            }
            
            // Load USA fire data
            async loadUSAFireData() {
                this.showStatus('Loading USA fire data...');
                
                try {
                    // Build request URL with parameters
                    let url = this.config.apiEndpoint;
                    const params = new URLSearchParams();
                    
                    // Add source parameter (default: MODIS_NRT)
                    const source = this.state.activeFilters.source?.value || 'MODIS_NRT';
                    params.append('source', source);
                    
                    // Always use "world" as the area parameter
                    params.append('area', 'world');
                    
                    // Add days parameter (default: 1)
                    const days = this.state.activeFilters.days?.value || '1';
                    params.append('days', days);
                    
                    // Append parameters to URL
                    url = `${url}?${params.toString()}`;
                    
                    console.log(`Fetching USA fire data: ${url}`);
                    
                    // Fetch data from API
                    const response = await this.fetchWithRetry(url);
                    
                    // Process response
                    if (response.ok) {
                        try {
                            const data = await response.json();
                            
                            if (Array.isArray(data)) {
                                // Success! We have fire data
                                console.log(`Received ${data.length} global fire data points`);
                                
                                // Filter to USA only
                                const usaData = this.filterDataToUSA(data);
                                console.log(`${usaData.length} fire points are in the USA`);
                                
                                // Store and process the data
                                this.processFireData(usaData);
                                
                                this.showStatus(`Loaded ${usaData.length} USA fire data points`, 'success');
                            } else if (data.error) {
                                // API returned an error
                                throw new Error(data.message || 'Unknown API error');
                            } else {
                                // Unexpected response format
                                throw new Error('Unexpected response format from API');
                            }
                        } catch (error) {
                            console.error(`Error parsing API response: ${error.message}`);
                            throw error;
                        }
                    } else {
                        throw new Error(`API responded with status ${response.status}`);
                    }
                } catch (error) {
                    console.error(`Error loading USA fire data: ${error.message}`);
                    this.showStatus(`Error loading USA fire data: ${error.message}`, 'error');
                    
                    // Generate sample data if no data is available
                    if (this.state.allFireData.length === 0) {
                        console.warn('Generating sample data as fallback');
                        this.generateSampleData();
                    }
                }
            }
            
            // Filter data to USA boundaries
            filterDataToUSA(data) {
                const usBounds = this.config.usBounds;
                
                // Add Alaska
                const alaskaBounds = {
                    west: -170,
                    south: 51,
                    east: -130,
                    north: 71
                };
                
                // Add Hawaii
                const hawaiiBounds = {
                    west: -160,
                    south: 18,
                    east: -154,
                    north: 23
                };
                
                return data.filter(point => {
                    const lat = parseFloat(point.latitude);
                    const lng = parseFloat(point.longitude);
                    
                    // Check continental US
                    const inContUS = (
                        lat >= usBounds.south &&
                        lat <= usBounds.north &&
                        lng >= usBounds.west &&
                        lng <= usBounds.east
                    );
                    
                    // Check Alaska
                    const inAlaska = (
                        lat >= alaskaBounds.south &&
                        lat <= alaskaBounds.north &&
                        lng >= alaskaBounds.west &&
                        lng <= alaskaBounds.east
                    );
                    
                    // Check Hawaii
                    const inHawaii = (
                        lat >= hawaiiBounds.south &&
                        lat <= hawaiiBounds.north &&
                        lng >= hawaiiBounds.west &&
                        lng <= hawaiiBounds.east
                    );
                    
                    return inContUS || inAlaska || inHawaii;
                });
            }
            
            // Load global fire data
            async loadWorldFireData() {
                if (!this.state.lazyLoading) {
                    this.showLoadingMessage('Loading global fire data...');
                }
                
                this.showStatus('Loading global fire data...');
                
                try {
                    // Build request URL with parameters
                    let url = this.config.apiEndpoint;
                    const params = new URLSearchParams();
                    
                    // Add source parameter (default: MODIS_NRT)
                    const source = this.state.activeFilters.source?.value || 'MODIS_NRT';
                    params.append('source', source);
                    
                    // Always use "world" as the area parameter
                    params.append('area', 'world');
                    
                    // Add days parameter (default: 1)
                    const days = this.state.activeFilters.days?.value || '1';
                    params.append('days', days);
                    
                    // Append parameters to URL
                    url = `${url}?${params.toString()}`;
                    
                    console.log(`Fetching global fire data: ${url}`);
                    
                    // Fetch data from API
                    const response = await this.fetchWithRetry(url);
                    
                    // Process response
                    if (response.ok) {
                        try {
                            const data = await response.json();
                            
                            if (Array.isArray(data)) {
                                // Success! We have fire data
                                console.log(`Received ${data.length} global fire data points`);
                                
                                // Store and process the data
                                this.processFireData(data);
                                
                                this.showStatus(`Loaded ${data.length} global fire data points`, 'success');
                            } else if (data.error) {
                                // API returned an error
                                throw new Error(data.message || 'Unknown API error');
                            } else {
                                // Unexpected response format
                                throw new Error('Unexpected response format from API');
                            }
                        } catch (error) {
                            console.error(`Error parsing API response: ${error.message}`);
                            throw error;
                        }
                    } else {
                        throw new Error(`API responded with status ${response.status}`);
                    }
                } catch (error) {
                    console.error(`Error loading global fire data: ${error.message}`);
                    this.showStatus(`Error loading global fire data: ${error.message}`, 'error');
                    
                    // Generate sample data if no data is available
                    if (this.state.allFireData.length === 0) {
                        console.warn('Generating sample data as fallback');
                        this.generateSampleData();
                    }
                } finally {
                    if (!this.state.lazyLoading) {
                        this.hideLoadingMessage();
                    }
                }
            }
            
            // Recenter the map
            recenterMap() {
                if (this.state.viewMode === 'usa') {
                    this.focusOnUSA();
                } else if (this.state.filteredData.length > 0) {
                    // Create bounds from filtered data
                    const bounds = new google.maps.LatLngBounds();
                    this.state.filteredData.forEach(point => {
                        bounds.extend(new google.maps.LatLng(parseFloat(point.latitude), parseFloat(point.longitude)));
                    });
                    
                    // Fit map to these bounds
                    this.state.map.fitBounds(bounds);
                } else {
                    // Reset to default view
                    this.state.map.setCenter(this.config.defaultCenter);
                    this.state.map.setZoom(this.config.defaultZoom);
                }
            }
            
            // Apply filters
            applyFilters() {
                // Update active filters
                this.updateActiveFilters();
                
                // If source or days changed, reload data
                if (this.state.activeFilters.source || this.state.activeFilters.days) {
                    // Clear data cache
                    this.state.regionDataCache.clear();
                    
                    // Reload data based on view mode
                    if (this.state.viewMode === 'usa') {
                        this.loadUSAFireData();
                    } else if (this.state.lazyLoading) {
                        // In global lazy loading mode, load for current viewport
                        this.loadDataForViewport();
                    } else {
                        // In global non-lazy mode, load all data
                        this.loadWorldFireData();
                    }
                } else {
                    // Just apply client-side filters
                    this.filterData();
                    this.updateMarkers();
                }
            }
            
            // Reset all filters
            resetFilters() {
                // Reset form controls
                $('#data-source').val('MODIS_NRT');
                $('#days-range').val('1');
                $('#confidence-range').val(0);
                $('#frp-range').val(0);
                $('#confidence-min').text('0%');
                $('#frp-min').text('0');
                $('#enable-clustering').prop('checked', true);
                $('#show-heatmap').prop('checked', false);
                $('#markers-per-page').val('1000');
                
                // Reset state
                this.state.markersPerPage = 1000;
                this.state.currentPage = 1;
                this.state.activeFilters = {};
                
                // Clear filter tags
                $('#active-filters').empty();
                
                // Clear data cache
                this.state.regionDataCache.clear();
                
                // Reset and load data based on view mode
                if (this.state.viewMode === 'usa') {
                    this.loadUSAFireData();
                } else {
                    this.loadWorldFireData();
                }
            }
            
            // Update active filters based on form inputs
            updateActiveFilters() {
                // Clear existing filters
                this.state.activeFilters = {};
                
                // Clear filter tags UI
                $('#active-filters').empty();
                
                // Data source
                const source = $('#data-source').val();
                const sourceText = $('#data-source option:selected').text();
                if (source !== 'MODIS_NRT') {
                    this.state.activeFilters.source = { value: source, label: sourceText };
                    this.addFilterTag('source', sourceText, () => {
                        $('#data-source').val('MODIS_NRT');
                        this.removeFilterTag('source');
                        delete this.state.activeFilters.source;
                    });
                }
                
                // Days range
                const days = $('#days-range').val();
                const daysText = $('#days-range option:selected').text();
                if (days !== '1') {
                    this.state.activeFilters.days = { value: days, label: daysText };
                    this.addFilterTag('days', daysText, () => {
                        $('#days-range').val('1');
                        this.removeFilterTag('days');
                        delete this.state.activeFilters.days;
                    });
                }
                
                // Confidence threshold
                const confidence = parseInt($('#confidence-range').val());
                if (confidence > 0) {
                    this.state.activeFilters.confidence = { value: confidence, label: `Confidence ≥ ${confidence}%` };
                    this.addFilterTag('confidence', `Confidence ≥ ${confidence}%`, () => {
                        $('#confidence-range').val(0);
                        $('#confidence-min').text('0%');
                        this.removeFilterTag('confidence');
                        delete this.state.activeFilters.confidence;
                    });
                }
                
                // FRP threshold
                const frp = parseInt($('#frp-range').val());
                if (frp > 0) {
                    this.state.activeFilters.frp = { value: frp, label: `FRP ≥ ${frp} MW` };
                    this.addFilterTag('frp', `FRP ≥ ${frp} MW`, () => {
                        $('#frp-range').val(0);
                        $('#frp-min').text('0');
                        this.removeFilterTag('frp');
                        delete this.state.activeFilters.frp;
                    });
                }
            }
            
            // Add filter tag to UI
            addFilterTag(id, text, removeCallback) {
                const tag = $(`<span class="filter-tag" data-filter-id="${id}">${text} <span class="remove-filter">×</span></span>`);
                tag.find('.remove-filter').on('click', removeCallback);
                $('#active-filters').append(tag);
            }
            
            // Remove filter tag from UI
            removeFilterTag(id) {
                $(`.filter-tag[data-filter-id="${id}"]`).remove();
            }
            
            // Process fire data and update the map
            processFireData(data) {
                // Store the original full dataset
                this.state.allFireData = data;
                this.state.totalFirePoints = data.length;
                
                // Apply client-side filters (confidence, FRP)
                this.filterData();
                
                // Update the markers on the map
                this.updateMarkers();
            }
            
            // Apply client-side filters to the data
            filterData() {
                // Start with all data
                let filtered = [...this.state.allFireData];
                
                // Apply confidence filter if set
                if (this.state.activeFilters.confidence) {
                    const minConfidence = parseInt(this.state.activeFilters.confidence.value);
                    filtered = filtered.filter(point => {
                        const confidence = parseInt(point.confidence) || 0;
                        return confidence >= minConfidence;
                    });
                }
                
                // Apply FRP filter if set
                if (this.state.activeFilters.frp) {
                    const minFrp = parseInt(this.state.activeFilters.frp.value);
                    filtered = filtered.filter(point => {
                        const frp = parseFloat(point.frp) || 0;
                        return frp >= minFrp;
                    });
                }
                
                // Store filtered data
                this.state.filteredData = filtered;
                
                // Update pagination info
                this.updatePaginationInfo();
            }
            
            // Update the markers displayed on the map
            updateMarkers() {
                // Clear existing markers
                this.clearMarkers();
                
                // Reset page if needed
                if (this.state.currentPage > this.getTotalPages()) {
                    this.state.currentPage = 1;
                }
                
                // Update pagination display
                this.updatePaginationInfo();
                
                // If no data, exit
                if (this.state.filteredData.length === 0) {
                    this.showStatus('No fire data points match your filters.', 'warning');
                    return;
                }
                
                // Determine which slice of data to display
                let displayData;
                if (this.state.markersPerPage === Number.MAX_SAFE_INTEGER) {
                    // Show all data
                    displayData = this.state.filteredData;
                } else {
                    // Paginate data
                    const startIndex = (this.state.currentPage - 1) * this.state.markersPerPage;
                    const endIndex = startIndex + this.state.markersPerPage;
                    displayData = this.state.filteredData.slice(startIndex, endIndex);
                }
                
                // Create heatmap data
                const heatmapData = [];
                
                // Create markers for each fire point
                const markers = displayData.map(fire => {
                    // Skip if missing critical data
                    if (!fire.latitude || !fire.longitude) return null;
                    
                    // Parse coordinates
                    const lat = parseFloat(fire.latitude);
                    const lng = parseFloat(fire.longitude);
                    
                    if (isNaN(lat) || isNaN(lng)) return null;
                    
                    // Add to heatmap data
                    heatmapData.push({
                        location: new google.maps.LatLng(lat, lng),
                        weight: parseFloat(fire.frp) || 1
                    });
                    
                    // Create marker
                    const marker = new google.maps.Marker({
                        position: { lat, lng },
                        map: this.state.map,
                        icon: this.createFireIcon(fire),
                        title: `Fire at ${lat}, ${lng}`
                    });
                    
                    // Add click listener for info window
                    marker.addListener('click', () => {
                        this.showFireInfo(marker, fire);
                    });
                    
                    // Create hover effect
                    this.addMarkerHoverEffect(marker, fire);
                    
                    return marker;
                }).filter(marker => marker !== null);
                
                // Store markers
                this.state.markers = markers;
                
                // Create or update clusterer if enabled
                if ($('#enable-clustering').is(':checked')) {
                    this.setupMarkerClusterer();
                }
                
                // Create or update heatmap if enabled
                if ($('#show-heatmap').is(':checked')) {
                    this.setupHeatmap(heatmapData);
                }
                
                // Update status
                this.showStatus(`Showing ${markers.length} of ${this.state.filteredData.length} fire points`, 'success');
            }
            
            // Set up marker clusterer
            setupMarkerClusterer() {
                try {
                    // We preloaded the MarkerClusterer script in the head
                    if (typeof MarkerClusterer === 'undefined') {
                        console.error('MarkerClusterer is not defined. Skipping clustering');
                        return;
                    }
                    
                    console.log('Setting up marker clustering');
                    
                    // Clear previous clusterer if it exists
                    if (this.state.markerClusterer) {
                        this.state.markerClusterer.clearMarkers();
                    }
                    
                    // Create a simple renderer
                    const renderer = {
                        render: ({ count, position }) => {
                            return new google.maps.Marker({
                                position,
                                label: {
                                    text: String(count),
                                    color: "white",
                                    fontSize: "10px",
                                },
                                icon: {
                                    path: google.maps.SymbolPath.CIRCLE,
                                    fillColor: "#ff4500",
                                    fillOpacity: 0.7,
                                    strokeColor: "#ffffff",
                                    strokeWeight: 1,
                                    scale: Math.min(count / 5 + 10, 25),
                                },
                                zIndex: 1000,
                            });
                        }
                    };
                    
                    // Create new clusterer
                    this.state.markerClusterer = new MarkerClusterer({
                        map: this.state.map,
                        markers: this.state.markers,
                        renderer: renderer
                    });
                    
                    console.log('Marker clustering set up successfully');
                } catch (error) {
                    console.error('Error setting up marker clustering:', error);
                    // Continue without clustering
                }
            }
            
            // Set up heatmap layer
            setupHeatmap(heatmapData) {
                // Remove existing heatmap if any
                if (this.state.heatmap) {
                    this.state.heatmap.setMap(null);
                }
                
                // Create new heatmap
                this.state.heatmap = new google.maps.visualization.HeatmapLayer({
                    data: heatmapData,
                    map: this.state.map,
                    radius: 20,
                    opacity: 0.7,
                    gradient: [
                        'rgba(255, 255, 0, 0)',
                        'rgba(255, 255, 0, 1)',
                        'rgba(255, 204, 0, 1)',
                        'rgba(255, 153, 0, 1)',
                        'rgba(255, 102, 0, 1)',
                        'rgba(255, 51, 0, 1)',
                        'rgba(255, 0, 0, 1)'
                    ]
                });
            }
            
            // Toggle heatmap visibility
            toggleHeatmap(visible) {
                if (visible) {
                    // Create heatmap data
                    const heatmapData = this.state.filteredData.map(fire => {
                        return {
                            location: new google.maps.LatLng(parseFloat(fire.latitude), parseFloat(fire.longitude)),
                            weight: parseFloat(fire.frp) || 1
                        };
                    });
                    
                    this.setupHeatmap(heatmapData);
                } else if (this.state.heatmap) {
                    this.state.heatmap.setMap(null);
                    this.state.heatmap = null;
                }
            }
            
            // Clear all markers from the map
            clearMarkers() {
                // Remove markers from map
                this.state.markers.forEach(marker => marker.setMap(null));
                this.state.markers = [];
                
                // Clear clusterer if it exists
                if (this.state.markerClusterer) {
                    this.state.markerClusterer.clearMarkers();
                }
                
                // Clear heatmap if it exists
                if (this.state.heatmap) {
                    this.state.heatmap.setMap(null);
                }
                
                // Close any open info windows
                if (this.state.infoWindow) {
                    this.state.infoWindow.close();
                }
            }
            
            // Create fire icon based on confidence and intensity
            createFireIcon(fire) {
                // Parse data
                const confidence = parseInt(fire.confidence) || 50;
                const frp = parseFloat(fire.frp) || 10;
                
                // Get color based on confidence
                const color = this.getFireColor(confidence);
                
                // Get size based on FRP
                const size = this.getFireSize(frp);
                
                // Create icon
                return {
                    path: google.maps.SymbolPath.CIRCLE,
                    fillColor: color,
                    fillOpacity: 0.7,
                    strokeColor: '#FFFFFF',
                    strokeWeight: 1,
                    scale: size
                };
            }
            
            // Get color based on confidence level
            getFireColor(confidence) {
                if (confidence >= 80) return '#FF0000'; // High confidence = red
                if (confidence >= 60) return '#FF4500'; // Medium confidence = orange-red
                if (confidence >= 30) return '#FFA500'; // Low confidence = orange
                return '#FFCC00'; // Very low confidence = yellow
            }
            
            // Get size based on Fire Radiative Power
            getFireSize(frp) {
                if (frp > 50) return 14;
                if (frp > 20) return 12;
                if (frp > 10) return 10;
                return 8; // Default size
            }
            
            // Show fire information in info window
            showFireInfo(marker, fire) {
                // Format acquisition date and time if present
                let dateTimeInfo = '';
                if (fire.acq_date) {
                    dateTimeInfo += `<p><strong>Detection Date:</strong> ${fire.acq_date}</p>`;
                    
                    if (fire.acq_time) {
                        // Format time from HHMM to HH:MM
                        const timeStr = fire.acq_time.toString().padStart(4, '0');
                        const hours = timeStr.substring(0, 2);
                        const minutes = timeStr.substring(2, 4);
                        dateTimeInfo += `<p><strong>Detection Time:</strong> ${hours}:${minutes} UTC</p>`;
                    }
                }
                
                // Create info window content
                const content = `
                    <div style="padding: 8px; max-width: 300px;">
                        <h5 style="margin-top: 0; color: #333;">Fire Information</h5>
                        <p><strong>Location:</strong> ${fire.latitude}, ${fire.longitude}</p>
                        <p><strong>Confidence:</strong> ${fire.confidence || 'Unknown'}%</p>
                        <p><strong>Fire Power:</strong> ${fire.frp || 'Unknown'} MW</p>
                        ${dateTimeInfo}
                        <p style="margin-top: 8px; font-size: 12px; color: #666;">
                            <i class="fas fa-info-circle"></i> Data source: ${$('#data-source option:selected').text()}
                        </p>
                    </div>
                `;
                
                // Set and open the info window
                this.state.infoWindow.setContent(content);
                this.state.infoWindow.open(this.state.map, marker);
            }
            
            // Add hover effect to marker
            addMarkerHoverEffect(marker, fire) {
                const tooltip = document.getElementById('custom-tooltip');
                
                marker.addListener('mouseover', function(event) {
                    // Position tooltip near mouse cursor
                    const point = event.pixel;
                    tooltip.style.left = (point.x + 15) + 'px';
                    tooltip.style.top = (point.y - 15) + 'px';
                    
                    // Set tooltip content
                    tooltip.innerHTML = `
                        Confidence: ${fire.confidence || 'Unknown'}%<br>
                        Fire Power: ${fire.frp || 'Unknown'} MW
                    `;
                    
                    // Show tooltip
                    tooltip.style.display = 'block';
                });
                
                marker.addListener('mouseout', function() {
                    // Hide tooltip
                    tooltip.style.display = 'none';
                });
                
                marker.addListener('mousemove', function(event) {
                    // Move tooltip with cursor
                    const point = event.pixel;
                    tooltip.style.left = (point.x + 15) + 'px';
                    tooltip.style.top = (point.y - 15) + 'px';
                });
            }
            
            // Generate sample data if API is not available
            generateSampleData() {
                this.showStatus('Using sample data as fallback', 'warning');
                
                // Sample data centered around USA
                const center = this.config.defaultCenter;
                const sampleData = [];
                
                // Generate random points in the USA
                for (let i = 0; i < 50; i++) {
                    // Random offset from center
                    const latOffset = (Math.random() - 0.5) * 20;
                    const lngOffset = (Math.random() - 0.5) * 50;
                    
                    // Random values for properties
                    const confidence = Math.floor(Math.random() * 100);
                    const frp = Math.random() * 100;
                    
                    // Create sample fire point
                    sampleData.push({
                        latitude: center.lat + latOffset,
                        longitude: center.lng + lngOffset,
                        confidence: confidence,
                        frp: frp,
                        acq_date: '2025-05-09',
                        acq_time: '1200',
                    });
                }
                
                // Process the sample data
                this.processFireData(sampleData);
            }
            
            // Show loading overlay with message
            showLoading(message = 'Loading...') {
                document.getElementById('loading-overlay').style.display = 'flex';
                document.getElementById('loading-message').textContent = message;
            }
            
            // Hide loading overlay
            hideLoading() {
                document.getElementById('loading-overlay').style.display = 'none';
            }
            
            // Show region loading indicator
            showRegionLoading() {
                document.getElementById('region-loading').style.display = 'block';
            }
            
            // Hide region loading indicator
            hideRegionLoading() {
                document.getElementById('region-loading').style.display = 'none';
            }
            
            // Show loading data message
            showLoadingMessage(message) {
                const loadingMessage = document.getElementById('loading-data-message');
                loadingMessage.innerHTML = `<span class="loading-data-spinner"></span> ${message}`;
                loadingMessage.style.display = 'block';
            }
            
            // Hide loading data message
            hideLoadingMessage() {
                document.getElementById('loading-data-message').style.display = 'none';
            }
            
            // Show status message
            showStatus(message, type = 'info') {
                const statusPanel = document.getElementById('status-panel');
                statusPanel.textContent = message;
                
                // Remove all classes and add the appropriate one
                statusPanel.className = '';
                statusPanel.classList.add('status-panel');
                
                if ($('#sidebar').hasClass('collapsed')) {
                    statusPanel.classList.add('sidebar-collapsed');
                }
                
                // Add type-specific class
                switch (type) {
                    case 'success':
                        statusPanel.style.backgroundColor = '#d4edda';
                        statusPanel.style.color = '#155724';
                        break;
                    case 'error':
                        statusPanel.style.backgroundColor = '#f8d7da';
                        statusPanel.style.color = '#721c24';
                        break;
                    case 'warning':
                        statusPanel.style.backgroundColor = '#fff3cd';
                        statusPanel.style.color = '#856404';
                        break;
                    default:
                        statusPanel.style.backgroundColor = '#d1ecf1';
                        statusPanel.style.color = '#0c5460';
                }
                
                // Show the panel
                statusPanel.style.display = 'block';
                
                // Hide after delay except for errors
                if (type !== 'error') {
                    setTimeout(() => {
                        statusPanel.style.display = 'none';
                    }, 5000);
                }
            }
            
            // Update pagination information
            updatePaginationInfo() {
                const totalPages = this.getTotalPages();
                
                // Update page info text
                $('#current-page').text(this.state.currentPage);
                $('#total-pages').text(totalPages);
                
                // Enable/disable pagination buttons
                $('#prev-page').prop('disabled', this.state.currentPage <= 1);
                $('#next-page').prop('disabled', this.state.currentPage >= totalPages);
                
                // Update visibility of pagination controls
                if (totalPages <= 1) {
                    $('.pagination-container').hide();
                } else {
                    $('.pagination-container').show();
                }
            }
            
            // Calculate total pages
            getTotalPages() {
                return Math.ceil(this.state.filteredData.length / this.state.markersPerPage);
            }
            
            // Show fire statistics
            showStatistics() {
                if (this.state.filteredData.length === 0) {
                    this.showStatus('No data available for statistics', 'warning');
                    return;
                }
                
                // Show stats panel
                $('#stats-panel').show();
                
                // Calculate statistics
                const totalFires = this.state.filteredData.length;
                
                // Group by confidence level
                const confidenceLevels = {
                    high: 0,
                    medium: 0,
                    low: 0,
                    veryLow: 0
                };
                
                // Group by FRP
                const frpLevels = {
                    extreme: 0,
                    high: 0,
                    medium: 0,
                    low: 0
                };
                
                // Count dates
                const dateMap = new Map();
                
                // Process each fire point
                this.state.filteredData.forEach(fire => {
                    // Count by confidence
                    const confidence = parseInt(fire.confidence) || 0;
                    if (confidence >= 80) confidenceLevels.high++;
                    else if (confidence >= 60) confidenceLevels.medium++;
                    else if (confidence >= 30) confidenceLevels.low++;
                    else confidenceLevels.veryLow++;
                    
                    // Count by FRP
                    const frp = parseFloat(fire.frp) || 0;
                    if (frp > 50) frpLevels.extreme++;
                    else if (frp > 20) frpLevels.high++;
                    else if (frp > 10) frpLevels.medium++;
                    else frpLevels.low++;
                    
                    // Count by date
                    const date = fire.acq_date || 'Unknown';
                    if (dateMap.has(date)) {
                        dateMap.set(date, dateMap.get(date) + 1);
                    } else {
                        dateMap.set(date, 1);
                    }
                });
                
                // Sort dates and take top 5
                const sortedDates = [...dateMap.entries()].sort((a, b) => b[1] - a[1]).slice(0, 5);
                
                // Create stats HTML
                let statsHtml = `
                    <div class="mb-3">
                        <strong>Total Fire Points:</strong> ${totalFires}<br>
                        <strong>Data Source:</strong> ${$('#data-source option:selected').text()}<br>
                        <strong>Time Range:</strong> ${$('#days-range option:selected').text()}<br>
                        <strong>Region:</strong> ${this.state.viewMode === 'usa' ? 'USA' : 'Global'}
                    </div>
                    
                    <div class="mb-3">
                        <strong>Confidence Levels:</strong><br>
                        High (80-100%): ${confidenceLevels.high} (${Math.round(confidenceLevels.high/totalFires*100)}%)<br>
                        Medium (60-79%): ${confidenceLevels.medium} (${Math.round(confidenceLevels.medium/totalFires*100)}%)<br>
                        Low (30-59%): ${confidenceLevels.low} (${Math.round(confidenceLevels.low/totalFires*100)}%)<br>
                        Very Low (0-29%): ${confidenceLevels.veryLow} (${Math.round(confidenceLevels.veryLow/totalFires*100)}%)
                    </div>
                    
                    <div class="mb-3">
                        <strong>Fire Intensity (FRP):</strong><br>
                        Extreme (>50 MW): ${frpLevels.extreme} (${Math.round(frpLevels.extreme/totalFires*100)}%)<br>
                        High (20-50 MW): ${frpLevels.high} (${Math.round(frpLevels.high/totalFires*100)}%)<br>
                        Medium (10-20 MW): ${frpLevels.medium} (${Math.round(frpLevels.medium/totalFires*100)}%)<br>
                        Low (<10 MW): ${frpLevels.low} (${Math.round(frpLevels.low/totalFires*100)}%)
                    </div>
                `;
                
                // Add date breakdown if dates are available
                if (sortedDates.length > 0 && sortedDates[0][0] !== 'Unknown') {
                    statsHtml += `
                        <div>
                            <strong>Top Detection Dates:</strong><br>
                    `;
                    
                    sortedDates.forEach(([date, count]) => {
                        statsHtml += `${date}: ${count} fires (${Math.round(count/totalFires*100)}%)<br>`;
                    });
                    
                    statsHtml += `</div>`;
                }
                
                // Update stats content
                $('#stats-content').html(statsHtml);
            }
            
            // Fetch with retry logic
            async fetchWithRetry(url, retries = 0) {
                try {
                    console.log(`Fetch attempt ${retries + 1}/${this.config.maxFetchRetries + 1}: ${url}`);
                    
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Cache-Control': 'no-cache'
                        },
                        // Add timestamp to avoid caching
                        cache: 'no-cache'
                    });
                    
                    console.log(`Response status: ${response.status} ${response.statusText}`);
                    
                    return response;
                } catch (error) {
                    console.error(`Fetch error: ${error.message}`);
                    
                    if (retries < this.config.maxFetchRetries - 1) {
                        console.log(`Retrying... (${retries + 1}/${this.config.maxFetchRetries})`);
                        // Exponential backoff: 1s, 2s, 4s, etc.
                        await new Promise(r => setTimeout(r, 1000 * Math.pow(2, retries)));
                        return this.fetchWithRetry(url, retries + 1);
                    }
                    throw error;
                }
            }
        }
        
        // Initialize the application when the DOM is ready
        $(document).ready(function() {
            window.fireMap = new FireMap();
        });
    </script>
    
    <!-- Load Google Maps API with async/defer and appropriate callback -->
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD9MXRpmeXMKlezIOs3lPAjn0C5yLeTNUk&libraries=visualization,drawing">
    </script>
</body>
</html>
