<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Interactive Fire Map</title>
  
  <!-- External Dependencies -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
  
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      font-family: Arial, sans-serif;
    }
    
    #map {
      height: 100%;
      width: 100%;
    }
    
    .status-bar {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background-color: white;
      padding: 10px;
      border-radius: 4px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.4);
      z-index: 1000;
    }
    
    .error {
      color: #d9534f;
      font-weight: bold;
    }
    
    .loading {
      color: #5bc0de;
    }
    
    .success {
      color: #5cb85c;
    }
    
    .retry-button {
      background-color: #5bc0de;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 3px;
      cursor: pointer;
      margin-left: 10px;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="status" class="status-bar">Loading map...</div>

  <!-- Load libraries -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
  
  <script>
    // Main app
    document.addEventListener('DOMContentLoaded', function() {
      // Constants
      const API_URL = 'https://eyeonthefire.com/api/nasa/';
      const DEFAULT_CENTER = [36.0, -120.0];
      const DEFAULT_ZOOM = 5;
      
      // DOM elements
      const mapElement = document.getElementById('map');
      const statusElement = document.getElementById('status');
      
      // Initialize map
      const map = L.map('map').setView(DEFAULT_CENTER, DEFAULT_ZOOM);
      
      // Add base map layer
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors',
        maxZoom: 19
      }).addTo(map);
      
      // Initialize marker cluster group
      const markers = L.markerClusterGroup();
      map.addLayer(markers);
      
      // Set status
      function setStatus(message, type = 'loading') {
        statusElement.innerHTML = message;
        statusElement.className = 'status-bar ' + type;
      }
      
      // Add retry button to status
      function addRetryButton() {
        const button = document.createElement('button');
        button.innerText = 'Retry';
        button.className = 'retry-button';
        button.onclick = loadFireData;
        statusElement.appendChild(button);
      }
      
      // Parse CSV helper
      function parseCSV(text) {
        try {
          const lines = text.trim().split('\n');
          if (lines.length < 2) {
            console.warn('CSV has too few lines:', lines);
            return [];
          }
          
          const headers = lines[0].split(',').map(h => h.trim());
          
          return lines.slice(1).map(line => {
            const values = line.split(',');
            const item = {};
            
            headers.forEach((header, i) => {
              item[header] = values[i] ? values[i].trim() : '';
            });
            
            return item;
          });
        } catch (e) {
          console.error('CSV parse error:', e);
          return [];
        }
      }
      
      // Display fire data on map
      function displayFires(fires) {
        // Clear existing markers
        markers.clearLayers();
        
        if (!fires || fires.length === 0) {
          setStatus('No fire data available', 'warning');
          return;
        }
        
        // Track valid points for bounds
        const validPoints = [];
        
        // Add markers for each fire
        fires.forEach(fire => {
          // Extract coordinates - handle different possible property names
          const lat = parseFloat(fire.latitude || fire.lat || fire.LATITUDE || '');
          const lng = parseFloat(fire.longitude || fire.lon || fire.lng || fire.LONGITUDE || '');
          
          // Skip invalid coordinates
          if (isNaN(lat) || isNaN(lng)) {
            console.warn('Invalid coordinates:', fire);
            return;
          }
          
          // Create marker
          const marker = L.marker([lat, lng]);
          
          // Create popup content
          let popupContent = '<strong>Fire Alert</strong><br>';
          
          // Add any available data to popup
          Object.keys(fire).forEach(key => {
            if (fire[key] && key !== 'latitude' && key !== 'longitude' && 
                key !== 'lat' && key !== 'lng') {
              popupContent += `${key}: ${fire[key]}<br>`;
            }
          });
          
          marker.bindPopup(popupContent);
          markers.addLayer(marker);
          validPoints.push([lat, lng]);
        });
        
        // Fit map to bounds if we have points
        if (validPoints.length > 0) {
          map.fitBounds(validPoints);
          setStatus(`Showing ${validPoints.length} fire locations`, 'success');
        } else {
          setStatus('No valid fire locations found', 'warning');
        }
      }
      
      // Load fire data from API
      function loadFireData() {
        setStatus('Loading fire data...');
        
        fetch(API_URL)
          .then(response => {
            if (!response.ok) {
              throw new Error(`API returned status ${response.status}`);
            }
            return response.text();
          })
          .then(text => {
            // First try to parse as JSON
            try {
              const data = JSON.parse(text);
              return data;
            } catch (e) {
              // If not JSON, try CSV
              console.info('Not JSON, trying CSV format');
              return parseCSV(text);
            }
          })
          .then(data => {
            // Log data for debugging
            console.log('Parsed data:', data);
            
            // Display fire data
            displayFires(data);
          })
          .catch(error => {
            console.error('Error loading fire data:', error);
            setStatus(`Error: ${error.message}`, 'error');
            addRetryButton();
            
            // Add fallback data if available
            displayFires([
              { latitude: 37.7749, longitude: -122.4194, title: 'San Francisco' },
              { latitude: 34.0522, longitude: -118.2437, title: 'Los Angeles' }
            ]);
          });
      }
      
      // Start loading data
      loadFireData();
      
      // Add debug feature - click map to see coordinates
      map.on('click', function(e) {
        const coord = e.latlng;
        const lat = coord.lat.toFixed(6);
        const lng = coord.lng.toFixed(6);
        console.log(`Clicked at: ${lat}, ${lng}`);
        
        L.popup()
          .setLatLng(coord)
          .setContent(`<strong>Coordinates:</strong><br>${lat}, ${lng}`)
          .openOn(map);
      });
    });
  </script>
</body>
</html>
